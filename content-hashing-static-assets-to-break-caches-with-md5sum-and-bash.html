<!DOCTYPE html><html lang="en"><head><title>Content hashing static assets to break caches with md5sum and bash</title><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="Join me as I (over-)engineer implementing cache-busting for static assets on a simple website!"><meta name="author" content="Robert Pearce"><meta name="keywords" content="bash, md5, md5sum, content hashing, static assets, static site"><meta name="google-site-verification" content="QX4bn65yOXBfgnwxlO09yIBc1H8blur-Erx3lmsDVhU"><meta http-equiv="origin-trial" content="Am4BZ0c7GMyB72dgo/Ny2FfIFscXhYMoN+CVe4jduWh24FvsaCwf7kjZzHzfrJXtIilyZVAEKRxOItGLY7lvkAgAAABSeyJvcmlnaW4iOiJodHRwczovL3JvYmVydHdwZWFyY2UuY29tOjQ0MyIsImZlYXR1cmUiOiJQb3J0YWxzIiwiZXhwaXJ5IjoxNjAzNTQ2NDc3fQ=="><meta property="og:site_name" content="Robert Pearce"><meta property="og:title" content="Content hashing static assets to break caches with md5sum and bash"><meta property="og:url" content="https://robertwpearce.com/content-hashing-static-assets-to-break-caches-with-md5sum-and-bash.html"><meta property="og:description" content="Join me as I (over-)engineer implementing cache-busting for static assets on a simple website!"><meta property="og:type" content="article"><meta property="twitter:site" content="Robert Pearce"><meta property="twitter:title" content="Content hashing static assets to break caches with md5sum and bash"><meta property="twitter:description" content="Join me as I (over-)engineer implementing cache-busting for static assets on a simple website!"><meta property="twitter:creator" content="@RobertWPearce"><link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üíæ</text></svg>"><link rel="canonical" href="https://robertwpearce.com/content-hashing-static-assets-to-break-caches-with-md5sum-and-bash.html"><link rel="alternate" href="./atom.xml" title="Robert Pearce's blog" type="application/atom+xml"><link rel="alternate" href="./rss.xml" title="Robert Pearce's blog" type="application/rss+xml"><link rel="stylesheet" href="./css/base.css"><link rel="stylesheet" href="./css/t-clean.css"><link rel="stylesheet" href="./css/t-clean-note.css"><link rel="stylesheet" href="./css/t-code-dracula.css"><link rel="prefetch" href="./css/t-clean-note.css"></head><body data-theme="clean-night"><script> (() => { window.site = { prefFont: localStorage.getItem('prefFont') || 'monospace', setFont: (family) => { localStorage.setItem('prefFont', family); const rootStyle = document.querySelector(':root').style; rootStyle.setProperty('--type-family-body', family+',monospace'); /* Remove when https://github.com/googlefonts/spacemono/pull/2 is resolved */ if (family === 'Liga Space Mono') { rootStyle.setProperty('font-feature-settings', '"liga" 0'); } else { rootStyle.removeProperty('font-feature-settings'); } return window.site._fetchFont(family); }, prefTheme: localStorage.getItem('prefTheme') || (matchMedia('(prefers-color-scheme: dark)').matches ? 'clean-night' : 'clean-day'), setTheme: (name) => { const rootStyle = document.querySelector(':root').style; if (name === 'clean-night') { rootStyle.removeProperty('color-scheme'); } else { rootStyle.setProperty('color-scheme', 'light'); } document.body.setAttribute('data-theme', name); localStorage.setItem('prefTheme', name); }, _fetchFont: (family) => { if (family === 'monospace') { return Promise.resolve(); } const familyNoSpaces = family.replaceAll(' ', ''); const fontz = [ new FontFace(family, 'url("./fonts/'+familyNoSpaces+'-Regular.woff2") format("woff2")', { display: 'swap', weight: 400 }), new FontFace(family, 'url("./fonts/'+familyNoSpaces+'-Bold.woff2") format("woff2")', { display: 'swap', weight: 700 }), ]; if (family !== 'Fira Code') { fontz.push( new FontFace(family, 'url("./fonts/'+familyNoSpaces+'-Italic.woff2") format("woff2")', { display: 'swap', style: 'italic', weight: 400 }), new FontFace(family, 'url("./fonts/'+familyNoSpaces+'-BoldItalic.woff2") format("woff2")', { display: 'swap', style: 'italic', weight: 700 }) ); } for (const f of fontz) { document.fonts.add(f); } return Promise.allSettled(fontz).then(results => { results.forEach((res, i) => { if (res.status === 'rejected') { console.error('site failed to load font: ' + fontz[i]?.family ?? 'unknown'); } }); }); } }; window.site.setTheme(window.site.prefTheme); window.site.setFont(window.site.prefFont); })(); </script><header><nav><div class="nav-skip"><a href="#content">Skip to content</a></div><a aria-label="Home" class="nav-home" href="./">~</a><span>/</span></nav><div class="header-extra"><a href="./atom.xml">RSS</a><span aria-hidden="true">&compfn;</span><noscript>(requires JS &rarr;)</noscript><label for="select-theme">Theme</label><select data-select-theme id="select-theme"><option value="clean-day">Clean (Day)</option><option value="clean-night">Clean (Night)</option></select><span aria-hidden="true">&compfn;</span><label for="select-font">Font</label><select data-select-font id="select-font"><option value="monospace">monospace</option><option value="Liga Space Mono">Space Mono</option><option value="Victor Mono">Victor Mono</option><option value="Fira Code">Fira Code</option><option value="JetBrains Mono">JetBrains Mono</option></select></div></header><main id="content"><header data-area="heading"><h1>Content hashing static assets to break caches with md5sum and bash</h1></header><section data-area="meta"><h2>Info</h2><table data-type="cols-y"><tbody><tr><th>Summary</th><td>Join me as I (over-)engineer implementing cache-busting for static assets on a simple website!</td></tr><tr><th>Shared</th><td>2024-01-30</td></tr><tr><th>Revised</th><td>2024-01-31 @ 01:00 UTC</td></tr></tbody></table></section><section data-area="note"><h2 id="the-problem">The Problem</h2><p>When I make something for the web, I have plenty of ‚Äústatic assets‚Äù: CSS files, JS files, and images. In my HTML files, I reference their sources as you might expect:</p><pre class="pl-chroma"><code><span class="pl-line"><span class="pl-cl"><span class="pl-p">&lt;</span><span class="pl-nt">link</span> <span class="pl-na">rel</span><span class="pl-o">=</span><span class="pl-s">"stylesheet"</span> <span class="pl-na">href</span><span class="pl-o">=</span><span class="pl-s">"./styles.css"</span> <span class="pl-p">/&gt;</span>
</span></span><span class="pl-line"><span class="pl-cl"><span class="pl-p">&lt;</span><span class="pl-nt">script</span> <span class="pl-na">async</span> <span class="pl-na">src</span><span class="pl-o">=</span><span class="pl-s">"./scripts.js"</span><span class="pl-p">&gt;&lt;/</span><span class="pl-nt">script</span><span class="pl-p">&gt;</span>
</span></span><span class="pl-line"><span class="pl-cl"><span class="pl-p">&lt;</span><span class="pl-nt">img</span> <span class="pl-na">src</span><span class="pl-o">=</span><span class="pl-s">"./cool-image.avif"</span> <span class="pl-p">/&gt;</span></span></span></code></pre><p>But when a browser downloads these, it will note the source URLs and cache the static assets, typically for a time set by the server via headers like <code>Expires: &lt;some date&gt;</code> or <code>Cache-Control: public, max-age=15552000</code> (6 months). This is exactly what we want the browser to do, but what happens if I change the contents of the file?</p><p>Nothing! The last-cached content is served!</p><p>The browser caching is doing its job to help the user by not re-downloading the same content, but if we have updated static asset content, we need to give the browser a way to know that the content is different. Then it should go download and use that updated asset.</p><p>One option, if I‚Äôm using a CDN, is to manually purge the assets. There are also some additional headers, like <code>ETag</code> and <code>Last-Modified</code>, that can help hint to a browser that it can keep its cache or not for an asset, but if you don‚Äôt want to mess with request headers and/or want to guarantee the browser gets the latest version of an asset, you can provide a <em>different</em> file name for each version of an asset. Since the URL to the resource is different, the browser should always go and try to download it.</p><p>Yes, frameworks like <a href="https://rubyonrails.org">Ruby on Rails</a> and <a href="https://www.phoenixframework.org">Phoenix</a> will automatically do this sort of thing for you, but we‚Äôre exploring here and trying to keep things simple! (That will remain to be seen‚Ä¶ üòÖ)</p><p>Let‚Äôs talk about how we can DIY (do it yourself).</p><h2 id="what-our-assets-should-look-like-when-were-done">What our assets should look like when we‚Äôre done</h2><p>What we want to do is take a file like <code>styles.css</code>, get an <a href="https://en.wikipedia.org/wiki/MD5">MD5 fingerprint (checksum/digest/hash)</a> based on the file‚Äôs contents, and output something like <code>styles.78f7f2c2d416e59525938565dd6dd565.css</code>. This way, if <em>anything</em> in our file changes, we‚Äôll get a new hash and therefore a new file name.</p><p>Given we have these files:</p><pre class="pl-chroma"><code><span class="pl-line"><span class="pl-cl">index.html
</span></span><span class="pl-line"><span class="pl-cl">cool-image.avif
</span></span><span class="pl-line"><span class="pl-cl">scripts.js
</span></span><span class="pl-line"><span class="pl-cl">styles.css</span></span></code></pre><p>and our <code>index.html</code> file contains this:</p><pre class="pl-chroma"><code><span class="pl-line"><span class="pl-cl"><span class="pl-p">&lt;</span><span class="pl-nt">link</span> <span class="pl-na">rel</span><span class="pl-o">=</span><span class="pl-s">"stylesheet"</span> <span class="pl-na">href</span><span class="pl-o">=</span><span class="pl-s">"./styles.css"</span> <span class="pl-p">/&gt;</span>
</span></span><span class="pl-line"><span class="pl-cl"><span class="pl-p">&lt;</span><span class="pl-nt">script</span> <span class="pl-na">async</span> <span class="pl-na">src</span><span class="pl-o">=</span><span class="pl-s">"./scripts.js"</span><span class="pl-p">&gt;&lt;/</span><span class="pl-nt">script</span><span class="pl-p">&gt;</span>
</span></span><span class="pl-line"><span class="pl-cl"><span class="pl-p">&lt;</span><span class="pl-nt">img</span> <span class="pl-na">alt</span><span class="pl-o">=</span><span class="pl-s">""</span> <span class="pl-na">src</span><span class="pl-o">=</span><span class="pl-s">"./cool-image.avif"</span> <span class="pl-p">/&gt;</span></span></span></code></pre><p>then we should create a <code>dist/</code> directory with files that resemble these:</p><pre class="pl-chroma"><code><span class="pl-line"><span class="pl-cl">index.html
</span></span><span class="pl-line"><span class="pl-cl">cool-image.dadb0e162005e9b241a13ca5f871e250.avif
</span></span><span class="pl-line"><span class="pl-cl">scripts.9efef7ad3d06e7703c7563dbc1ed78a9.js
</span></span><span class="pl-line"><span class="pl-cl">styles.78f7f2c2d416e59525938565dd6dd565.css</span></span></code></pre><p>and our <code>index.html</code> file should have its assets‚Äô paths updated to resemble these:</p><pre class="pl-chroma"><code><span class="pl-line"><span class="pl-cl"><span class="pl-p">&lt;</span><span class="pl-nt">link</span> <span class="pl-na">rel</span><span class="pl-o">=</span><span class="pl-s">"stylesheet"</span> <span class="pl-na">href</span><span class="pl-o">=</span><span class="pl-s">"./styles.78f7f2c2d416e59525938565dd6dd565.css"</span> <span class="pl-p">/&gt;</span>
</span></span><span class="pl-line"><span class="pl-cl"><span class="pl-p">&lt;</span><span class="pl-nt">script</span> <span class="pl-na">async</span> <span class="pl-na">src</span><span class="pl-o">=</span><span class="pl-s">"./scripts.9efef7ad3d06e7703c7563dbc1ed78a9.js"</span><span class="pl-p">&gt;&lt;/</span><span class="pl-nt">script</span><span class="pl-p">&gt;</span>
</span></span><span class="pl-line"><span class="pl-cl"><span class="pl-p">&lt;</span><span class="pl-nt">img</span> <span class="pl-na">src</span><span class="pl-o">=</span><span class="pl-s">"./cool-image.dadb0e162005e9b241a13ca5f871e250.avif"</span> <span class="pl-p">/&gt;</span></span></span></code></pre><h2 id="using-md5sum-to-get-file-content-hashes">Using md5sum to get file content hashes</h2><p>If you haven‚Äôt used <code>md5sum</code> before, go ahead and run <code>man md5sum</code> in your terminal. There are some neat things you can use this for, like storing a list of file checksums in a file, then detecting which files changed, having your build system make decisions based on that, and avoiding costly project rebuilds by only rebuilding files or directories and their dependencies that changed. But we only need the top-level, most basic thing from <code>md5sum</code>: computing an MD5 message digest.</p><p>Let‚Äôs say this is what our project folder looks like:</p><pre class="pl-chroma"><code><span class="pl-line"><span class="pl-cl">Œª tree -a -L 1
</span></span><span class="pl-line"><span class="pl-cl">.
</span></span><span class="pl-line"><span class="pl-cl">‚îú‚îÄ‚îÄ .git
</span></span><span class="pl-line"><span class="pl-cl">‚îú‚îÄ‚îÄ .gitignore
</span></span><span class="pl-line"><span class="pl-cl">‚îú‚îÄ‚îÄ cool-image.avif
</span></span><span class="pl-line"><span class="pl-cl">‚îú‚îÄ‚îÄ dist
</span></span><span class="pl-line"><span class="pl-cl">‚îú‚îÄ‚îÄ index.html
</span></span><span class="pl-line"><span class="pl-cl">‚îú‚îÄ‚îÄ scripts.js
</span></span><span class="pl-line"><span class="pl-cl">‚îî‚îÄ‚îÄ styles.css</span></span></code></pre><p>If I want to get an MD5 content hash for <code>styles.css</code>, I pass the filename to <code>md5sm</code>:</p><pre class="pl-chroma"><code><span class="pl-line"><span class="pl-cl">Œª md5sum styles.css
</span></span><span class="pl-line"><span class="pl-cl">e6dd05b39c5fb97218130638c0a374de  styles.css</span></span></code></pre><p>Sweet! If we want to query by a bunch of different file extensions, <code>md5sum</code> can handle that:</p><pre class="pl-chroma"><code><span class="pl-line"><span class="pl-cl">Œª md5sum *.{avif,css,js}
</span></span><span class="pl-line"><span class="pl-cl">dadb0e162005e9b241a13ca5f871e250  cool-image.avif
</span></span><span class="pl-line"><span class="pl-cl">e6dd05b39c5fb97218130638c0a374de  styles.css
</span></span><span class="pl-line"><span class="pl-cl">78f7f2c2d416e59525938565dd6dd565  bingo.js</span></span></code></pre><p>But if we want <code>md5sum</code> to ignore certain directories, find a bunch of different file types, and maybe do so a bit more efficiently, we can lean on the <code>find</code> tool. Run <code>man find</code> if you‚Äôre unfamiliar with it or can‚Äôt remember its syntax!</p><p>Let‚Äôs run it with some options and then break down what we did:</p><pre class="pl-chroma"><code><span class="pl-line"><span class="pl-cl">Œª find . \
</span></span><span class="pl-line"><span class="pl-cl">  -type f \
</span></span><span class="pl-line"><span class="pl-cl">  ! -path "./.git/*" \
</span></span><span class="pl-line"><span class="pl-cl">  ! -path "./dist/*" \
</span></span><span class="pl-line"><span class="pl-cl">  \( -iname "*.css" -o \
</span></span><span class="pl-line"><span class="pl-cl">     -iname "*.js" -o \
</span></span><span class="pl-line"><span class="pl-cl">     -iname "*.avif" -o \
</span></span><span class="pl-line"><span class="pl-cl">     -iname "*.bmp" -o \
</span></span><span class="pl-line"><span class="pl-cl">     -iname "*.gif" -o \
</span></span><span class="pl-line"><span class="pl-cl">     -iname "*.heif" -o \
</span></span><span class="pl-line"><span class="pl-cl">     -iname "*.jpeg" -o \
</span></span><span class="pl-line"><span class="pl-cl">     -iname "*.jpg" -o \
</span></span><span class="pl-line"><span class="pl-cl">     -iname "*.png" -o \
</span></span><span class="pl-line"><span class="pl-cl">     -iname "*.svg" -o \
</span></span><span class="pl-line"><span class="pl-cl">     -iname "*.webp" \
</span></span><span class="pl-line"><span class="pl-cl">  \) \
</span></span><span class="pl-line"><span class="pl-cl">  -exec md5sum '{}' +
</span></span><span class="pl-line"><span class="pl-cl">
</span></span><span class="pl-line"><span class="pl-cl">e6dd05b39c5fb97218130638c0a374de  ./styles.css
</span></span><span class="pl-line"><span class="pl-cl">dadb0e162005e9b241a13ca5f871e250  ./cool-image.avif
</span></span><span class="pl-line"><span class="pl-cl">78f7f2c2d416e59525938565dd6dd565  ./bingo.js</span></span></code></pre><p>Above, we told the find command to find all files in this directory, excluding the <code>.git/</code> and <code>dist/</code> directories, where the file extension ends in one of a handful of extensions of likely static assets, and then we tell it to execute <code>md5sum</code> on each one. At the bottom, we see the results!</p><p>Next, we want to take that MD5 hash on the left and output a new file where the filename has the hash just before the extension. For that, we‚Äôre going to want to start putting this into a <code>build</code> script.</p><h2 id="starting-our-build-script">Starting our build script</h2><p>In your terminal, run the following commands to create a build file with some scaffolding, then change it to an executable file (don‚Äôt copy the Œª):</p><pre class="pl-chroma"><code><span class="pl-line"><span class="pl-cl">Œª cat &lt;&lt;EOF &gt; ./build
</span></span><span class="pl-line"><span class="pl-cl">#!/usr/bin/env bash
</span></span><span class="pl-line"><span class="pl-cl">
</span></span><span class="pl-line"><span class="pl-cl">set -o errexit
</span></span><span class="pl-line"><span class="pl-cl">set -o errtrace
</span></span><span class="pl-line"><span class="pl-cl">set -o nounset
</span></span><span class="pl-line"><span class="pl-cl">set -eou pipefail
</span></span><span class="pl-line"><span class="pl-cl">
</span></span><span class="pl-line"><span class="pl-cl">function main {
</span></span><span class="pl-line"><span class="pl-cl">}
</span></span><span class="pl-line"><span class="pl-cl">
</span></span><span class="pl-line"><span class="pl-cl">main
</span></span><span class="pl-line"><span class="pl-cl">EOF
</span></span><span class="pl-line"><span class="pl-cl">
</span></span><span class="pl-line"><span class="pl-cl">Œª chmod +x ./build</span></span></code></pre><p>Once you‚Äôve done that open the file, and let‚Äôs add our find function in there:</p><pre class="pl-chroma"><code><span class="pl-line"><span class="pl-cl"><span class="pl-c1"># ...</span>
</span></span><span class="pl-line"><span class="pl-cl">
</span></span><span class="pl-line"><span class="pl-cl"><span class="pl-nv">BUILD_DIR</span><span class="pl-o">=</span><span class="pl-s2">"./dist"</span>
</span></span><span class="pl-line"><span class="pl-cl">
</span></span><span class="pl-line"><span class="pl-cl"><span class="pl-k">function</span> get_asset_md5sums <span class="pl-o">{</span>
</span></span><span class="pl-line"><span class="pl-cl">  find . <span class="pl-se">\
</span></span></span><span class="pl-line"><span class="pl-cl"><span class="pl-se"></span>    -type f <span class="pl-se">\
</span></span></span><span class="pl-line"><span class="pl-cl"><span class="pl-se"></span>    ! -path <span class="pl-s2">"./.git/*"</span> <span class="pl-se">\
</span></span></span><span class="pl-line"><span class="pl-cl"><span class="pl-se"></span>    ! -path <span class="pl-s2">"</span><span class="pl-si">${</span><span class="pl-nv">BUILD_DIR</span><span class="pl-si">}</span><span class="pl-s2">/*"</span> <span class="pl-se">\
</span></span></span><span class="pl-line"><span class="pl-cl"><span class="pl-se"></span>    <span class="pl-se">\(</span> -iname <span class="pl-s2">"*.css"</span> -o <span class="pl-se">\
</span></span></span><span class="pl-line"><span class="pl-cl"><span class="pl-se"></span>       -iname <span class="pl-s2">"*.js"</span> -o <span class="pl-se">\
</span></span></span><span class="pl-line"><span class="pl-cl"><span class="pl-se"></span>       -iname <span class="pl-s2">"*.avif"</span> -o <span class="pl-se">\
</span></span></span><span class="pl-line"><span class="pl-cl"><span class="pl-se"></span>       -iname <span class="pl-s2">"*.bmp"</span> -o <span class="pl-se">\
</span></span></span><span class="pl-line"><span class="pl-cl"><span class="pl-se"></span>       -iname <span class="pl-s2">"*.gif"</span> -o <span class="pl-se">\
</span></span></span><span class="pl-line"><span class="pl-cl"><span class="pl-se"></span>       -iname <span class="pl-s2">"*.heif"</span> -o <span class="pl-se">\
</span></span></span><span class="pl-line"><span class="pl-cl"><span class="pl-se"></span>       -iname <span class="pl-s2">"*.jpeg"</span> -o <span class="pl-se">\
</span></span></span><span class="pl-line"><span class="pl-cl"><span class="pl-se"></span>       -iname <span class="pl-s2">"*.jpg"</span> -o <span class="pl-se">\
</span></span></span><span class="pl-line"><span class="pl-cl"><span class="pl-se"></span>       -iname <span class="pl-s2">"*.png"</span> -o <span class="pl-se">\
</span></span></span><span class="pl-line"><span class="pl-cl"><span class="pl-se"></span>       -iname <span class="pl-s2">"*.svg"</span> -o <span class="pl-se">\
</span></span></span><span class="pl-line"><span class="pl-cl"><span class="pl-se"></span>       -iname <span class="pl-s2">"*.webp"</span> <span class="pl-se">\
</span></span></span><span class="pl-line"><span class="pl-cl"><span class="pl-se"></span>    <span class="pl-se">\)</span> <span class="pl-se">\
</span></span></span><span class="pl-line"><span class="pl-cl"><span class="pl-se"></span>    -exec md5sum <span class="pl-s1">'{}'</span> +
</span></span><span class="pl-line"><span class="pl-cl"><span class="pl-o">}</span>
</span></span><span class="pl-line"><span class="pl-cl">
</span></span><span class="pl-line"><span class="pl-cl"><span class="pl-k">function</span> main <span class="pl-o">{</span>
</span></span><span class="pl-line"><span class="pl-cl">  get_asset_md5sums
</span></span><span class="pl-line"><span class="pl-cl"><span class="pl-o">}</span></span></span></code></pre><p>If you then run that file via <code>./build</code>, you‚Äôll get back the same results as before.</p><h2 id="outputting-hashed-static-asset-file-names">Outputting hashed static asset file names</h2><p>Update your <code>main</code> function with the following. We‚Äôll use code comments to explain most of this part:</p><pre class="pl-chroma"><code><span class="pl-line"><span class="pl-cl"><span class="pl-k">function</span> main <span class="pl-o">{</span>
</span></span><span class="pl-line"><span class="pl-cl">  <span class="pl-c1"># Recreate build dir</span>
</span></span><span class="pl-line"><span class="pl-cl">  rm -rf <span class="pl-s2">"</span><span class="pl-si">${</span><span class="pl-nv">BUILD_DIR</span><span class="pl-si">}</span><span class="pl-s2">"</span> <span class="pl-o">&amp;&amp;</span> mkdir -p <span class="pl-s2">"</span><span class="pl-si">${</span><span class="pl-nv">BUILD_DIR</span><span class="pl-si">}</span><span class="pl-s2">"</span>
</span></span><span class="pl-line"><span class="pl-cl">
</span></span><span class="pl-line"><span class="pl-cl">  <span class="pl-c1"># Create a bash array for holding # "file=file_with_sum"</span>
</span></span><span class="pl-line"><span class="pl-cl">  <span class="pl-c1"># pairs for use later. Yes, I know bash 4 has associative arrays.</span>
</span></span><span class="pl-line"><span class="pl-cl">  <span class="pl-c1"># E.g.: "styles.css=styles.78f7f2c2d416e59525938565dd6dd565.css"</span>
</span></span><span class="pl-line"><span class="pl-cl">  <span class="pl-nv">assets_array</span><span class="pl-o">=()</span>
</span></span><span class="pl-line"><span class="pl-cl">
</span></span><span class="pl-line"><span class="pl-cl">  <span class="pl-c1"># Get all asset MD5 checksums, put them into an assets</span>
</span></span><span class="pl-line"><span class="pl-cl">  <span class="pl-c1"># array for later use, and write each file to a new</span>
</span></span><span class="pl-line"><span class="pl-cl">  <span class="pl-c1"># file with the checksum in the name.</span>
</span></span><span class="pl-line"><span class="pl-cl">  <span class="pl-k">while</span> <span class="pl-nb">read</span> -r sum file<span class="pl-p">;</span> <span class="pl-k">do</span>
</span></span><span class="pl-line"><span class="pl-cl">    <span class="pl-nv">file_name</span><span class="pl-o">=</span><span class="pl-s2">"</span><span class="pl-si">${</span><span class="pl-nv">file</span><span class="pl-p">%.*</span><span class="pl-si">}</span><span class="pl-s2">"</span> <span class="pl-c1"># Extract the file's name</span>
</span></span><span class="pl-line"><span class="pl-cl">    <span class="pl-nv">file_ext</span><span class="pl-o">=</span><span class="pl-s2">"</span><span class="pl-si">${</span><span class="pl-nv">file</span><span class="pl-p">##*.</span><span class="pl-si">}</span><span class="pl-s2">"</span> <span class="pl-c1"># Extract the file's extension</span>
</span></span><span class="pl-line"><span class="pl-cl">    <span class="pl-nv">file_with_sum</span><span class="pl-o">=</span><span class="pl-s2">"</span><span class="pl-si">${</span><span class="pl-nv">file_name</span><span class="pl-si">}</span><span class="pl-s2">.</span><span class="pl-si">${</span><span class="pl-nv">sum</span><span class="pl-si">}</span><span class="pl-s2">.</span><span class="pl-si">${</span><span class="pl-nv">file_ext</span><span class="pl-si">}</span><span class="pl-s2">"</span> <span class="pl-c1"># Hashed file name</span>
</span></span><span class="pl-line"><span class="pl-cl">
</span></span><span class="pl-line"><span class="pl-cl">    <span class="pl-c1"># Append to the assets array</span>
</span></span><span class="pl-line"><span class="pl-cl">    <span class="pl-nv">assets_array</span><span class="pl-o">+=(</span> <span class="pl-s2">"</span><span class="pl-si">${</span><span class="pl-nv">file</span><span class="pl-si">}</span><span class="pl-s2">=</span><span class="pl-si">${</span><span class="pl-nv">file_with_sum</span><span class="pl-si">}</span><span class="pl-s2">"</span> <span class="pl-o">)</span>
</span></span><span class="pl-line"><span class="pl-cl">
</span></span><span class="pl-line"><span class="pl-cl">    <span class="pl-c1"># Write the file's contents to the build directory</span>
</span></span><span class="pl-line"><span class="pl-cl">    <span class="pl-c1"># at the new, hashed file name.</span>
</span></span><span class="pl-line"><span class="pl-cl">    cat <span class="pl-s2">"</span><span class="pl-si">${</span><span class="pl-nv">file</span><span class="pl-si">}</span><span class="pl-s2">"</span> &gt; <span class="pl-s2">"</span><span class="pl-si">${</span><span class="pl-nv">BUILD_DIR</span><span class="pl-si">}</span><span class="pl-s2">/</span><span class="pl-si">${</span><span class="pl-nv">file_with_sum</span><span class="pl-si">}</span><span class="pl-s2">"</span>
</span></span><span class="pl-line"><span class="pl-cl">  <span class="pl-k">done</span> &lt; &lt;<span class="pl-o">(</span>get_asset_md5sums<span class="pl-o">)</span>
</span></span><span class="pl-line"><span class="pl-cl"><span class="pl-o">}</span></span></span></code></pre><p>If you‚Äôre wondering about the <code>&lt;(get_asset_md5sums)</code> part, it uses <a href="https://www.gnu.org/software/bash/manual/bash.html#Process-Substitution">process substitution</a> to let us have access to the <code>assets_array</code> variable, which we wouldn‚Äôt have access to if we piped <code>get_asset_md5sums</code> to <code>while read ...</code>, for the <code>while</code> loop would be ran in a <a href="https://www.gnu.org/software/bash/manual/html_node/Command-Execution-Environment.html">subshell environment</a>. Instead, with process substitution, the result of that function is stored in a named pipe/special temporary file (in <code>/dev/fd/</code> on my system), the file name is passed, and then its contents are read and attached to the standard input by the <code>&lt;</code> input file descriptor. To sum this aside up, if we did <code>get_asset_md5sums | while read...</code>, we‚Äôd get an <code>assets_array[@]: unbound variable</code> error, so we‚Äôre using process substitution to get around that.</p><p>If you run <code>./build</code> again, you won‚Äôt see any terminal output, but you will see a shiny new <code>./dist</code> folder with your files in it!</p><p>The next part is a little more involved, for we need to create new HTML files that have updated values for asset source locations.</p><h2 id="including-the-hashed-file-names-in-our-html-files">Including the hashed file names in our HTML file(s)</h2><p>Before we can copy, update, and output our HTML files (of which we only have one in this example), we first need a way to find them! Add this below your <code>get_asset_md5sums</code> function:</p><pre class="pl-chroma"><code><span class="pl-line"><span class="pl-cl"><span class="pl-k">function</span> get_html_files <span class="pl-o">{</span>
</span></span><span class="pl-line"><span class="pl-cl">  find . <span class="pl-se">\
</span></span></span><span class="pl-line"><span class="pl-cl"><span class="pl-se"></span>    -type f <span class="pl-se">\
</span></span></span><span class="pl-line"><span class="pl-cl"><span class="pl-se"></span>    ! -path <span class="pl-s2">"./.git/*"</span> <span class="pl-se">\
</span></span></span><span class="pl-line"><span class="pl-cl"><span class="pl-se"></span>    ! -path <span class="pl-s2">"</span><span class="pl-si">${</span><span class="pl-nv">BUILD_DIR</span><span class="pl-si">}</span><span class="pl-s2">/*"</span> <span class="pl-se">\
</span></span></span><span class="pl-line"><span class="pl-cl"><span class="pl-se"></span>    -iname <span class="pl-s2">"*.html"</span>
</span></span><span class="pl-line"><span class="pl-cl"><span class="pl-o">}</span></span></span></code></pre><p>Next, at the bottom of your <code>main</code> function, add this code, and we‚Äôll use comments to try to explain each piece in context:</p><pre class="pl-chroma"><code><span class="pl-line"><span class="pl-cl"><span class="pl-c1"># For each HTML file...</span>
</span></span><span class="pl-line"><span class="pl-cl"><span class="pl-k">while</span> <span class="pl-nb">read</span> -r file<span class="pl-p">;</span> <span class="pl-k">do</span>
</span></span><span class="pl-line"><span class="pl-cl">  <span class="pl-c1"># For each line in the current HTML file...</span>
</span></span><span class="pl-line"><span class="pl-cl">  <span class="pl-k">while</span> <span class="pl-nv">IFS</span><span class="pl-o">=</span><span class="pl-s1">''</span> <span class="pl-nb">read</span> -r line<span class="pl-p">;</span> <span class="pl-k">do</span>
</span></span><span class="pl-line"><span class="pl-cl">    <span class="pl-nv">line_updated</span><span class="pl-o">=</span><span class="pl-s2">"</span><span class="pl-si">${</span><span class="pl-nv">line</span><span class="pl-si">}</span><span class="pl-s2">"</span>
</span></span><span class="pl-line"><span class="pl-cl">
</span></span><span class="pl-line"><span class="pl-cl">    <span class="pl-c1"># For each "file=file_with_sum" pairing...</span>
</span></span><span class="pl-line"><span class="pl-cl">    <span class="pl-k">for</span> val in <span class="pl-s2">"</span><span class="pl-si">${</span><span class="pl-nv">assets_array</span><span class="pl-p">[@]</span><span class="pl-si">}</span><span class="pl-s2">"</span><span class="pl-p">;</span> <span class="pl-k">do</span>
</span></span><span class="pl-line"><span class="pl-cl">      <span class="pl-nv">file_name_original</span><span class="pl-o">=</span><span class="pl-k">$(</span><span class="pl-nb">echo</span> <span class="pl-s2">"</span><span class="pl-si">${</span><span class="pl-nv">val</span><span class="pl-si">}</span><span class="pl-s2">"</span> <span class="pl-p">|</span> cut -d <span class="pl-s2">"="</span> -f 1<span class="pl-k">)</span>
</span></span><span class="pl-line"><span class="pl-cl">      <span class="pl-nv">file_name_summed</span><span class="pl-o">=</span><span class="pl-k">$(</span><span class="pl-nb">echo</span> <span class="pl-s2">"</span><span class="pl-si">${</span><span class="pl-nv">val</span><span class="pl-si">}</span><span class="pl-s2">"</span> <span class="pl-p">|</span> cut -d <span class="pl-s2">"="</span> -f 2<span class="pl-k">)</span>
</span></span><span class="pl-line"><span class="pl-cl">
</span></span><span class="pl-line"><span class="pl-cl">      <span class="pl-c1"># If the current line has the original file name...</span>
</span></span><span class="pl-line"><span class="pl-cl">      <span class="pl-k">if</span> <span class="pl-o">[[</span> <span class="pl-s2">"</span><span class="pl-si">${</span><span class="pl-nv">line</span><span class="pl-si">}</span><span class="pl-s2">"</span> <span class="pl-o">=</span>~ <span class="pl-si">${</span><span class="pl-nv">file_name_original</span><span class="pl-si">}</span> <span class="pl-o">]]</span><span class="pl-p">;</span> <span class="pl-k">then</span>
</span></span><span class="pl-line"><span class="pl-cl">        <span class="pl-c1"># ...then replace that file name with the hashed one</span>
</span></span><span class="pl-line"><span class="pl-cl">        <span class="pl-nv">line_updated</span><span class="pl-o">=</span><span class="pl-k">$(</span><span class="pl-nb">echo</span> <span class="pl-s2">"</span><span class="pl-si">${</span><span class="pl-nv">line</span><span class="pl-si">}</span><span class="pl-s2">"</span> <span class="pl-p">|</span> sed -E <span class="pl-s1">'s@'</span><span class="pl-s2">"</span><span class="pl-si">${</span><span class="pl-nv">file_name_original</span><span class="pl-si">}</span><span class="pl-s2">"</span><span class="pl-s1">'@'</span><span class="pl-s2">"</span><span class="pl-si">${</span><span class="pl-nv">file_name_summed</span><span class="pl-si">}</span><span class="pl-s2">"</span><span class="pl-s1">'@g'</span><span class="pl-k">)</span>
</span></span><span class="pl-line"><span class="pl-cl">        <span class="pl-nb">break</span>
</span></span><span class="pl-line"><span class="pl-cl">      <span class="pl-k">fi</span>
</span></span><span class="pl-line"><span class="pl-cl">    <span class="pl-k">done</span>
</span></span><span class="pl-line"><span class="pl-cl">
</span></span><span class="pl-line"><span class="pl-cl">    <span class="pl-c1"># Print the line</span>
</span></span><span class="pl-line"><span class="pl-cl">    <span class="pl-nb">echo</span> <span class="pl-s2">"</span><span class="pl-si">${</span><span class="pl-nv">line_updated</span><span class="pl-si">}</span><span class="pl-s2">"</span>
</span></span><span class="pl-line"><span class="pl-cl">
</span></span><span class="pl-line"><span class="pl-cl">  <span class="pl-c1"># Pass the file in, then once done, redirect the</span>
</span></span><span class="pl-line"><span class="pl-cl">  <span class="pl-c1"># printed file lines to a new file in our build dir</span>
</span></span><span class="pl-line"><span class="pl-cl">  <span class="pl-k">done</span> &lt; <span class="pl-s2">"</span><span class="pl-si">${</span><span class="pl-nv">file</span><span class="pl-si">}</span><span class="pl-s2">"</span> &gt; <span class="pl-s2">"</span><span class="pl-si">${</span><span class="pl-nv">BUILD_DIR</span><span class="pl-si">}</span><span class="pl-s2">/</span><span class="pl-si">${</span><span class="pl-nv">file</span><span class="pl-si">}</span><span class="pl-s2">"</span>
</span></span><span class="pl-line"><span class="pl-cl">
</span></span><span class="pl-line"><span class="pl-cl"><span class="pl-c1"># Pass the HTML files in via process substitution</span>
</span></span><span class="pl-line"><span class="pl-cl"><span class="pl-k">done</span> &lt; &lt;<span class="pl-o">(</span>get_html_files<span class="pl-o">)</span></span></span></code></pre><p>Once this code runs, your HTML files should be copied over to your <code>dist/</code> directory, but the lines referencing your static assets should all be updated!</p><p><em>This runs fast enough for my purposes, but if you have any performance tips or explanation corrections, please email me.</em></p><h2 id="building-with-github-actions-and-deploying-to-github-pages">Building with GitHub Actions and deploying to GitHub Pages</h2><p>Once you‚Äôve got this building, you <em>could</em> build it locally and push the <code>dist/</code> folder up to your source control, but I want <code>./build</code> to run automatically, and since I primarily use GitHub, I just want to deploy the <code>dist/</code> directory to GitHub Pages.</p><p>To make this a reality, we can use Github Actions to deploy to GitHub Pages. Create a <code>.github/workflows/main.yml</code> (the YAML file name can be whatever you like) and add the following:</p><pre class="pl-chroma"><code><span class="pl-line"><span class="pl-cl"><span class="pl-nt">name</span><span class="pl-p">:</span><span class="pl-w"> </span><span class="pl-l">CI</span><span class="pl-w">
</span></span></span><span class="pl-line"><span class="pl-cl"><span class="pl-w">
</span></span></span><span class="pl-line"><span class="pl-cl"><span class="pl-w"></span><span class="pl-nt">on</span><span class="pl-p">:</span><span class="pl-w">
</span></span></span><span class="pl-line"><span class="pl-cl"><span class="pl-w">  </span><span class="pl-nt">pull_request</span><span class="pl-p">:</span><span class="pl-w">
</span></span></span><span class="pl-line"><span class="pl-cl"><span class="pl-w">  </span><span class="pl-nt">push</span><span class="pl-p">:</span><span class="pl-w">
</span></span></span><span class="pl-line"><span class="pl-cl"><span class="pl-w">
</span></span></span><span class="pl-line"><span class="pl-cl"><span class="pl-w"></span><span class="pl-nt">jobs</span><span class="pl-p">:</span><span class="pl-w">
</span></span></span><span class="pl-line"><span class="pl-cl"><span class="pl-w">  </span><span class="pl-nt">build</span><span class="pl-p">:</span><span class="pl-w">
</span></span></span><span class="pl-line"><span class="pl-cl"><span class="pl-w">    </span><span class="pl-nt">runs-on</span><span class="pl-p">:</span><span class="pl-w"> </span><span class="pl-l">ubuntu-latest</span><span class="pl-w">
</span></span></span><span class="pl-line"><span class="pl-cl"><span class="pl-w">    </span><span class="pl-nt">permissions</span><span class="pl-p">:</span><span class="pl-w">
</span></span></span><span class="pl-line"><span class="pl-cl"><span class="pl-w">      </span><span class="pl-nt">contents</span><span class="pl-p">:</span><span class="pl-w"> </span><span class="pl-l">write</span><span class="pl-w">
</span></span></span><span class="pl-line"><span class="pl-cl"><span class="pl-w">    </span><span class="pl-nt">steps</span><span class="pl-p">:</span><span class="pl-w">
</span></span></span><span class="pl-line"><span class="pl-cl"><span class="pl-w">      </span>- <span class="pl-nt">name</span><span class="pl-p">:</span><span class="pl-w"> </span><span class="pl-l">Checkout repo under GH workspace</span><span class="pl-w">
</span></span></span><span class="pl-line"><span class="pl-cl"><span class="pl-w">        </span><span class="pl-nt">uses</span><span class="pl-p">:</span><span class="pl-w"> </span><span class="pl-l">actions/checkout@v4</span><span class="pl-w">
</span></span></span><span class="pl-line"><span class="pl-cl"><span class="pl-w">
</span></span></span><span class="pl-line"><span class="pl-cl"><span class="pl-w">      </span>- <span class="pl-nt">name</span><span class="pl-p">:</span><span class="pl-w"> </span><span class="pl-l">Run build script</span><span class="pl-w">
</span></span></span><span class="pl-line"><span class="pl-cl"><span class="pl-w">        </span><span class="pl-nt">run</span><span class="pl-p">:</span><span class="pl-w"> </span><span class="pl-l">./build</span><span class="pl-w">
</span></span></span><span class="pl-line"><span class="pl-cl"><span class="pl-w">
</span></span></span><span class="pl-line"><span class="pl-cl"><span class="pl-w">      </span>- <span class="pl-nt">name</span><span class="pl-p">:</span><span class="pl-w"> </span><span class="pl-l">Deploy to gh-pages</span><span class="pl-w">
</span></span></span><span class="pl-line"><span class="pl-cl"><span class="pl-w">        </span><span class="pl-nt">uses</span><span class="pl-p">:</span><span class="pl-w"> </span><span class="pl-l">peaceiris/actions-gh-pages@v3</span><span class="pl-w">
</span></span></span><span class="pl-line"><span class="pl-cl"><span class="pl-w">        </span><span class="pl-nt">if</span><span class="pl-p">:</span><span class="pl-w"> </span><span class="pl-l">${{ github.ref == 'refs/heads/main' }}</span><span class="pl-w">
</span></span></span><span class="pl-line"><span class="pl-cl"><span class="pl-w">        </span><span class="pl-nt">with</span><span class="pl-p">:</span><span class="pl-w">
</span></span></span><span class="pl-line"><span class="pl-cl"><span class="pl-w">          </span><span class="pl-nt">github_token</span><span class="pl-p">:</span><span class="pl-w"> </span><span class="pl-l">${{ secrets.GITHUB_TOKEN }}</span><span class="pl-w">
</span></span></span><span class="pl-line"><span class="pl-cl"><span class="pl-w">          </span><span class="pl-nt">publish_dir</span><span class="pl-p">:</span><span class="pl-w"> </span><span class="pl-l">./dist</span></span></span></code></pre><p>After you‚Äôve committed and merged everything into your <code>main</code> branch, go to your project‚Äôs ‚ÄúSettings‚Äù page, then click on ‚ÄúPages‚Äù on the left, and set your ‚ÄúBranch‚Äù to point to <code>gh-pages</code> and <code>/ (root)</code>. The page should tell you that your site is live and give you a link and button to visit the site.</p><h2 id="example-project">Example project</h2><p>Here is a silly project where everything in this blog post was implemented: <a href="https://github.com/rpearce/gom-jabbar-bingo" class="uri">https://github.com/rpearce/gom-jabbar-bingo</a>.</p><h2 id="wrapping-up">Wrapping up</h2><p>So‚Ä¶ did we over-engineer our website? Maybe? But we‚Äôre also avoiding static asset caching issues by automating away a guaranteed way of cache-busting our static assets, so that‚Äôs something!</p><p>If you‚Äôd like to see more bash content or something else entirely, send me an email!</p><hr /><p>Thanks for reading!<br /> ‚Äî Robert</p></section></main><footer><span aria-hidden="true" class="heart">‚ô•</span><span aria-hidden="true">&rarr;</span><a href="https://github.com/sponsors/rpearce/">Sponsor my work</a><span aria-hidden="true">&larr;</span><span aria-hidden="true" class="heart">‚ô•</span></footer><script async> (() => { const themeEl = document.querySelector('[data-select-theme]'); if (themeEl) { themeEl.querySelector('[value="'+window.site.prefTheme+'"]').selected = 'selected'; themeEl.addEventListener('change', e => { window.site.setTheme(e.target.value); }); } const fontEl = document.querySelector('[data-select-font]'); if (fontEl) { fontEl.querySelector('[value="'+window.site.prefFont+'"]').selected = 'selected'; fontEl.addEventListener('change', e => { window.site.setFont(e.target.value); }) } })(); </script></body></html>