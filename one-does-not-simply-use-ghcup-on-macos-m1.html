<!DOCTYPE html><html lang="en"><head><title>One does not simply use GHCup on macOS M1</title><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="Using Haskell through Nix or Docker might be easier paths on macOS, but this article should help if those options aren't available."><meta name="author" content="Robert Pearce"><meta name="keywords" content="haskell, ghcup, macos m1"><meta name="google-site-verification" content="QX4bn65yOXBfgnwxlO09yIBc1H8blur-Erx3lmsDVhU"><meta http-equiv="origin-trial" content="Am4BZ0c7GMyB72dgo/Ny2FfIFscXhYMoN+CVe4jduWh24FvsaCwf7kjZzHzfrJXtIilyZVAEKRxOItGLY7lvkAgAAABSeyJvcmlnaW4iOiJodHRwczovL3JvYmVydHdwZWFyY2UuY29tOjQ0MyIsImZlYXR1cmUiOiJQb3J0YWxzIiwiZXhwaXJ5IjoxNjAzNTQ2NDc3fQ=="><meta property="og:site_name" content="Robert Pearce"><meta property="og:title" content="One does not simply use GHCup on macOS M1"><meta property="og:url" content="https://robertwpearce.com/one-does-not-simply-use-ghcup-on-macos-m1.html"><meta property="og:description" content="Using Haskell through Nix or Docker might be easier paths on macOS, but this article should help if those options aren't available."><meta property="og:type" content="article"><meta property="twitter:site" content="Robert Pearce"><meta property="twitter:title" content="One does not simply use GHCup on macOS M1"><meta property="twitter:description" content="Using Haskell through Nix or Docker might be easier paths on macOS, but this article should help if those options aren't available."><meta property="twitter:creator" content="@RobertWPearce"><link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>💾</text></svg>"><link rel="canonical" href="https://robertwpearce.com/one-does-not-simply-use-ghcup-on-macos-m1.html"><link rel="alternate" href="./atom.xml" title="Robert Pearce's blog" type="application/atom+xml"><link rel="alternate" href="./rss.xml" title="Robert Pearce's blog" type="application/rss+xml"><link rel="stylesheet" href="./css/base.css"><link rel="stylesheet" href="./css/t-clean.css"><link rel="stylesheet" href="./css/t-clean-note.css"><link rel="stylesheet" href="./css/t-code-dracula.css"><link rel="prefetch" href="./css/t-clean-note.css"></head><body data-theme="clean-night"><script> (() => { window.site = { prefFont: localStorage.getItem('prefFont') || 'monospace', setFont: (family) => { localStorage.setItem('prefFont', family); const rootStyle = document.querySelector(':root').style; rootStyle.setProperty('--type-family-body', family+',monospace'); /* Remove when https://github.com/googlefonts/spacemono/pull/2 is resolved */ if (family === 'Liga Space Mono') { rootStyle.setProperty('font-feature-settings', '"liga" 0'); } else { rootStyle.removeProperty('font-feature-settings'); } return window.site._fetchFont(family); }, prefTheme: localStorage.getItem('prefTheme') || (matchMedia('(prefers-color-scheme: dark)').matches ? 'clean-night' : 'clean-day'), setTheme: (name) => { const rootStyle = document.querySelector(':root').style; if (name === 'clean-night') { rootStyle.removeProperty('color-scheme'); } else { rootStyle.setProperty('color-scheme', 'light'); } document.body.setAttribute('data-theme', name); localStorage.setItem('prefTheme', name); }, _fetchFont: (family) => { if (family === 'monospace') { return Promise.resolve(); } const familyNoSpaces = family.replaceAll(' ', ''); const fontz = [ new FontFace(family, 'url("./fonts/'+familyNoSpaces+'-Regular.woff2") format("woff2")', { display: 'swap', weight: 400 }), new FontFace(family, 'url("./fonts/'+familyNoSpaces+'-Bold.woff2") format("woff2")', { display: 'swap', weight: 700 }), ]; if (family !== 'Fira Code') { fontz.push( new FontFace(family, 'url("./fonts/'+familyNoSpaces+'-Italic.woff2") format("woff2")', { display: 'swap', style: 'italic', weight: 400 }), new FontFace(family, 'url("./fonts/'+familyNoSpaces+'-BoldItalic.woff2") format("woff2")', { display: 'swap', style: 'italic', weight: 700 }) ); } for (const f of fontz) { document.fonts.add(f); } return Promise.allSettled(fontz).then(results => { results.forEach((res, i) => { if (res.status === 'rejected') { console.error('site failed to load font: ' + fontz[i]?.family ?? 'unknown'); } }); }); } }; window.site.setTheme(window.site.prefTheme); window.site.setFont(window.site.prefFont); })(); </script><header><nav><div class="nav-skip"><a href="#content">Skip to content</a></div><a aria-label="Home" class="nav-home" href="./">~</a><span>/</span></nav><div class="header-extra"><a href="./atom.xml">RSS</a><span aria-hidden="true">&compfn;</span><noscript>(requires JS &rarr;)</noscript><label for="select-theme">Theme</label><select data-select-theme id="select-theme"><option value="clean-day">Clean (Day)</option><option value="clean-night">Clean (Night)</option></select><span aria-hidden="true">&compfn;</span><label for="select-font">Font</label><select data-select-font id="select-font"><option value="monospace">monospace</option><option value="Liga Space Mono">Space Mono</option><option value="Victor Mono">Victor Mono</option><option value="Fira Code">Fira Code</option><option value="JetBrains Mono">JetBrains Mono</option></select></div></header><main id="content"><header data-area="heading"><h1>One does not simply use GHCup on macOS M1</h1></header><section data-area="meta"><h2>Info</h2><table data-type="cols-y"><tbody><tr><th>Summary</th><td>Using Haskell through Nix or Docker might be easier paths on macOS, but this article should help if those options aren't available.</td></tr><tr><th>Shared</th><td>2023-03-20</td></tr><tr><th>Revised</th><td>2023-03-22 @ 11:51 UTC</td></tr></tbody></table></section><section data-area="note"><h2 id="intro">Intro</h2><p>The <a href="https://www.haskell.org/ghcup/">GHCup</a> tool is the official installer for core <a href="https://www.haskell.org">Haskell</a> tools: <a href="https://cabal.readthedocs.io/en/stable/">cabal</a>, <a href="https://docs.haskellstack.org/en/stable/">stack</a>, <a href="https://haskell-language-server.readthedocs.io/en/latest/">haskell-language-server</a>, and <a href="https://www.haskell.org/ghc/">ghc</a>.</p><p>I usually use Haskell through <a href="https://nixos.org">Nix</a> (I’m liking <a href="https://devenv.sh/">devenv.sh</a>, too), and I’ve also used it through Docker, but I was frustrated with build times and wanted to try the official Haskell way.</p><p>Unfortunately, I had a rough time trying to use GHCup on a macOS M1 (Ventura 13.2.1), so I documented trying to build a small Haskell project of mine, <a href="https://hackage.haskell.org/package/slugger">slugger</a>, with it.</p><h2 id="a-note-about-homebrew">A note about Homebrew</h2><p>I use <a href="https://brew.sh/">Homebrew</a> for installing all sorts of CLI tools and apps for macOS (here’s my personal <a href="https://github.com/rpearce/dotfiles/blob/main/conf/Brewfile">Brewfile</a>).</p><p>While I will use it for something else later in this guide, I could not get <code>ghcup</code> to work properly when installed via Homebrew, and trying to upgrade GHCup through its interface conflicted with the Homebrew install. Instead, I will use the installer found on <a href="https://www.haskell.org/ghcup/">the GHCup page</a>.</p><h2 id="the-library-i-tried-to-build">The library I tried to build</h2><p>The example library I tried building was my URI slug library, <a href="https://github.com/rpearce/slugger">slugger</a>.</p><h2 id="installing-ghcup">Installing GHCup</h2><p>I like to keep my <code>$HOME</code> directory clean by having tools adhere to the <a href="https://specifications.freedesktop.org/basedir-spec/basedir-spec-latest.html">XDG spec</a>. I read that if I wanted GHCup to use <code>XDG</code>, I needed to export this variable in the shell where the installer was going to run:</p><pre class="pl-chroma"><code><span class="pl-line"><span class="pl-cl"><span class="pl-nb">export</span> <span class="pl-nv">GHCUP_USE_XDG_DIRS</span><span class="pl-o">=</span><span class="pl-s2">"true"</span></span></span></code></pre><p><em><a href="https://github.com/rpearce/dotfiles/blob/fbda507ce4908ec8689d388c6e4ffe0c4900d318/conf/zsh/.zshenv#L3-L8">Here are my XDG environment variables.</a></em></p><p>Since I always want this to be true, <a href="https://github.com/rpearce/dotfiles/blob/fbda507ce4908ec8689d388c6e4ffe0c4900d318/conf/zsh/.zshenv#L22">I include that in my <code>.zshenv</code> dotfile just in case</a>.</p><p>Next, I installed GHCup:</p><pre class="pl-chroma"><code><span class="pl-line"><span class="pl-cl">curl --proto '=https' --tlsv1.2 -sSf https://get-ghcup.haskell.org | sh</span></span></code></pre><p>This is an interactive installer, so there was a bit of output and questions.</p><p><a href="./images/ghcup-install-llvm-note.webp"><img alt="GHCup installer messages" decoding="async" height="482" loading="lazy" src="./images/ghcup-install-llvm-note.webp" width="600" /></a></p><p>Tip: if you run this installer, make sure you read the messages.</p><h2 id="including-the-ghcup-environment">Including the GHCup environment</h2><p>The script asked if it could append something to the end of my <code>.zshrc</code> file. I prefer to own my environment setup, so I let it do its thing, inspected the file to make sure it looked good, then I changed the sourcing code into a style I prefer:</p><pre class="pl-chroma"><code><span class="pl-line"><span class="pl-cl"><span class="pl-nv">ghcup_script_path</span><span class="pl-o">=</span><span class="pl-s2">"</span><span class="pl-si">${</span><span class="pl-nv">XDG_DATA_HOME</span><span class="pl-si">}</span><span class="pl-s2">/ghcup/env"</span>
</span></span><span class="pl-line"><span class="pl-cl"><span class="pl-o">[[</span> -f <span class="pl-s2">"</span><span class="pl-si">${</span><span class="pl-nv">ghcup_script_path</span><span class="pl-si">}</span><span class="pl-s2">"</span> <span class="pl-o">]]</span> <span class="pl-o">&amp;&amp;</span> <span class="pl-nb">source</span> <span class="pl-s2">"</span><span class="pl-si">${</span><span class="pl-nv">ghcup_script_path</span><span class="pl-si">}</span><span class="pl-s2">"</span></span></span></code></pre><p>This adds some Haskell bin-related directories to <code>$PATH</code> if they aren’t already there.</p><h2 id="running-the-ghcup-terminal-user-interface">Running the GHCup terminal user interface</h2><p>Once this was all done, I opened a new shell window and ran</p><pre class="pl-chroma"><code><span class="pl-line"><span class="pl-cl">ghcup tui</span></span></code></pre><p>TUI is an acronym for “terminal user interface”.</p><p><a href="./images/ghcup-tui.webp"><img alt="GHCup terminal user interface" decoding="async" height="386.5" loading="lazy" src="./images/ghcup-tui.webp" width="600" /></a></p><p>I used the interface to install the recommended tool versions, and this was really easy! Well done, GHCup crew.</p><p>Then I went to go see if I could build <code>slugger</code>.</p><h2 id="building-slugger-failure-1-llvm">Building slugger: failure #1 (LLVM)</h2><p>When I went to the <code>slugger</code> project directory, I ran <code>cabal v2-build</code>, and some LLVM errors printed to the screen.</p><p><a href="./images/ghcup-cabal-build-fail-llvm.webp"><img alt="LLVM not found when trying to build the slugger project" decoding="async" height="377" loading="lazy" src="./images/ghcup-cabal-build-fail-llvm.webp" width="600" /></a></p><p>Notably:</p><blockquote><p>Warning: Couldn’t figure out LLVM version! Make sure you have installed LLVM between [9 and 13]</p></blockquote><p>Remember how I said to make sure you read the installer messages? Yeah. I didn’t.</p><blockquote><p>On Darwin M1 you might also need a working llvm installed (e.g. via brew) and have the toolchain exposed in the PATH.</p></blockquote><p><em>Update: User bgamari on lobste.rs had a valuable insight into <a href="https://lobste.rs/s/cbl1yc/one_does_not_simply_use_ghcup_on_macos_m1#c_lcaxqm">why installing LLVM is recommended by GHCup</a>.</em></p><h2 id="building-slugger-failures-2-4-also-llvm">Building slugger: failures #2-4 (also LLVM)</h2><p>As suggested by the warnings above, I added <code>brew llvm@9</code> to my <code>Brewfile</code>, installed it, and tried to <code>cabal v2-build</code> the <code>slugger</code> project.</p><p>That didn’t work (same sort of issue).</p><p>I tried <code>llvm@10</code>, <code>llvm@11</code>, and <code>llvm@12</code>.</p><p>None of those worked, either! Would <code>llvm@13</code> work? Maybe, maybe, maybe…</p><h2 id="building-slugger-failure-5-ghc-and-llvm">Building slugger: failure #5 (GHC and LLVM)</h2><p><em>Update: This section may not be necessary. I went back, disabled this option, and I’m able still able to build the library. I don’t recall this being my experience the first time around, though.</em></p><p>It seems none of these will work if <code>ghc</code> doesn’t know to use LLVM.</p><p>I keep a <a href="https://github.com/rpearce/dotfiles/blob/main/conf/.cabal.conf">cabal config file in my dotfiles</a> and it had a section, <code>program-default-options</code>, that contained a <code>ghc-options</code> key for passing flags to ghc.</p><p>Here’s how I told GHC about LLVM:</p><pre class="pl-chroma"><code><span class="pl-line"><span class="pl-cl">program-default-options
</span></span><span class="pl-line"><span class="pl-cl">  ghc-options: -fllvm</span></span></code></pre><p>There’s more information about that on the <a href="https://downloads.haskell.org/ghc/latest/docs/users_guide/codegens.html#llvm-code-generator-fllvm">Haskell GHC Backends doc</a>.</p><p>Did that make a difference? Yep!</p><h2 id="building-slugger-failure-6-missing-foreign-libraries">Building slugger: failure #6 (missing foreign libraries)</h2><p>Aha! A different error.</p><p><a href="./images/ghcup-cabal-build-fail-icu4c.webp"><img alt="Missing foreign libraries terminal error" decoding="async" height="499.5" loading="lazy" src="./images/ghcup-cabal-build-fail-icu4c.webp" width="600" /></a></p><blockquote><p>cabal-3.6.2.0 Missing dependencies on foreign libraries:<br /> Missing (or bad) C libraries: icuuc, icui18n, icudata</p></blockquote><p>This one stemmed from trying to build a dependency, <a href="https://hackage.haskell.org/package/text-icu">text-icu</a>, and it seemed I was missing some libraries it expected to find on the OS.</p><p>I saw some references on GitHub issues to the <code>icu4c</code> tool, but I was luckily able to find <a href="https://guide.aelve.com/haskell/missing-dependency-on-a-foreign-library-vf6h3d0p#item-a06pn7xw">this archived “Missing dependency on a foreign library” guide</a> that simply told me what to do:</p><ol><li><p><code>brew install icu4c</code></p></li><li><p>If you’re using stack, add this to <code>~/.stack/config.yaml</code>:</p><pre class="pl-chroma"><code><span class="pl-line"><span class="pl-cl">extra-include-dirs:
</span></span><span class="pl-line"><span class="pl-cl">- /usr/local/opt/icu4c/include
</span></span><span class="pl-line"><span class="pl-cl">
</span></span><span class="pl-line"><span class="pl-cl">extra-lib-dirs:
</span></span><span class="pl-line"><span class="pl-cl">- /usr/local/opt/icu4c/lib</span></span></code></pre></li></ol><p>Unfortunately, none of this worked out of the box for me for two reasons:</p><ol><li>I’m not using <code>stack</code></li><li>Homebrew uses <code>/opt/homebrew/</code> for Apple Silicon—not <code>/usr/local/</code></li></ol><p>But those config options looked <em>exactly the same</em> as the recommendation from the build warning above, and that gave me some things to try:</p><blockquote><p>If the libraries are already installed but in a non-standard location then you can use the flags <code>--extra-include-dirs=</code> and <code>--extra-lib-dirs=</code> to specify where they are.</p></blockquote><h2 id="fixing-the-missing-foreign-libraries-issue">Fixing the missing foreign libraries issue</h2><p>It turns out that my <code>cabal.conf</code> file had <code>extra-include-dirs</code> and <code>extra-lib-dirs</code> in it, so I didn’t need to pass paths every time I tried to build with cabal.</p><p>I don’t regularly edit cabal config files, so I took the <code>stack</code> <em>YAML</em> config above and tried it:</p><pre class="pl-chroma"><code><span class="pl-line"><span class="pl-cl">extra-include-dirs:
</span></span><span class="pl-line"><span class="pl-cl">- /opt/homebrew/opt/icu4c/include
</span></span><span class="pl-line"><span class="pl-cl">
</span></span><span class="pl-line"><span class="pl-cl">extra-lib-dirs:
</span></span><span class="pl-line"><span class="pl-cl">- /opt/homebrew/opt/icu4c/lib</span></span></code></pre><p>Nope, that didn’t work. I tried indenting the <code>-</code> to see if the config file liked that.</p><p>Nope.</p><p>While this config file might, at a glance, resemble YAML, it isn’t—it seems to resemble (or even be) a <code>.cabal</code> file (<a href="mailto:me@robertwpearce.com">email me</a> if you know, please!). Here was a correct way to write them:</p><pre class="pl-chroma"><code><span class="pl-line"><span class="pl-cl">extra-include-dirs:
</span></span><span class="pl-line"><span class="pl-cl">  /opt/homebrew/opt/icu4c/include
</span></span><span class="pl-line"><span class="pl-cl">
</span></span><span class="pl-line"><span class="pl-cl">extra-lib-dirs:
</span></span><span class="pl-line"><span class="pl-cl">  /opt/homebrew/opt/icu4c/lib</span></span></code></pre><h2 id="sweet-success">Sweet success</h2><p>With high hopes, I ran <code>cabal v2-build</code> again, and it worked!</p><p><a href="./images/ghcup-cabal-build-success.webp"><img alt="Successful build result and test of the slugger library" decoding="async" height="482" loading="lazy" src="./images/ghcup-cabal-build-success.webp" width="600" /></a></p><p>I was successfully able to build my little library and test it out with <code>cabal</code>.</p><h2 id="personal-retrospective-on-the-experience">Personal retrospective on the experience</h2><p>There are a number of places here where, if I’d have paid closer attention to (admittedly helpful) walls of text, I’d have been led to solutions faster. That is unquestionably my fault!</p><p>That said, the errors don’t cover everything you have to do (like the <code>-fllvm</code> GHC flag), and this overall experience on macOS was rough for me.</p><p><strong>I am grateful for all the effort put into GHCup, and I know it takes time and money to make things simple.</strong></p><p>For now, even though Nix’s story isn’t one of simplicity, either, I’m going to mostly stick with building Haskell projects that way. However, I’ll keep my options open and periodically try things the GHCup way, as well.</p><hr /><p>Thanks for reading!<br /> — Robert</p></section></main><footer><span aria-hidden="true" class="heart">♥</span><span aria-hidden="true">&rarr;</span><a href="https://github.com/sponsors/rpearce/">Sponsor my work</a><span aria-hidden="true">&larr;</span><span aria-hidden="true" class="heart">♥</span></footer><script async> (() => { const themeEl = document.querySelector('[data-select-theme]'); if (themeEl) { themeEl.querySelector('[value="'+window.site.prefTheme+'"]').selected = 'selected'; themeEl.addEventListener('change', e => { window.site.setTheme(e.target.value); }); } const fontEl = document.querySelector('[data-select-font]'); if (fontEl) { fontEl.querySelector('[value="'+window.site.prefFont+'"]').selected = 'selected'; fontEl.addEventListener('change', e => { window.site.setFont(e.target.value); }) } })(); </script></body></html>