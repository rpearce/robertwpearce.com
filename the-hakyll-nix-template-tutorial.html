<!DOCTYPE html><html lang="en"><head><title>The hakyll-nix-template Tutorial</title><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="A full walkthrough for getting set up to create static sites using nix and hakyll"><meta name="author" content="Robert Pearce"><meta name="keywords" content="hakyll, nix, hakyll-nix-template, haskell, static site generators, functional programming, programming"><meta name="google-site-verification" content="QX4bn65yOXBfgnwxlO09yIBc1H8blur-Erx3lmsDVhU"><meta http-equiv="origin-trial" content="Am4BZ0c7GMyB72dgo/Ny2FfIFscXhYMoN+CVe4jduWh24FvsaCwf7kjZzHzfrJXtIilyZVAEKRxOItGLY7lvkAgAAABSeyJvcmlnaW4iOiJodHRwczovL3JvYmVydHdwZWFyY2UuY29tOjQ0MyIsImZlYXR1cmUiOiJQb3J0YWxzIiwiZXhwaXJ5IjoxNjAzNTQ2NDc3fQ=="><meta property="og:site_name" content="Robert Pearce"><meta property="og:title" content="The hakyll-nix-template Tutorial"><meta property="og:url" content="https://robertwpearce.com/the-hakyll-nix-template-tutorial.html"><meta property="og:description" content="A full walkthrough for getting set up to create static sites using nix and hakyll"><meta property="og:type" content="article"><meta property="twitter:site" content="Robert Pearce"><meta property="twitter:title" content="The hakyll-nix-template Tutorial"><meta property="twitter:description" content="A full walkthrough for getting set up to create static sites using nix and hakyll"><meta property="twitter:creator" content="@RobertWPearce"><link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üíæ</text></svg>"><link rel="canonical" href="https://robertwpearce.com/the-hakyll-nix-template-tutorial.html"><link rel="alternate" href="./atom.xml" title="Robert Pearce's blog" type="application/atom+xml"><link rel="alternate" href="./rss.xml" title="Robert Pearce's blog" type="application/rss+xml"><link rel="stylesheet" href="./css/base.css"><link rel="stylesheet" href="./css/t-clean.css"><link rel="stylesheet" href="./css/t-clean-note.css"><link rel="stylesheet" href="./css/t-code-dracula.css"><link rel="prefetch" href="./css/t-clean-note.css"></head><body data-theme="clean-night"><script> (() => { window.site = { prefFont: localStorage.getItem('prefFont') || 'monospace', setFont: (family) => { localStorage.setItem('prefFont', family); const rootStyle = document.querySelector(':root').style; rootStyle.setProperty('--type-family-body', family+',monospace'); /* Remove when https://github.com/googlefonts/spacemono/pull/2 is resolved */ if (family === 'Liga Space Mono') { rootStyle.setProperty('font-feature-settings', '"liga" 0'); } else { rootStyle.removeProperty('font-feature-settings'); } return window.site._fetchFont(family); }, prefTheme: localStorage.getItem('prefTheme') || (matchMedia('(prefers-color-scheme: dark)').matches ? 'clean-night' : 'clean-day'), setTheme: (name) => { const rootStyle = document.querySelector(':root').style; if (name === 'clean-night') { rootStyle.removeProperty('color-scheme'); } else { rootStyle.setProperty('color-scheme', 'light'); } document.body.setAttribute('data-theme', name); localStorage.setItem('prefTheme', name); }, _fetchFont: (family) => { if (family === 'monospace') { return Promise.resolve(); } const familyNoSpaces = family.replaceAll(' ', ''); const fontz = [ new FontFace(family, 'url("./fonts/'+familyNoSpaces+'-Regular.woff2") format("woff2")', { display: 'swap', weight: 400 }), new FontFace(family, 'url("./fonts/'+familyNoSpaces+'-Bold.woff2") format("woff2")', { display: 'swap', weight: 700 }), ]; if (family !== 'Fira Code') { fontz.push( new FontFace(family, 'url("./fonts/'+familyNoSpaces+'-Italic.woff2") format("woff2")', { display: 'swap', style: 'italic', weight: 400 }), new FontFace(family, 'url("./fonts/'+familyNoSpaces+'-BoldItalic.woff2") format("woff2")', { display: 'swap', style: 'italic', weight: 700 }) ); } for (const f of fontz) { document.fonts.add(f); } return Promise.allSettled(fontz).then(results => { results.forEach((res, i) => { if (res.status === 'rejected') { console.error('site failed to load font: ' + fontz[i]?.family ?? 'unknown'); } }); }); } }; window.site.setTheme(window.site.prefTheme); window.site.setFont(window.site.prefFont); })(); </script><header><nav><div class="nav-skip"><a href="#content">Skip to content</a></div><a aria-label="Home" class="nav-home" href="./">~</a><span>/</span></nav><div class="header-extra"><a href="./atom.xml">RSS</a><span aria-hidden="true">&compfn;</span><noscript>(requires JS &rarr;)</noscript><label for="select-theme">Theme</label><select data-select-theme id="select-theme"><option value="clean-day">Clean (Day)</option><option value="clean-night">Clean (Night)</option></select><span aria-hidden="true">&compfn;</span><label for="select-font">Font</label><select data-select-font id="select-font"><option value="monospace">monospace</option><option value="Liga Space Mono">Space Mono</option><option value="Victor Mono">Victor Mono</option><option value="Fira Code">Fira Code</option><option value="JetBrains Mono">JetBrains Mono</option></select></div></header><main id="content"><header data-area="heading"><h1>The hakyll-nix-template Tutorial</h1></header><section data-area="meta"><h2>Info</h2><table data-type="cols-y"><tbody><tr><th>Summary</th><td>A full walkthrough for getting set up to create static sites using nix and hakyll</td></tr><tr><th>Shared</th><td>2023-02-12</td></tr></tbody></table></section><section data-area="note"><p>If you‚Äôre looking to use <a href="https://jaspervdj.be/hakyll">hakyll</a> with <a href="https://nixos.org">nix</a> to build static sites, this reference article was made for you!</p><p>We will be working with the <a href="https://github.com/rpearce/hakyll-nix-template/">hakyll-nix-template</a>, so go ahead and pull that up in a new browser tab. Its README also contains info on all the features that are provided.</p><h2 id="overview">Overview</h2><ul><li><a href="#prerequisites">Prerequisites</a></li><li><a href="#copying-the-template">Copying the template</a></li><li><a href="#building-the-project">Building the project</a></li><li><a href="#getting-into-the-haskell-and-nix-dev-environment">Getting into the haskell and nix dev environment</a></li><li><a href="#personalizing-the-project-build">Personalizing the project build</a></li><li><a href="#adding-your-first-post">Adding your first post</a></li><li><a href="#working-with-page-metadata">Working with page metadata</a></li><li><a href="#determining-what-static-files-are-copied-over">Determining what static files are copied over</a></li><li><a href="#understanding-the-github-action-workflow">Understanding the GitHub action workflow</a></li><li><a href="#enabling-github-pages">Enabling GitHub Pages</a></li><li><a href="#deploying-to-your-domain">Deploying to your domain</a></li><li><a href="#todos-for-hakyll-nix-template">TODOs for hakyll-nix-template</a><ul><li><a href="#todo-caching-and-hashing">TODO: Caching and hashing</a></li><li><a href="#todo-use-pygments-for-syntax-highlighting">TODO: Use pygments for syntax highlighting</a></li></ul></li><li><a href="#other-hakyll-posts">Other hakyll posts</a></li></ul><h2 id="prerequisites">Prerequisites</h2><p>If you don‚Äôt have <a href="https://nixos.org">nix</a>, follow <a href="https://nixos.org/download.html">the nix installation instructions</a>.</p><p>Once you have nix installed, follow the <a href="https://nixos.wiki/wiki/Flakes">nix flakes setup instructions</a>, and then I highly recommend installing <a href="https://www.cachix.org">cachix</a>, as well.</p><p>If it helps, here is <a href="https://github.com/rpearce/dotfiles/blob/809e8fc298291c9819d4d2ffcf1d99b74a3931fe/install#L184-L217">my <code>install_nix</code> bash function</a>, and here is my <a href="https://github.com/rpearce/dotfiles/blob/main/conf/.nix.conf"><code>${XDG_CONFIG_HOME}/nix/nix.conf</code> file</a> (note: on macOS, this will likely be <code>~/.config/nix/nix.conf</code>). Feel free to copy the conf file, and just remove <code>https://rpearce.cachix.org</code> from <code>substituters</code> and <code>rpearce.cachix.org-1:...=</code> from the <code>trusted-public-keys</code> (or replace with your own cache from cachix!).</p><p>While you‚Äôre at it, we aren‚Äôt using <a href="https://devenv.sh">devenv.sh</a> nor <a href="https://github.com/nix-community/nix-direnv">nix-direnv</a> in this example, but you should check them out later, too.</p><h2 id="copying-the-template">Copying the template</h2><p>From the <a href="https://github.com/rpearce/hakyll-nix-template">hakyll-nix-template</a> page, click ‚ÄúUse this template‚Äù and then select ‚ÄúCreate a new repository‚Äù from the popover menu.</p><p><img alt="GitHub's 'Use this template' menu" decoding="async" height="246" loading="lazy" src="./images/hnt-copy.webp" width="422" /></p><p>Next, create a new repository from the template, filling in the details you want for the repo.</p><p><img alt="GitHub form for creating a new repository from a template" decoding="async" height="600" loading="lazy" src="./images/hnt-create.webp" width="801" /></p><p>After creating the repository, click the ‚Äú&lt;&gt; Code‚Äù button, then choose your method of cloning the repository.</p><p><img alt="GitHub's code cloning menu" decoding="async" height="500" loading="lazy" src="./images/hnt-clone.webp" width="547" /></p><p>Once you‚Äôve chosen your preferred cloning command and ran that in your terminal, <code>cd</code> into the directory.</p><p><img alt="Terminal that has cloned the repository and cd'd into the directory" decoding="async" height="520" loading="lazy" src="./images/hnt-clone-result.webp" width="968" /></p><p>Alright! We‚Äôre ready to build and personalize our project.</p><h2 id="building-the-project">Building the project</h2><p>Run <code>nix build</code>, answer any substituters trust prompts, and then go do something else for a while. The first run takes a while, and how long it takes depends on connection speed, processing speed, and ‚Äî most importantly ‚Äî what caches you have set up in <code>nix.conf</code> (and/or <code>flake.nix</code>).</p><p>Once that is all done, you‚Äôll have a brand new <code>result/</code> directory available that is a symlink to <code>/nix/store/&lt;HASH&gt;-website/</code>. For this blog, it looks like this:</p><pre class="pl-chroma"><code><span class="pl-line"><span class="pl-cl">result/
</span></span><span class="pl-line"><span class="pl-cl">‚îî‚îÄ‚îÄ dist/
</span></span><span class="pl-line"><span class="pl-cl">  ‚îú‚îÄ‚îÄ CNAME
</span></span><span class="pl-line"><span class="pl-cl">  ‚îú‚îÄ‚îÄ _config.yml
</span></span><span class="pl-line"><span class="pl-cl">  ‚îú‚îÄ‚îÄ announcing-react-medium-image-zoom-v4.html
</span></span><span class="pl-line"><span class="pl-cl">  ‚îú‚îÄ‚îÄ asynchronously-loading-scripts.html
</span></span><span class="pl-line"><span class="pl-cl">  ‚îú‚îÄ‚îÄ atom.xml
</span></span><span class="pl-line"><span class="pl-cl">  ‚îú‚îÄ‚îÄ be-better.html
</span></span><span class="pl-line"><span class="pl-cl">  ‚îú‚îÄ‚îÄ behaviour-your-team.html
</span></span><span class="pl-line"><span class="pl-cl">  ‚îú‚îÄ‚îÄ berlin.html
</span></span><span class="pl-line"><span class="pl-cl">  ‚îú‚îÄ‚îÄ build-your-team-an-accessible-shareable-component-library.html
</span></span><span class="pl-line"><span class="pl-cl">  ‚îú‚îÄ‚îÄ catch-low-hanging-accessibility-fruit-with-axe-core.html
</span></span><span class="pl-line"><span class="pl-cl">  ‚îú‚îÄ‚îÄ chief.html
</span></span><span class="pl-line"><span class="pl-cl">  ‚îú‚îÄ‚îÄ css
</span></span><span class="pl-line"><span class="pl-cl">  ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ article.css
</span></span><span class="pl-line"><span class="pl-cl">  ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ default.css
</span></span><span class="pl-line"><span class="pl-cl">  ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ home.css
</span></span><span class="pl-line"><span class="pl-cl">  ‚îú‚îÄ‚îÄ delegate-dont-dump.html
</span></span><span class="pl-line"><span class="pl-cl">  ‚îú‚îÄ‚îÄ ...</span></span></code></pre><p>This is your static output! While you could run <code>cd result/dist</code> and either <code>npx serve .</code> or <code>python -m SimpleHTTPServer</code>, let‚Äôs do this the <code>hakyll-nix-template</code> way:</p><pre class="pl-chroma"><code><span class="pl-line"><span class="pl-cl">Œª nix run . watch
</span></span><span class="pl-line"><span class="pl-cl">Listening on http://127.0.0.1:8000
</span></span><span class="pl-line"><span class="pl-cl">Initialising...
</span></span><span class="pl-line"><span class="pl-cl">  Creating store...
</span></span><span class="pl-line"><span class="pl-cl">  Creating provider...
</span></span><span class="pl-line"><span class="pl-cl">  Running rules...
</span></span><span class="pl-line"><span class="pl-cl">Checking for out-of-date items
</span></span><span class="pl-line"><span class="pl-cl">Compiling
</span></span><span class="pl-line"><span class="pl-cl">Success</span></span></code></pre><p>Lovely! If we navigate to <a href="http://127.0.0.1:8000" class="uri">http://127.0.0.1:8000</a>, we‚Äôll see the default webpage included in the project.</p><h2 id="getting-into-the-haskell-and-nix-dev-environment">Getting into the haskell and nix dev environment</h2><p>In a new terminal pane or window, run <code>nix develop</code> (note: this may take a while the first time):</p><pre class="pl-chroma"><code><span class="pl-line"><span class="pl-cl">Œª nix develop
</span></span><span class="pl-line"><span class="pl-cl">[hakyll-nix]Œª</span></span></code></pre><p>When you have <code>[hakyll-nix]Œª</code> as your prompt, you know that you‚Äôre in a nix shell. This comes preloaded with <em>most</em> of your existing CLI tools, plus <code>cabal</code>, <code>ghc</code>, <code>haskell-language-server</code>, and <code>hlint</code>. If you want it to be exactly your environment plus the nix develop shell, check out <a href="https://github.com/nix-community/nix-direnv">nix-direnv</a>.</p><p>At this point, if you‚Äôre using Vim, for example, you can run <code>vim .</code> and open the project up <em>with access to the aforementioned tools</em>.</p><p>Now, it‚Äôs time to customize the project for you.</p><h2 id="personalizing-the-project-build">Personalizing the project build</h2><p>First, go back to your window where you can <code>nix run . watch</code> and cancel that; e.g., press <code>ctrl + c</code>.</p><p>Next, using your editor, open <code>ssg/src/Main.hs</code>, and read over the <code>PERSONALIZATION</code> section near the top:</p><pre class="pl-chroma"><code><span class="pl-line"><span class="pl-cl"><span class="pl-c1">------------------</span>
</span></span><span class="pl-line"><span class="pl-cl"><span class="pl-c1">-- PERSONALIZATION</span>
</span></span><span class="pl-line"><span class="pl-cl">
</span></span><span class="pl-line"><span class="pl-cl"><span class="pl-nf">mySiteName</span> <span class="pl-ow">::</span> <span class="pl-kt">String</span>
</span></span><span class="pl-line"><span class="pl-cl"><span class="pl-nf">mySiteName</span> <span class="pl-ow">=</span> <span class="pl-s">"My Site Name"</span>
</span></span><span class="pl-line"><span class="pl-cl">
</span></span><span class="pl-line"><span class="pl-cl"><span class="pl-nf">mySiteRoot</span> <span class="pl-ow">::</span> <span class="pl-kt">String</span>
</span></span><span class="pl-line"><span class="pl-cl"><span class="pl-nf">mySiteRoot</span> <span class="pl-ow">=</span> <span class="pl-s">"https://my-site.com"</span>
</span></span><span class="pl-line"><span class="pl-cl">
</span></span><span class="pl-line"><span class="pl-cl"><span class="pl-nf">myFeedTitle</span> <span class="pl-ow">::</span> <span class="pl-kt">String</span>
</span></span><span class="pl-line"><span class="pl-cl"><span class="pl-nf">myFeedTitle</span> <span class="pl-ow">=</span> <span class="pl-s">"My Site"</span>
</span></span><span class="pl-line"><span class="pl-cl">
</span></span><span class="pl-line"><span class="pl-cl"><span class="pl-nf">myFeedDescription</span> <span class="pl-ow">::</span> <span class="pl-kt">String</span>
</span></span><span class="pl-line"><span class="pl-cl"><span class="pl-nf">myFeedDescription</span> <span class="pl-ow">=</span> <span class="pl-s">"My Site Description"</span>
</span></span><span class="pl-line"><span class="pl-cl">
</span></span><span class="pl-line"><span class="pl-cl"><span class="pl-nf">myFeedAuthorName</span> <span class="pl-ow">::</span> <span class="pl-kt">String</span>
</span></span><span class="pl-line"><span class="pl-cl"><span class="pl-nf">myFeedAuthorName</span> <span class="pl-ow">=</span> <span class="pl-s">"My Name"</span>
</span></span><span class="pl-line"><span class="pl-cl">
</span></span><span class="pl-line"><span class="pl-cl"><span class="pl-nf">myFeedAuthorEmail</span> <span class="pl-ow">::</span> <span class="pl-kt">String</span>
</span></span><span class="pl-line"><span class="pl-cl"><span class="pl-nf">myFeedAuthorEmail</span> <span class="pl-ow">=</span> <span class="pl-s">"me@myemail.com"</span>
</span></span><span class="pl-line"><span class="pl-cl">
</span></span><span class="pl-line"><span class="pl-cl"><span class="pl-nf">myFeedRoot</span> <span class="pl-ow">::</span> <span class="pl-kt">String</span>
</span></span><span class="pl-line"><span class="pl-cl"><span class="pl-nf">myFeedRoot</span> <span class="pl-ow">=</span> <span class="pl-n">mySiteRoot</span></span></span></code></pre><p>This area contains all the high level, site-based customization text and root URLs for you to update. Go ahead and do that.</p><p>Below this area, you‚Äôll find the <code>CONFIG</code> section:</p><pre class="pl-chroma"><code><span class="pl-line"><span class="pl-cl"><span class="pl-c1">-- Default configuration: https://github.com/jaspervdj/hakyll/blob/cd74877d41f41c4fba27768f84255e797748a31a/lib/Hakyll/Core/Configuration.hs#L101-L125</span>
</span></span><span class="pl-line"><span class="pl-cl"><span class="pl-nf">config</span> <span class="pl-ow">::</span> <span class="pl-kt">Configuration</span>
</span></span><span class="pl-line"><span class="pl-cl"><span class="pl-nf">config</span> <span class="pl-ow">=</span>
</span></span><span class="pl-line"><span class="pl-cl">  <span class="pl-n">defaultConfiguration</span>
</span></span><span class="pl-line"><span class="pl-cl">    <span class="pl-p">{</span> <span class="pl-n">destinationDirectory</span> <span class="pl-ow">=</span> <span class="pl-s">"dist"</span>
</span></span><span class="pl-line"><span class="pl-cl">    <span class="pl-p">,</span> <span class="pl-n">ignoreFile</span> <span class="pl-ow">=</span> <span class="pl-n">ignoreFile'</span>
</span></span><span class="pl-line"><span class="pl-cl">    <span class="pl-p">,</span> <span class="pl-n">previewHost</span> <span class="pl-ow">=</span> <span class="pl-s">"127.0.0.1"</span>
</span></span><span class="pl-line"><span class="pl-cl">    <span class="pl-p">,</span> <span class="pl-n">previewPort</span> <span class="pl-ow">=</span> <span class="pl-mi">8000</span>
</span></span><span class="pl-line"><span class="pl-cl">    <span class="pl-p">,</span> <span class="pl-n">providerDirectory</span> <span class="pl-ow">=</span> <span class="pl-s">"src"</span>
</span></span><span class="pl-line"><span class="pl-cl">    <span class="pl-p">,</span> <span class="pl-n">storeDirectory</span> <span class="pl-ow">=</span> <span class="pl-s">"ssg/_cache"</span>
</span></span><span class="pl-line"><span class="pl-cl">    <span class="pl-p">,</span> <span class="pl-n">tmpDirectory</span> <span class="pl-ow">=</span> <span class="pl-s">"ssg/_tmp"</span>
</span></span><span class="pl-line"><span class="pl-cl">    <span class="pl-p">}</span>
</span></span><span class="pl-line"><span class="pl-cl">  <span class="pl-kr">where</span>
</span></span><span class="pl-line"><span class="pl-cl">    <span class="pl-n">ignoreFile'</span> <span class="pl-n">path</span>
</span></span><span class="pl-line"><span class="pl-cl">      <span class="pl-o">|</span> <span class="pl-s">"."</span>    <span class="pl-p">`</span><span class="pl-n">isPrefixOf</span><span class="pl-p">`</span> <span class="pl-n">fileName</span> <span class="pl-ow">=</span> <span class="pl-kt">False</span>
</span></span><span class="pl-line"><span class="pl-cl">      <span class="pl-o">|</span> <span class="pl-s">"#"</span>    <span class="pl-p">`</span><span class="pl-n">isPrefixOf</span><span class="pl-p">`</span> <span class="pl-n">fileName</span> <span class="pl-ow">=</span> <span class="pl-kt">True</span>
</span></span><span class="pl-line"><span class="pl-cl">      <span class="pl-o">|</span> <span class="pl-s">"~"</span>    <span class="pl-p">`</span><span class="pl-n">isSuffixOf</span><span class="pl-p">`</span> <span class="pl-n">fileName</span> <span class="pl-ow">=</span> <span class="pl-kt">True</span>
</span></span><span class="pl-line"><span class="pl-cl">      <span class="pl-o">|</span> <span class="pl-s">".swp"</span> <span class="pl-p">`</span><span class="pl-n">isSuffixOf</span><span class="pl-p">`</span> <span class="pl-n">fileName</span> <span class="pl-ow">=</span> <span class="pl-kt">True</span>
</span></span><span class="pl-line"><span class="pl-cl">      <span class="pl-o">|</span> <span class="pl-n">otherwise</span> <span class="pl-ow">=</span> <span class="pl-kt">False</span>
</span></span><span class="pl-line"><span class="pl-cl">      <span class="pl-kr">where</span>
</span></span><span class="pl-line"><span class="pl-cl">        <span class="pl-n">fileName</span> <span class="pl-ow">=</span> <span class="pl-n">takeFileName</span> <span class="pl-n">path</span></span></span></code></pre><p>This section specifically deals with your hakyll config. If you want to change the development server port, host, content, source directory, what files are or aren‚Äôt ignored, and some caching things, then you can do so here.</p><p>The rest of the file is all related to hakyll and the build, so if you know hakyll already, this should feel familiar, and feel free to customize it however you like.</p><p>Do note that any changes you make inside of <code>ssg/</code> means you‚Äôll need to turn your dev server off and on again.</p><h2 id="adding-your-first-post">Adding your first post</h2><p>Now that we‚Äôve customized our config, turn the dev server back on with <code>nix run . watch</code>. It‚Äôs time to add our first post!</p><p>Navigate to the <code>src/posts/</code> folder and add a new markdown file with this naming format:</p><pre class="pl-chroma"><code><span class="pl-line"><span class="pl-cl">2023-02-10-my-real-post.md</span></span></code></pre><p>As you can see from the other posts already in this directory, we have post metadata (a.k.a. front-matter) and then the post content follows that. For example:</p><pre class="pl-chroma"><code><span class="pl-line"><span class="pl-cl">---
</span></span><span class="pl-line"><span class="pl-cl">author: "Robert Pearce"
</span></span><span class="pl-line"><span class="pl-cl">authorTwitter: "@RobertWPearce"
</span></span><span class="pl-line"><span class="pl-cl">desc: "Welcome to the fun, probably over-engineered world of nix and haskell to make a website"
</span></span><span class="pl-line"><span class="pl-cl">image: "./images/some-image.webp"
</span></span><span class="pl-line"><span class="pl-cl">keywords: "hakyll, nix, haskell, static site generator"
</span></span><span class="pl-line"><span class="pl-cl">lang: "en"
</span></span><span class="pl-line"><span class="pl-cl">title: "Today, I used hakyll-nix-template"
</span></span><span class="pl-line"><span class="pl-cl">---
</span></span><span class="pl-line"><span class="pl-cl">
</span></span><span class="pl-line"><span class="pl-cl">Hello, world! I am here!</span></span></code></pre><p>‚Ä¶but customize this with your own content.</p><p>Save the file and watch your dev server reload and pick it up! If you refresh your browser, you should now see your post on the index page.</p><h2 id="working-with-page-metadata">Working with page metadata</h2><p>The <code>author</code>, <code>desc</code>, <code>title</code>, and other meta fields from the prior section are all completely customizable by you! These are fields that you can change, remove, or add more of, and they are used in your HTML templates in the <code>src/templates/</code> folder.</p><p>If you open <code>src/templates/post.html</code>, you‚Äôll see something like this:</p><pre class="pl-chroma"><code><span class="pl-line"><span class="pl-cl"><span class="pl-p">&lt;</span><span class="pl-nt">main</span><span class="pl-p">&gt;</span>
</span></span><span class="pl-line"><span class="pl-cl">  <span class="pl-p">&lt;</span><span class="pl-nt">article</span><span class="pl-p">&gt;</span>
</span></span><span class="pl-line"><span class="pl-cl">    <span class="pl-p">&lt;</span><span class="pl-nt">header</span><span class="pl-p">&gt;</span>
</span></span><span class="pl-line"><span class="pl-cl">      <span class="pl-p">&lt;</span><span class="pl-nt">h1</span><span class="pl-p">&gt;</span>
</span></span><span class="pl-line"><span class="pl-cl">        <span class="pl-p">&lt;</span><span class="pl-nt">a</span> <span class="pl-na">href</span><span class="pl-o">=</span><span class="pl-s">".$url$"</span><span class="pl-p">&gt;</span>$title$<span class="pl-p">&lt;/</span><span class="pl-nt">a</span><span class="pl-p">&gt;</span>
</span></span><span class="pl-line"><span class="pl-cl">      <span class="pl-p">&lt;/</span><span class="pl-nt">h1</span><span class="pl-p">&gt;</span>
</span></span><span class="pl-line"><span class="pl-cl">      <span class="pl-p">&lt;</span><span class="pl-nt">div</span><span class="pl-p">&gt;</span>
</span></span><span class="pl-line"><span class="pl-cl">        <span class="pl-p">&lt;</span><span class="pl-nt">small</span><span class="pl-p">&gt;</span>$date$<span class="pl-p">&lt;/</span><span class="pl-nt">small</span><span class="pl-p">&gt;</span>
</span></span><span class="pl-line"><span class="pl-cl">        $if(updated)$
</span></span><span class="pl-line"><span class="pl-cl">        <span class="pl-p">&lt;</span><span class="pl-nt">small</span><span class="pl-p">&gt;</span>(updated: $updated$)<span class="pl-p">&lt;/</span><span class="pl-nt">small</span><span class="pl-p">&gt;</span>
</span></span><span class="pl-line"><span class="pl-cl">        $endif$
</span></span><span class="pl-line"><span class="pl-cl">      <span class="pl-p">&lt;/</span><span class="pl-nt">div</span><span class="pl-p">&gt;</span>
</span></span><span class="pl-line"><span class="pl-cl">    <span class="pl-p">&lt;/</span><span class="pl-nt">header</span><span class="pl-p">&gt;</span>
</span></span><span class="pl-line"><span class="pl-cl">    <span class="pl-p">&lt;</span><span class="pl-nt">section</span><span class="pl-p">&gt;</span>
</span></span><span class="pl-line"><span class="pl-cl">      $body$
</span></span><span class="pl-line"><span class="pl-cl">    <span class="pl-p">&lt;/</span><span class="pl-nt">section</span><span class="pl-p">&gt;</span>
</span></span><span class="pl-line"><span class="pl-cl">  <span class="pl-p">&lt;/</span><span class="pl-nt">article</span><span class="pl-p">&gt;</span>
</span></span><span class="pl-line"><span class="pl-cl"><span class="pl-p">&lt;/</span><span class="pl-nt">main</span><span class="pl-p">&gt;</span></span></span></code></pre><p>This is all a part of hakyll, but I‚Äôll cover some of this here to make it easier to understand all in one place.</p><p>See <code>$title$</code>? That comes from our post metadata, and <code>updated</code> looks like it‚Äôs an optional field from our metadata, but where does <code>$date$</code> come from? Or <code>$body$</code>?</p><p>In <code>ssg/src/Main.hs</code>, you‚Äôll see <code>postCtx</code>:</p><pre class="pl-chroma"><code><span class="pl-line"><span class="pl-cl"><span class="pl-nf">postCtx</span> <span class="pl-ow">::</span> <span class="pl-kt">Context</span> <span class="pl-kt">String</span>
</span></span><span class="pl-line"><span class="pl-cl"><span class="pl-nf">postCtx</span> <span class="pl-ow">=</span>
</span></span><span class="pl-line"><span class="pl-cl">  <span class="pl-n">constField</span> <span class="pl-s">"root"</span> <span class="pl-n">mySiteRoot</span>
</span></span><span class="pl-line"><span class="pl-cl">    <span class="pl-o">&lt;&gt;</span> <span class="pl-n">constField</span> <span class="pl-s">"siteName"</span> <span class="pl-n">mySiteName</span>
</span></span><span class="pl-line"><span class="pl-cl">    <span class="pl-o">&lt;&gt;</span> <span class="pl-n">dateField</span> <span class="pl-s">"date"</span> <span class="pl-s">"%Y-%m-%d"</span>
</span></span><span class="pl-line"><span class="pl-cl">    <span class="pl-o">&lt;&gt;</span> <span class="pl-n">defaultContext</span></span></span></code></pre><p>This is a post context that gets built up and supplied to the template. Hakyll has <a href="https://github.com/jaspervdj/hakyll/blob/909e1b3a89b5b3ba5f64840d23ada9b3ac393404/lib/Hakyll/Web/Template/Context.hs#L295-L343">a special <code>dateField</code> helper</a> that parses a date from your post filename if it begins with a date. It also has <a href="https://github.com/jaspervdj/hakyll/blob/909e1b3a89b5b3ba5f64840d23ada9b3ac393404/lib/Hakyll/Web/Template/Context.hs#L231-L249"><code>defaultContext</code></a> which handles things like your post/web page‚Äôs body content.</p><p>What is significant about this example is that this is a place where you can pass in values at a global level; note that <code>constField</code> is including some of the personalization fields you filled out earlier. Passing those in the right context gives your templates access to them.</p><p>You can read more on this from jaspervdj, themself: <a href="https://jaspervdj.be/hakyll/tutorials/04-compilers.html" class="uri">https://jaspervdj.be/hakyll/tutorials/04-compilers.html</a></p><p>Before we wrap this section up, you should know that you can also add as many templates as you like, as well, and reference them in other templates using this format:</p><pre class="pl-chroma"><code><span class="pl-line"><span class="pl-cl"><span class="pl-c">&lt;!-- Inside templates/post.html...  --&gt;</span>
</span></span><span class="pl-line"><span class="pl-cl"><span class="pl-p">&lt;</span><span class="pl-nt">section</span> <span class="pl-na">class</span><span class="pl-o">=</span><span class="pl-s">"section-subscribe"</span><span class="pl-p">&gt;</span>
</span></span><span class="pl-line"><span class="pl-cl">  $partial("templates/subscribe.html")$
</span></span><span class="pl-line"><span class="pl-cl"><span class="pl-p">&lt;/</span><span class="pl-nt">section</span><span class="pl-p">&gt;</span></span></span></code></pre><h2 id="determining-what-static-files-are-copied-over">Determining what static files are copied over</h2><p>You will inevitably want to copy static files from your source code into your outputted build, and this is easily with hakyll‚Äôs <code>copyFileCompiler</code> in <code>ssg/src/Main.hs</code>, just inside the <code>main</code> function.</p><pre class="pl-chroma"><code><span class="pl-line"><span class="pl-cl"><span class="pl-nf">main</span> <span class="pl-ow">::</span> <span class="pl-kt">IO</span> <span class="pl-nb">()</span>
</span></span><span class="pl-line"><span class="pl-cl"><span class="pl-nf">main</span> <span class="pl-ow">=</span> <span class="pl-n">hakyllWith</span> <span class="pl-n">config</span> <span class="pl-o">$</span> <span class="pl-kr">do</span>
</span></span><span class="pl-line"><span class="pl-cl">  <span class="pl-n">forM_</span>
</span></span><span class="pl-line"><span class="pl-cl">    <span class="pl-p">[</span> <span class="pl-s">"CNAME"</span>
</span></span><span class="pl-line"><span class="pl-cl">    <span class="pl-p">,</span> <span class="pl-s">"favicon.ico"</span>
</span></span><span class="pl-line"><span class="pl-cl">    <span class="pl-p">,</span> <span class="pl-s">"robots.txt"</span>
</span></span><span class="pl-line"><span class="pl-cl">    <span class="pl-p">,</span> <span class="pl-s">"_config.yml"</span>
</span></span><span class="pl-line"><span class="pl-cl">    <span class="pl-p">,</span> <span class="pl-s">"images/*"</span>
</span></span><span class="pl-line"><span class="pl-cl">    <span class="pl-p">,</span> <span class="pl-s">"js/*"</span>
</span></span><span class="pl-line"><span class="pl-cl">    <span class="pl-p">,</span> <span class="pl-s">"fonts/*"</span>
</span></span><span class="pl-line"><span class="pl-cl">    <span class="pl-p">]</span>
</span></span><span class="pl-line"><span class="pl-cl">    <span class="pl-o">$</span> <span class="pl-nf">\</span><span class="pl-n">f</span> <span class="pl-ow">-&gt;</span> <span class="pl-n">match</span> <span class="pl-n">f</span> <span class="pl-o">$</span> <span class="pl-kr">do</span>
</span></span><span class="pl-line"><span class="pl-cl">      <span class="pl-n">route</span> <span class="pl-n">idRoute</span>
</span></span><span class="pl-line"><span class="pl-cl">      <span class="pl-n">compile</span> <span class="pl-n">copyFileCompiler</span></span></span></code></pre><p>Each file or folder glob here exists inside the <code>src/</code> directory. If you have something you want copied over to the build, this is the place to do it.</p><p>If you find you need to ignore a certain file or extension, consult the <code>ignoreFile'</code> function in the <code>config</code> and add your problematic file, prefix, or extension to the guard. For example, my macOS likes to add <code>.DS_Store</code> everywhere, so I did this:</p><pre class="pl-chroma"><code><span class="pl-line"><span class="pl-cl"><span class="pl-nf">ignoreFile'</span> <span class="pl-n">path</span>
</span></span><span class="pl-line"><span class="pl-cl">  <span class="pl-o">|</span> <span class="pl-s">".DS_Store"</span> <span class="pl-o">==</span> <span class="pl-n">fileName</span> <span class="pl-ow">=</span> <span class="pl-kt">True</span> <span class="pl-c1">-- this line</span>
</span></span><span class="pl-line"><span class="pl-cl">  <span class="pl-o">|</span> <span class="pl-s">"."</span>    <span class="pl-p">`</span><span class="pl-n">isPrefixOf</span><span class="pl-p">`</span> <span class="pl-n">fileName</span> <span class="pl-ow">=</span> <span class="pl-kt">False</span>
</span></span><span class="pl-line"><span class="pl-cl">  <span class="pl-o">|</span> <span class="pl-s">"#"</span>    <span class="pl-p">`</span><span class="pl-n">isPrefixOf</span><span class="pl-p">`</span> <span class="pl-n">fileName</span> <span class="pl-ow">=</span> <span class="pl-kt">True</span>
</span></span><span class="pl-line"><span class="pl-cl">  <span class="pl-o">|</span> <span class="pl-c1">-- ...</span></span></span></code></pre><h2 id="understanding-the-github-action-workflow">Understanding the GitHub action workflow</h2><p>There GitHub action workflow can be found in <code>.github/workflows/main.yml</code>. There are two jobs here: <code>build-nix</code> and <code>deploy</code>, and <code>deploy</code> only runs on the <code>main</code> branch.</p><h3 id="the-build-nix-job">The <code>build-nix</code> job</h3><p>This is the main job, and it does four things:</p><ol><li>Install nix</li><li>Setup the build to run with cachix</li><li>Run <code>nix-build</code></li><li>Temporarily upload the result of <code>nix-build</code> for use later (your website output)</li></ol><h3 id="the-deploy-job">The <code>deploy</code> job</h3><p>When code is pushed to the <code>main</code> branch, the <code>deploy</code> job will:</p><ol><li>Run the <code>build-nix</code> job</li><li>Download the temporarily uploaded website output</li><li>If the prior step succeeds, it will checkout the <code>gh-pages</code> branch and deploy your code to that branch</li></ol><h3 id="adding-your-cachix_auth_token">Adding your <code>CACHIX_AUTH_TOKEN</code></h3><p>You may have noticed a <code>{{ secrets.CACHIX_AUTH_TOKEN }}</code> used in this file. Here are the steps to setting this up:</p><ol><li>Follow the <a href="https://docs.cachix.org/getting-started">cachix getting started guide</a>, and get an auth token that is explicitly to be used for your GitHub workflow.</li><li>On your project GitHub page, click the <code>Settings</code> tab, then click on <code>Secrets and Variables</code>, then <code>Actions</code>, and add a repository secret called <code>CACHIX_AUTH_TOKEN</code> where you set that variable. At present, a direct link to this is <a href="https://github.com/youruser/yoursite.com/settings/secrets/actions" class="uri">https://github.com/youruser/yoursite.com/settings/secrets/actions</a></li></ol><h2 id="enabling-github-pages">Enabling GitHub Pages</h2><p>While you‚Äôre in the <code>Settings</code> tab, go to the <code>Pages</code> page, enable GitHub Pages, set the <code>Source</code> to <code>Deploy from a branch</code>, set that branch to <code>gh-pages</code>, and make sure the directory for that branch is <code>/ (root)</code>.</p><p><img alt="The GitHub Pages setup for this website" decoding="async" height="517" loading="lazy" src="./images/hnt-gh-pages.webp" width="600" /></p><h2 id="deploying-to-your-domain">Deploying to your domain</h2><p>Follow the <a href="https://docs.github.com/en/pages/configuring-a-custom-domain-for-your-github-pages-site/managing-a-custom-domain-for-your-github-pages-site">GitHub Pages custom domain guide</a> for heaps of info on how to deploy your site to your web domain.</p><h2 id="todos-for-hakyll-nix-template">TODOs for hakyll-nix-template</h2><h3 id="todo-caching-and-hashing">TODO: Caching and hashing</h3><p>When a CSS or JS file changes, we need a way to break browser caches to ensure they get the latest version. The way to do this is to generate a hash of that file‚Äôs contents, generate a file with that content hash in the filename when building, and then make sure any output that references that CSS or JS file reflects this updated filename, as well.</p><p>I have no idea how to do this yet, but I‚Äôll figure it out!</p><h3 id="todo-use-pygments-for-syntax-highlighting">TODO: Use pygments for syntax highlighting</h3><p>See <a href="https://tony-zorman.com/posts/2023-01-21-pygmentising-hakyll.html">Tony Zorman‚Äôs post on pygmentising hakyll</a> for details on some issues with the <a href="https://hackage.haskell.org/package/skylighting">skylighting library</a>. I‚Äôll likely follow this post in order to switch up the syntax highlighting to something better, or at least allow people to work with whatever they want.</p><h2 id="other-hakyll-posts">Other hakyll posts</h2><ul><li><a href="/hakyll-pt-1-setup-initial-customization.html">Pt. 1 ‚Äì Setup &amp; Initial Customization</a></li><li><a href="/hakyll-pt-2-generating-a-sitemap-xml-file.html">Pt. 2 ‚Äì Generating a Sitemap XML File</a></li><li><a href="/hakyll-pt-3-generating-rss-and-atom-xml-feeds.html">Pt. 3 ‚Äì Generating RSS and Atom XML Feeds</a></li><li><a href="/hakyll-pt-4-copying-static-files-for-your-build.html">Pt. 4 ‚Äì Copying Static Files For Your Build</a></li><li><a href="/hakyll-pt-5-generating-custom-post-filenames-from-a-title-slug.html">Pt. 5 ‚Äì Generating Custom Post Filenames From a Title Slug</a></li><li><a href="/hakyll-pt-6-pure-builds-with-nix.html">Pt. 6 ‚Äì Pure Builds With Nix</a></li></ul></section></main><footer><span aria-hidden="true" class="heart">‚ô•</span><span aria-hidden="true">&rarr;</span><a href="https://github.com/sponsors/rpearce/">Sponsor my work</a><span aria-hidden="true">&larr;</span><span aria-hidden="true" class="heart">‚ô•</span></footer><script async> (() => { const themeEl = document.querySelector('[data-select-theme]'); if (themeEl) { themeEl.querySelector('[value="'+window.site.prefTheme+'"]').selected = 'selected'; themeEl.addEventListener('change', e => { window.site.setTheme(e.target.value); }); } const fontEl = document.querySelector('[data-select-font]'); if (fontEl) { fontEl.querySelector('[value="'+window.site.prefFont+'"]').selected = 'selected'; fontEl.addEventListener('change', e => { window.site.setFont(e.target.value); }) } })(); </script></body></html>