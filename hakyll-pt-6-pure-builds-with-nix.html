<!DOCTYPE html><html lang="en"><head><title>Hakyll Pt. 6 â€“ Pure Builds With Nix</title><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="Learn how to make your hakyll project build pure and how to patch hakyll if you need to."><meta name="author" content="Robert Pearce"><meta name="keywords" content="hakyll, nix, nixos, nixpkgs, niv, hakyll tutorial, hakyll blog, hakyll blog tutorial, hakyll static site, static site generator"><meta name="google-site-verification" content="QX4bn65yOXBfgnwxlO09yIBc1H8blur-Erx3lmsDVhU"><meta http-equiv="origin-trial" content="Am4BZ0c7GMyB72dgo/Ny2FfIFscXhYMoN+CVe4jduWh24FvsaCwf7kjZzHzfrJXtIilyZVAEKRxOItGLY7lvkAgAAABSeyJvcmlnaW4iOiJodHRwczovL3JvYmVydHdwZWFyY2UuY29tOjQ0MyIsImZlYXR1cmUiOiJQb3J0YWxzIiwiZXhwaXJ5IjoxNjAzNTQ2NDc3fQ=="><meta property="og:site_name" content="Robert Pearce"><meta property="og:title" content="Hakyll Pt. 6 â€“ Pure Builds With Nix"><meta property="og:url" content="https://robertwpearce.com/hakyll-pt-6-pure-builds-with-nix.html"><meta property="og:description" content="Learn how to make your hakyll project build pure and how to patch hakyll if you need to."><meta property="og:type" content="article"><meta property="twitter:site" content="Robert Pearce"><meta property="twitter:title" content="Hakyll Pt. 6 â€“ Pure Builds With Nix"><meta property="twitter:description" content="Learn how to make your hakyll project build pure and how to patch hakyll if you need to."><meta property="twitter:creator" content="@RobertWPearce"><link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>ðŸ’¾</text></svg>"><link rel="canonical" href="https://robertwpearce.com/hakyll-pt-6-pure-builds-with-nix.html"><link rel="alternate" href="./atom.xml" title="Robert Pearce's blog" type="application/atom+xml"><link rel="alternate" href="./rss.xml" title="Robert Pearce's blog" type="application/rss+xml"><link rel="stylesheet" href="./css/base.css"><link rel="stylesheet" href="./css/t-clean.css"><link rel="stylesheet" href="./css/t-clean-note.css"><link rel="stylesheet" href="./css/t-code-dracula.css"><link rel="prefetch" href="./css/t-clean-note.css"></head><body data-theme="clean-night"><script> (() => { window.site = { prefFont: localStorage.getItem('prefFont') || 'monospace', setFont: (family) => { localStorage.setItem('prefFont', family); const rootStyle = document.querySelector(':root').style; rootStyle.setProperty('--type-family-body', family+',monospace'); /* Remove when https://github.com/googlefonts/spacemono/pull/2 is resolved */ if (family === 'Liga Space Mono') { rootStyle.setProperty('font-feature-settings', '"liga" 0'); } else { rootStyle.removeProperty('font-feature-settings'); } return window.site._fetchFont(family); }, prefTheme: localStorage.getItem('prefTheme') || (matchMedia('(prefers-color-scheme: dark)').matches ? 'clean-night' : 'clean-day'), setTheme: (name) => { const rootStyle = document.querySelector(':root').style; if (name === 'clean-night') { rootStyle.removeProperty('color-scheme'); } else { rootStyle.setProperty('color-scheme', 'light'); } document.body.setAttribute('data-theme', name); localStorage.setItem('prefTheme', name); }, _fetchFont: (family) => { if (family === 'monospace') { return Promise.resolve(); } const familyNoSpaces = family.replaceAll(' ', ''); const fontz = [ new FontFace(family, 'url("./fonts/'+familyNoSpaces+'-Regular.woff2") format("woff2")', { display: 'swap', weight: 400 }), new FontFace(family, 'url("./fonts/'+familyNoSpaces+'-Bold.woff2") format("woff2")', { display: 'swap', weight: 700 }), ]; if (family !== 'Fira Code') { fontz.push( new FontFace(family, 'url("./fonts/'+familyNoSpaces+'-Italic.woff2") format("woff2")', { display: 'swap', style: 'italic', weight: 400 }), new FontFace(family, 'url("./fonts/'+familyNoSpaces+'-BoldItalic.woff2") format("woff2")', { display: 'swap', style: 'italic', weight: 700 }) ); } for (const f of fontz) { document.fonts.add(f); } return Promise.allSettled(fontz).then(results => { results.forEach((res, i) => { if (res.status === 'rejected') { console.error('site failed to load font: ' + fontz[i]?.family ?? 'unknown'); } }); }); } }; window.site.setTheme(window.site.prefTheme); window.site.setFont(window.site.prefFont); })(); </script><header><nav><div class="nav-skip"><a href="#content">Skip to content</a></div><a aria-label="Home" class="nav-home" href="./">~</a><span>/</span></nav><div class="header-extra"><a href="./atom.xml">RSS</a><span aria-hidden="true">&compfn;</span><noscript>(requires JS &rarr;)</noscript><label for="select-theme">Theme</label><select data-select-theme id="select-theme"><option value="clean-day">Clean (Day)</option><option value="clean-night">Clean (Night)</option></select><span aria-hidden="true">&compfn;</span><label for="select-font">Font</label><select data-select-font id="select-font"><option value="monospace">monospace</option><option value="Liga Space Mono">Space Mono</option><option value="Victor Mono">Victor Mono</option><option value="Fira Code">Fira Code</option><option value="JetBrains Mono">JetBrains Mono</option></select></div></header><main id="content"><header data-area="heading"><h1>Hakyll Pt. 6 â€“ Pure Builds With Nix</h1></header><section data-area="meta"><h2>Info</h2><table data-type="cols-y"><tbody><tr><th>Summary</th><td>Learn how to make your hakyll project build pure and how to patch hakyll if you need to.</td></tr><tr><th>Shared</th><td>2020-04-30</td></tr><tr><th>Revised</th><td>2023-01-30 @ 23:00 UTC</td></tr></tbody></table></section><section data-area="note"><p><em>Special thanks to <a href="https://github.com/utdemir/">Utku Demir</a> for review and constant inspiration.</em></p><p>This is part 6 of a multipart series where we will look at getting a website / blog set up with <a href="https://jaspervdj.be/hakyll">hakyll</a> and customized a fair bit.</p><ul><li><a href="/hakyll-pt-1-setup-initial-customization.html">Pt. 1 â€“ Setup &amp; Initial Customization</a></li><li><a href="/hakyll-pt-2-generating-a-sitemap-xml-file.html">Pt. 2 â€“ Generating a Sitemap XML File</a></li><li><a href="/hakyll-pt-3-generating-rss-and-atom-xml-feeds.html">Pt. 3 â€“ Generating RSS and Atom XML Feeds</a></li><li><a href="/hakyll-pt-4-copying-static-files-for-your-build.html">Pt. 4 â€“ Copying Static Files For Your Build</a></li><li><a href="/hakyll-pt-5-generating-custom-post-filenames-from-a-title-slug.html">Pt. 5 â€“ Generating Custom Post Filenames From a Title Slug</a></li><li>Pt. 6 â€“ Pure Builds With Nix</li><li><a href="/the-hakyll-nix-template-tutorial.html">The hakyll-nix-template Tutorial</a></li></ul><h2 id="overview">Overview</h2><p>In this post weâ€™re going to create a new hakyll site from scratch with a caveat: we will do just about everything with <a href="https://nixos.org">nix</a> in order to guarantee reproducibility for anyone (or anything) using our project. There are also two bonuses that we will inherit simply because we are using nix: * we will not need to rely on global package installs (apart from nix, of course) * we will be able to easily patch any package problems; for example, if some of hakyllâ€™s dependencies are not available in nixpkgs, we can patch hakyll to get it to work.</p><p>Here is the example repository with what weâ€™re going to make: <a href="https://github.com/rpearce/hakyll-nix-example" class="uri">https://github.com/rpearce/hakyll-nix-example</a></p><p><em>Note: this post assumes that you have installed nix on your system.</em></p><h2 id="steps-to-build-our-hakyll-project-with-nix">Steps to Build Our Hakyll Project With Nix</h2><p>Make a new project with <code>release.nix</code>, <code>default.nix</code>, and <code>shell.nix</code>, and get into its pure nix shell environment:</p><pre class="pl-chroma"><code><span class="pl-line"><span class="pl-cl">Î» mkdir hakyll-nix-example &amp;&amp; cd $_
</span></span><span class="pl-line"><span class="pl-cl">Î» echo "{ }: let in { }" &gt; release.nix
</span></span><span class="pl-line"><span class="pl-cl">Î» echo "(import ./release.nix { }).project" &gt; default.nix
</span></span><span class="pl-line"><span class="pl-cl">Î» echo "(import ./release.nix { }).shell" &gt; shell.nix
</span></span><span class="pl-line"><span class="pl-cl">Î» nix-shell --pure -p niv nix cacert</span></span></code></pre><p>We wonâ€™t have to touch <code>default.nix</code> nor <code>shell.nix</code> again, for we are delegating their responsibilities to the <code>release.nix</code> file that weâ€™ll add more to in a moment.</p><p><em>Note: we require <code>nix</code> and <code>cacert</code> when running a pure <code>nix-shell</code> with <code>niv</code> because of an issue (<a href="https://github.com/nmattia/niv/issues/222" class="uri">https://github.com/nmattia/niv/issues/222</a>).</em></p><p>Now that weâ€™re in the nix shell, initialize <a href="https://github.com/nmattia/niv"><code>niv</code></a> and specify your nixpkgs owner, repository, and branch to be whatever you want:</p><pre class="pl-chroma"><code><span class="pl-line"><span class="pl-cl">[nix-shell:~/projects/hakyll-nix-example]$ niv init
</span></span><span class="pl-line"><span class="pl-cl">[nix-shell:~/projects/hakyll-nix-example]$ niv update nixpkgs -o NixOS -r nixpkgs-channels -b nixpkgs-unstable
</span></span><span class="pl-line"><span class="pl-cl">[nix-shell:~/projects/hakyll-nix-example]$ exit</span></span></code></pre><p>Update your <code>release.nix</code> file with the following:</p><pre class="pl-chroma"><code><span class="pl-line"><span class="pl-cl"><span class="pl-k">let</span>
</span></span><span class="pl-line"><span class="pl-cl">  <span class="pl-n">sources</span> <span class="pl-o">=</span> <span class="pl-kn">import</span> <span class="pl-sr">./nix/sources.nix</span><span class="pl-p">;</span>
</span></span><span class="pl-line"><span class="pl-cl"><span class="pl-k">in</span>
</span></span><span class="pl-line"><span class="pl-cl"><span class="pl-p">{</span> <span class="pl-n">compiler</span> <span class="pl-o">?</span> <span class="pl-s2">"ghc883"</span>
</span></span><span class="pl-line"><span class="pl-cl"><span class="pl-o">,</span> <span class="pl-n">pkgs</span> <span class="pl-o">?</span> <span class="pl-kn">import</span> <span class="pl-n">sources</span><span class="pl-o">.</span><span class="pl-n">nixpkgs</span> <span class="pl-p">{</span> <span class="pl-p">}</span>
</span></span><span class="pl-line"><span class="pl-cl"><span class="pl-p">}:</span>
</span></span><span class="pl-line"><span class="pl-cl">
</span></span><span class="pl-line"><span class="pl-cl"><span class="pl-k">let</span>
</span></span><span class="pl-line"><span class="pl-cl">  <span class="pl-k">inherit</span> <span class="pl-p">(</span><span class="pl-n">pkgs</span><span class="pl-o">.</span><span class="pl-n">lib</span><span class="pl-o">.</span><span class="pl-n">trivial</span><span class="pl-p">)</span> <span class="pl-n">flip</span> <span class="pl-n">pipe</span><span class="pl-p">;</span>
</span></span><span class="pl-line"><span class="pl-cl">  <span class="pl-k">inherit</span> <span class="pl-p">(</span><span class="pl-n">pkgs</span><span class="pl-o">.</span><span class="pl-n">haskell</span><span class="pl-o">.</span><span class="pl-n">lib</span><span class="pl-p">)</span> <span class="pl-n">appendPatch</span> <span class="pl-n">appendConfigureFlags</span><span class="pl-p">;</span>
</span></span><span class="pl-line"><span class="pl-cl">
</span></span><span class="pl-line"><span class="pl-cl">  <span class="pl-n">haskellPackages</span> <span class="pl-o">=</span> <span class="pl-n">pkgs</span><span class="pl-o">.</span><span class="pl-n">haskell</span><span class="pl-o">.</span><span class="pl-n">packages</span><span class="pl-o">.</span><span class="pl-si">${</span><span class="pl-n">compiler</span><span class="pl-si">}</span><span class="pl-o">.</span><span class="pl-n">override</span> <span class="pl-p">{</span>
</span></span><span class="pl-line"><span class="pl-cl">    <span class="pl-n">overrides</span> <span class="pl-o">=</span> <span class="pl-n">hpNew</span><span class="pl-p">:</span> <span class="pl-n">hpOld</span><span class="pl-p">:</span> <span class="pl-p">{</span>
</span></span><span class="pl-line"><span class="pl-cl">      <span class="pl-n">hakyll</span> <span class="pl-o">=</span>
</span></span><span class="pl-line"><span class="pl-cl">        <span class="pl-n">pipe</span>
</span></span><span class="pl-line"><span class="pl-cl">           <span class="pl-n">hpOld</span><span class="pl-o">.</span><span class="pl-n">hakyll</span>
</span></span><span class="pl-line"><span class="pl-cl">           <span class="pl-p">[</span> <span class="pl-p">(</span><span class="pl-n">flip</span> <span class="pl-n">appendPatch</span> <span class="pl-sr">./hakyll.patch</span><span class="pl-p">)</span>
</span></span><span class="pl-line"><span class="pl-cl">             <span class="pl-p">(</span><span class="pl-n">flip</span> <span class="pl-n">appendConfigureFlags</span> <span class="pl-p">[</span> <span class="pl-s2">"-f"</span> <span class="pl-s2">"watchServer"</span> <span class="pl-s2">"-f"</span> <span class="pl-s2">"previewServer"</span> <span class="pl-p">])</span>
</span></span><span class="pl-line"><span class="pl-cl">           <span class="pl-p">];</span>
</span></span><span class="pl-line"><span class="pl-cl">
</span></span><span class="pl-line"><span class="pl-cl">      <span class="pl-n">hakyll-nix-example</span> <span class="pl-o">=</span> <span class="pl-n">hpNew</span><span class="pl-o">.</span><span class="pl-n">callCabal2nix</span> <span class="pl-s2">"hakyll-nix-example"</span> <span class="pl-sr">./.</span> <span class="pl-p">{</span> <span class="pl-p">};</span>
</span></span><span class="pl-line"><span class="pl-cl">
</span></span><span class="pl-line"><span class="pl-cl">      <span class="pl-n">niv</span> <span class="pl-o">=</span> <span class="pl-kn">import</span> <span class="pl-n">sources</span><span class="pl-o">.</span><span class="pl-n">niv</span> <span class="pl-p">{</span> <span class="pl-p">};</span>
</span></span><span class="pl-line"><span class="pl-cl">    <span class="pl-p">};</span>
</span></span><span class="pl-line"><span class="pl-cl">  <span class="pl-p">};</span>
</span></span><span class="pl-line"><span class="pl-cl">
</span></span><span class="pl-line"><span class="pl-cl">  <span class="pl-n">project</span> <span class="pl-o">=</span> <span class="pl-n">haskellPackages</span><span class="pl-o">.</span><span class="pl-n">hakyll-nix-example</span><span class="pl-p">;</span>
</span></span><span class="pl-line"><span class="pl-cl"><span class="pl-k">in</span>
</span></span><span class="pl-line"><span class="pl-cl"><span class="pl-p">{</span>
</span></span><span class="pl-line"><span class="pl-cl">  <span class="pl-n">project</span> <span class="pl-o">=</span> <span class="pl-n">project</span><span class="pl-p">;</span>
</span></span><span class="pl-line"><span class="pl-cl">
</span></span><span class="pl-line"><span class="pl-cl">  <span class="pl-n">shell</span> <span class="pl-o">=</span> <span class="pl-n">haskellPackages</span><span class="pl-o">.</span><span class="pl-n">shellFor</span> <span class="pl-p">{</span>
</span></span><span class="pl-line"><span class="pl-cl">    <span class="pl-n">packages</span> <span class="pl-o">=</span> <span class="pl-n">p</span><span class="pl-p">:</span> <span class="pl-k">with</span> <span class="pl-n">p</span><span class="pl-p">;</span> <span class="pl-p">[</span>
</span></span><span class="pl-line"><span class="pl-cl">      <span class="pl-n">project</span>
</span></span><span class="pl-line"><span class="pl-cl">    <span class="pl-p">];</span>
</span></span><span class="pl-line"><span class="pl-cl">    <span class="pl-n">buildInputs</span> <span class="pl-o">=</span> <span class="pl-k">with</span> <span class="pl-n">haskellPackages</span><span class="pl-p">;</span> <span class="pl-p">[</span>
</span></span><span class="pl-line"><span class="pl-cl">      <span class="pl-n">ghcid</span>
</span></span><span class="pl-line"><span class="pl-cl">      <span class="pl-n">hlint</span>       <span class="pl-c1"># or ormolu</span>
</span></span><span class="pl-line"><span class="pl-cl">      <span class="pl-n">niv</span>
</span></span><span class="pl-line"><span class="pl-cl">      <span class="pl-n">pkgs</span><span class="pl-o">.</span><span class="pl-n">cacert</span> <span class="pl-c1"># needed for niv</span>
</span></span><span class="pl-line"><span class="pl-cl">      <span class="pl-n">pkgs</span><span class="pl-o">.</span><span class="pl-n">nix</span>    <span class="pl-c1"># needed for niv</span>
</span></span><span class="pl-line"><span class="pl-cl">    <span class="pl-p">];</span>
</span></span><span class="pl-line"><span class="pl-cl">    <span class="pl-n">withHoogle</span> <span class="pl-o">=</span> <span class="pl-no">true</span><span class="pl-p">;</span>
</span></span><span class="pl-line"><span class="pl-cl">  <span class="pl-p">};</span>
</span></span><span class="pl-line"><span class="pl-cl"><span class="pl-p">}</span></span></span></code></pre><p>Donâ€™t worry, weâ€™ll circle back to what we just did.</p><p>Create a <code>hakyll.patch</code> diff file:</p><pre class="pl-chroma"><code><span class="pl-line"><span class="pl-cl">Î» touch hakyll.patch</span></span></code></pre><p>Bootstrap the hakyll project (we wonâ€™t ever need this again):</p><pre class="pl-chroma"><code><span class="pl-line"><span class="pl-cl">Î» nix-shell --pure -p haskellPackages.hakyll --run "hakyll-init ."</span></span></code></pre><p>Build the project and <code>--show-trace</code> just in case something goes wrong:</p><pre class="pl-chroma"><code><span class="pl-line"><span class="pl-cl">Î» nix-build --show-trace</span></span></code></pre><p>Run the local dev server:</p><pre class="pl-chroma"><code><span class="pl-line"><span class="pl-cl">Î» ./result/bin/site watch</span></span></code></pre><p>Navigate to <a href="http://localhost:8000" class="uri">http://localhost:8000</a> and see your local dev site up and running!</p><h2 id="understanding-the-releasenix-file">Understanding the <code>release.nix</code> File</h2><p>Letâ€™s break down what we copied and pasted into <code>release.nix</code>.</p><pre class="pl-chroma"><code><span class="pl-line"><span class="pl-cl"><span class="pl-k">let</span>
</span></span><span class="pl-line"><span class="pl-cl">  <span class="pl-n">sources</span> <span class="pl-o">=</span> <span class="pl-kn">import</span> <span class="pl-sr">./nix/sources.nix</span><span class="pl-p">;</span>
</span></span><span class="pl-line"><span class="pl-cl"><span class="pl-k">in</span>
</span></span><span class="pl-line"><span class="pl-cl"><span class="pl-p">{</span> <span class="pl-n">compiler</span> <span class="pl-o">?</span> <span class="pl-s2">"ghc883"</span>
</span></span><span class="pl-line"><span class="pl-cl"><span class="pl-o">,</span> <span class="pl-n">pkgs</span> <span class="pl-o">?</span> <span class="pl-kn">import</span> <span class="pl-n">sources</span><span class="pl-o">.</span><span class="pl-n">nixpkgs</span> <span class="pl-p">{</span> <span class="pl-p">}</span>
</span></span><span class="pl-line"><span class="pl-cl"><span class="pl-p">}:</span>
</span></span><span class="pl-line"><span class="pl-cl">
</span></span><span class="pl-line"><span class="pl-cl"><span class="pl-c1"># ...</span></span></span></code></pre><p>The <code>let</code> gives us the space to define an attribute (variable), and it is here that we import our <code>sources.nix</code> file that was generated by <code>niv</code>. The <code>in</code> block defines a function parameter with two attributes, <code>compiler</code> and <code>sources</code>, that each have defaults (when thereâ€™s a <code>:</code>, that means what comes next is a function body or another function argument). For the <code>compiler</code>, we will use this version to compile all of the Haskell packages that we interact with. For the <code>pkgs</code>, we default to using our pinned version of <code>nixpkgs</code>, but this is overridable.</p><pre class="pl-chroma"><code><span class="pl-line"><span class="pl-cl"><span class="pl-c1"># ...</span>
</span></span><span class="pl-line"><span class="pl-cl">
</span></span><span class="pl-line"><span class="pl-cl"><span class="pl-k">let</span>
</span></span><span class="pl-line"><span class="pl-cl">  <span class="pl-k">inherit</span> <span class="pl-p">(</span><span class="pl-n">pkgs</span><span class="pl-o">.</span><span class="pl-n">lib</span><span class="pl-o">.</span><span class="pl-n">trivial</span><span class="pl-p">)</span> <span class="pl-n">flip</span> <span class="pl-n">pipe</span><span class="pl-p">;</span>
</span></span><span class="pl-line"><span class="pl-cl">  <span class="pl-k">inherit</span> <span class="pl-p">(</span><span class="pl-n">pkgs</span><span class="pl-o">.</span><span class="pl-n">haskell</span><span class="pl-o">.</span><span class="pl-n">lib</span><span class="pl-p">)</span> <span class="pl-n">appendPatch</span> <span class="pl-n">appendConfigureFlags</span><span class="pl-p">;</span>
</span></span><span class="pl-line"><span class="pl-cl">
</span></span><span class="pl-line"><span class="pl-cl">  <span class="pl-c1"># ...</span></span></span></code></pre><p>Our new <code>let</code> falls within the function we created above, and we then state that we would like to inherit some nice functions from <a href="https://github.com/NixOS/nixpkgs/blob/master/lib/trivial.nix"><code>pkgs.lib.trivial</code></a> and <a href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/development/haskell-modules/lib.nix"><code>pkgs.haskell.lib</code></a>. The <code>flip</code> and <code>pipe</code> functions are standards in functional programming, but Iâ€™ll share a short recap: * <a href="https://github.com/NixOS/nixpkgs/blob/3a1e8bdcd9a9e13ccd3f298bf598acc8b35caa4d/lib/trivial.nix#L130-L138"><code>flip</code></a> takes a function <code>a -&gt; b -&gt; c</code> and flips the accepted arguments to act like <code>b -&gt; a -&gt; c</code>. Its definition is <code>flip = f: a: b: f b a;</code> â€“ it takes a function, then <code>a</code>, then <code>b</code>, and then it applies <code>a</code> and <code>b</code> in reversed (flipped) order. * <a href="https://github.com/NixOS/nixpkgs/blob/3a1e8bdcd9a9e13ccd3f298bf598acc8b35caa4d/lib/trivial.nix#L32-L63"><code>pipe</code></a> establishes a set of functions that you can apply data to, one after the other. Think of bash pipes: <code>cat blog_post.txt | grep nix</code>.</p><pre class="pl-chroma"><code><span class="pl-line"><span class="pl-cl"><span class="pl-k">let</span>
</span></span><span class="pl-line"><span class="pl-cl">  <span class="pl-c1"># ...</span>
</span></span><span class="pl-line"><span class="pl-cl">
</span></span><span class="pl-line"><span class="pl-cl">  <span class="pl-n">haskellPackages</span> <span class="pl-o">=</span> <span class="pl-n">pkgs</span><span class="pl-o">.</span><span class="pl-n">haskell</span><span class="pl-o">.</span><span class="pl-n">packages</span><span class="pl-o">.</span><span class="pl-si">${</span><span class="pl-n">compiler</span><span class="pl-si">}</span><span class="pl-o">.</span><span class="pl-n">override</span> <span class="pl-p">{</span>
</span></span><span class="pl-line"><span class="pl-cl">    <span class="pl-n">overrides</span> <span class="pl-o">=</span> <span class="pl-n">hpNew</span><span class="pl-p">:</span> <span class="pl-n">hpOld</span><span class="pl-p">:</span> <span class="pl-p">{</span>
</span></span><span class="pl-line"><span class="pl-cl">      <span class="pl-n">hakyll</span> <span class="pl-o">=</span>
</span></span><span class="pl-line"><span class="pl-cl">        <span class="pl-n">pipe</span>
</span></span><span class="pl-line"><span class="pl-cl">           <span class="pl-n">hpOld</span><span class="pl-o">.</span><span class="pl-n">hakyll</span>
</span></span><span class="pl-line"><span class="pl-cl">           <span class="pl-p">[</span> <span class="pl-p">(</span><span class="pl-n">flip</span> <span class="pl-n">appendPatch</span> <span class="pl-sr">./hakyll.patch</span><span class="pl-p">)</span>
</span></span><span class="pl-line"><span class="pl-cl">             <span class="pl-p">(</span><span class="pl-n">flip</span> <span class="pl-n">appendConfigureFlags</span> <span class="pl-p">[</span> <span class="pl-s2">"-f"</span> <span class="pl-s2">"watchServer"</span> <span class="pl-s2">"-f"</span> <span class="pl-s2">"previewServer"</span> <span class="pl-p">])</span>
</span></span><span class="pl-line"><span class="pl-cl">           <span class="pl-p">];</span>
</span></span><span class="pl-line"><span class="pl-cl">
</span></span><span class="pl-line"><span class="pl-cl">      <span class="pl-n">hakyll-nix-example</span> <span class="pl-o">=</span> <span class="pl-n">hpNew</span><span class="pl-o">.</span><span class="pl-n">callCabal2nix</span> <span class="pl-s2">"hakyll-nix-example"</span> <span class="pl-sr">./.</span> <span class="pl-p">{</span> <span class="pl-p">};</span>
</span></span><span class="pl-line"><span class="pl-cl">
</span></span><span class="pl-line"><span class="pl-cl">      <span class="pl-n">niv</span> <span class="pl-o">=</span> <span class="pl-kn">import</span> <span class="pl-n">sources</span><span class="pl-o">.</span><span class="pl-n">niv</span> <span class="pl-p">{</span> <span class="pl-p">};</span>
</span></span><span class="pl-line"><span class="pl-cl">    <span class="pl-p">};</span>
</span></span><span class="pl-line"><span class="pl-cl">  <span class="pl-p">};</span>
</span></span><span class="pl-line"><span class="pl-cl">
</span></span><span class="pl-line"><span class="pl-cl">  <span class="pl-c1"># ...</span></span></span></code></pre><p>This uses our pinned (or overridden) <code>nixpkgs</code> to create our own <code>haskellPackages</code> for a specific Haskell <code>compiler</code> version.</p><p>For <code>hakyll</code>, we need to make sure it gets compiled with the <code>watchServer</code> and <code>previewServer</code> flags, or we wonâ€™t be able to use its local dev server. We also provide an optional patch file (<code>git diff &gt; hakyll.patch</code> file) that we can build <code>hakyll</code> with if there are any changes to the project that we need to make. Patch files can be empty when no patches are required, but if you do need to patch something, here is an example <code>hakyll.patch</code> file:</p><pre class="pl-chroma"><code><span class="pl-line"><span class="pl-cl"><span class="pl-gh">diff --git a/hakyll.cabal b/hakyll.cabal
</span></span></span><span class="pl-line"><span class="pl-cl"><span class="pl-gh">index fcded8d..9746f20 100644
</span></span></span><span class="pl-line"><span class="pl-cl"><span class="pl-gh"></span><span class="pl-gd">--- a/hakyll.cabal
</span></span></span><span class="pl-line"><span class="pl-cl"><span class="pl-gd"></span><span class="pl-gi">+++ b/hakyll.cabal
</span></span></span><span class="pl-line"><span class="pl-cl"><span class="pl-gi"></span><span class="pl-gu">@@ -199,7 +199,7 @@ Library
</span></span></span><span class="pl-line"><span class="pl-cl"><span class="pl-gu"></span>   If flag(previewServer)
</span></span><span class="pl-line"><span class="pl-cl">     Build-depends:
</span></span><span class="pl-line"><span class="pl-cl">       wai             &gt;= 3.2   &amp;&amp; &lt; 3.3,
</span></span><span class="pl-line"><span class="pl-cl"><span class="pl-gd">-      warp            &gt;= 3.2   &amp;&amp; &lt; 3.3,
</span></span></span><span class="pl-line"><span class="pl-cl"><span class="pl-gd"></span><span class="pl-gi">+      warp,
</span></span></span><span class="pl-line"><span class="pl-cl"><span class="pl-gi"></span>       wai-app-static  &gt;= 3.1   &amp;&amp; &lt; 3.2,
</span></span><span class="pl-line"><span class="pl-cl">       http-types      &gt;= 0.9   &amp;&amp; &lt; 0.13,
</span></span><span class="pl-line"><span class="pl-cl">       fsnotify        &gt;= 0.2   &amp;&amp; &lt; 0.4
</span></span></code></pre><p>The <code>hakyll-nix-example</code> attribute is specifically for our Haskell project in order for us to be sure our project is compiled with our desired compiler version. We leverage the <code>callCabal2nix</code> tool to handle automatically converting our <code>hakyll-nix-example.cabal</code> file into a <code>nix</code> derivation for our build.</p><p>Lastly, we ensure that the <code>niv</code> we are using in the <code>nix-shell</code> is our pinned <code>niv</code> that <code>niv</code> itself generated.</p><pre class="pl-chroma"><code><span class="pl-line"><span class="pl-cl"><span class="pl-k">let</span>
</span></span><span class="pl-line"><span class="pl-cl">  <span class="pl-c1"># ...</span>
</span></span><span class="pl-line"><span class="pl-cl">
</span></span><span class="pl-line"><span class="pl-cl">  <span class="pl-n">project</span> <span class="pl-o">=</span> <span class="pl-n">haskellPackages</span><span class="pl-o">.</span><span class="pl-n">hakyll-nix-example</span><span class="pl-p">;</span>
</span></span><span class="pl-line"><span class="pl-cl"><span class="pl-k">in</span>
</span></span><span class="pl-line"><span class="pl-cl"><span class="pl-p">{</span>
</span></span><span class="pl-line"><span class="pl-cl">  <span class="pl-n">project</span> <span class="pl-o">=</span> <span class="pl-n">project</span><span class="pl-p">;</span>
</span></span><span class="pl-line"><span class="pl-cl">
</span></span><span class="pl-line"><span class="pl-cl">  <span class="pl-c1"># ...</span></span></span></code></pre><p>The <code>project</code> attribute is what our <code>default.nix</code> will use when being called with tools like <code>nix-build</code>. All we do is access our <code>hakyll-nix-example</code> attribute from our customized <code>haskellPackages</code>.</p><pre class="pl-chroma"><code><span class="pl-line"><span class="pl-cl"><span class="pl-k">let</span>
</span></span><span class="pl-line"><span class="pl-cl">  <span class="pl-c1"># ...</span>
</span></span><span class="pl-line"><span class="pl-cl"><span class="pl-k">in</span> <span class="pl-p">{</span>
</span></span><span class="pl-line"><span class="pl-cl">  <span class="pl-c1"># ...</span>
</span></span><span class="pl-line"><span class="pl-cl">
</span></span><span class="pl-line"><span class="pl-cl">  <span class="pl-n">shell</span> <span class="pl-o">=</span> <span class="pl-n">haskellPackages</span><span class="pl-o">.</span><span class="pl-n">shellFor</span> <span class="pl-p">{</span>
</span></span><span class="pl-line"><span class="pl-cl">    <span class="pl-n">packages</span> <span class="pl-o">=</span> <span class="pl-n">p</span><span class="pl-p">:</span> <span class="pl-k">with</span> <span class="pl-n">p</span><span class="pl-p">;</span> <span class="pl-p">[</span>
</span></span><span class="pl-line"><span class="pl-cl">      <span class="pl-n">project</span>
</span></span><span class="pl-line"><span class="pl-cl">    <span class="pl-p">];</span>
</span></span><span class="pl-line"><span class="pl-cl">    <span class="pl-n">buildInputs</span> <span class="pl-o">=</span> <span class="pl-k">with</span> <span class="pl-n">haskellPackages</span><span class="pl-p">;</span> <span class="pl-p">[</span>
</span></span><span class="pl-line"><span class="pl-cl">      <span class="pl-n">ghcid</span>
</span></span><span class="pl-line"><span class="pl-cl">      <span class="pl-n">hlint</span>       <span class="pl-c1"># or ormolu</span>
</span></span><span class="pl-line"><span class="pl-cl">      <span class="pl-n">niv</span>
</span></span><span class="pl-line"><span class="pl-cl">      <span class="pl-n">pkgs</span><span class="pl-o">.</span><span class="pl-n">cacert</span> <span class="pl-c1"># needed for niv</span>
</span></span><span class="pl-line"><span class="pl-cl">      <span class="pl-n">pkgs</span><span class="pl-o">.</span><span class="pl-n">nix</span>    <span class="pl-c1"># needed for niv</span>
</span></span><span class="pl-line"><span class="pl-cl">    <span class="pl-p">];</span>
</span></span><span class="pl-line"><span class="pl-cl">    <span class="pl-n">withHoogle</span> <span class="pl-o">=</span> <span class="pl-no">true</span><span class="pl-p">;</span>
</span></span><span class="pl-line"><span class="pl-cl">  <span class="pl-p">};</span>
</span></span><span class="pl-line"><span class="pl-cl"><span class="pl-p">}</span></span></span></code></pre><p>Exactly like <code>default.nix</code> uses the <code>project</code> attribute, <code>shell.nix</code> is looking for a <code>shell</code> attribute to define everything it needs when running <code>nix-shell --pure</code>. We use <code>shellFor</code>, which comes with the <code>nixpkgs</code> Haskell tools, and we provide it a few attributes: * the <code>packages</code> attribute holds our <code>project</code> package and any other <code>nixpkgs</code> that you would like to have built when entering the shell * the <code>buildInputs</code> attribute holds all the tools that weâ€™ll have available to us while weâ€™re in the shell; for example, you can run <code>ghcid</code> and load your Haskell code to test it out or run <code>hlint</code> to lint your Haskell files * <code>withHoogle</code> gives us the ability to query <a href="https://hoogle.haskell.org" class="uri">https://hoogle.haskell.org</a></p><h2 id="wrapping-up">Wrapping Up</h2><p>Using nix to build our project helps make development consistent and predictable; however, learning nix is not necessarily a breeze. The following articles directly contributed to my understanding that led to this post:</p><ul><li><a href="https://nixos.org/nixos/nix-pills/index.html" class="uri">https://nixos.org/nixos/nix-pills/index.html</a></li><li><a href="https://github.com/Gabriel439/haskell-nix/tree/master/project4" class="uri">https://github.com/Gabriel439/haskell-nix/tree/master/project4</a></li><li><a href="https://turbomack.github.io/posts/2020-02-17-cabal-flags-and-nix.html" class="uri">https://turbomack.github.io/posts/2020-02-17-cabal-flags-and-nix.html</a> (this article is what led me to learn how to patch hakyll)</li><li><code>overrideAttrs</code>: <a href="https://nixos.org/nixpkgs/manual/#sec-pkg-overrideAttrs" class="uri">https://nixos.org/nixpkgs/manual/#sec-pkg-overrideAttrs</a></li><li><code>overlays</code>: <a href="https://nixos.org/nixpkgs/manual/#chap-overlays" class="uri">https://nixos.org/nixpkgs/manual/#chap-overlays</a></li><li><a href="https://maybevoid.com/posts/2019-01-27-getting-started-haskell-nix.html" class="uri">https://maybevoid.com/posts/2019-01-27-getting-started-haskell-nix.html</a></li><li><a href="https://kuznero.com/post/linux/haskell-project-structure-in-nixos/" class="uri">https://kuznero.com/post/linux/haskell-project-structure-in-nixos/</a></li><li><a href="https://github.com/NixOS/nixpkgs/blob/master/doc/languages-frameworks/haskell.section.md" class="uri">https://github.com/NixOS/nixpkgs/blob/master/doc/languages-frameworks/haskell.section.md</a></li><li><a href="https://nixos.org/nixpkgs/manual/#haskell" class="uri">https://nixos.org/nixpkgs/manual/#haskell</a></li></ul><hr /><p>Thank you for reading! <br /> Robert</p></section></main><footer><span aria-hidden="true" class="heart">â™¥</span><span aria-hidden="true">&rarr;</span><a href="https://github.com/sponsors/rpearce/">Sponsor my work</a><span aria-hidden="true">&larr;</span><span aria-hidden="true" class="heart">â™¥</span></footer><script async> (() => { const themeEl = document.querySelector('[data-select-theme]'); if (themeEl) { themeEl.querySelector('[value="'+window.site.prefTheme+'"]').selected = 'selected'; themeEl.addEventListener('change', e => { window.site.setTheme(e.target.value); }); } const fontEl = document.querySelector('[data-select-font]'); if (fontEl) { fontEl.querySelector('[value="'+window.site.prefFont+'"]').selected = 'selected'; fontEl.addEventListener('change', e => { window.site.setFont(e.target.value); }) } })(); </script></body></html>