<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Hakyll Pt. 6 – Pure Builds With Nix</title>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Learn how to make your hakyll project build pure and how to patch hakyll if you need to">
    <meta name="author" content="Robert Pearce">
    <meta name="keywords" content="hakyll, nix, nixos, nixpkgs, niv, hakyll tutorial, hakyll blog, hakyll blog tutorial, hakyll static site, static site generator">
    <meta name="google-site-verification" content="QX4bn65yOXBfgnwxlO09yIBc1H8blur-Erx3lmsDVhU">

    <meta property="og:site_name" content="Robert Pearce | Senior Software Developer">
    <meta property="og:title" content="Hakyll Pt. 6 – Pure Builds With Nix">
    <meta property="og:url" content="https://robertwpearce.com/hakyll-pt-6-pure-builds-with-nix.html">
    <meta property="og:description" content="Learn how to make your hakyll project build pure and how to patch hakyll if you need to">
    <meta property="og:image" content="https://robertwpearce.com/images/kohi-point-lookout-ohope-nz.jpg">
    
      <meta property="og:type" content="article">
    

    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:site" content="Robert Pearce | Senior Software Developer">
    <meta property="twitter:title" content="Hakyll Pt. 6 – Pure Builds With Nix">
    <meta property="twitter:description" content="Learn how to make your hakyll project build pure and how to patch hakyll if you need to">
    <meta property="twitter:image" content="https://robertwpearce.com/images/kohi-point-lookout-ohope-nz.jpg">
    <meta property="twitter:creator" content="@RobertWPearce">

    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="canonical" href="https://robertwpearce.com/hakyll-pt-6-pure-builds-with-nix.html">
    <link rel="stylesheet" href="/css/default.css" />
    
      <link rel="stylesheet" href="/css/article.css" />
    
  </head>
  <body class="light">
    <nav class="nav">
  <div class="layout--constrained" data-nav-wrap>
    <a class="nav__link nav__skip" href="#content">Skip to content</a>
    <a class="nav__link" href="/">Home</a>
    <a class="nav__link" href="mailto:me@robertwpearce.com?subject=Work Inquiry">Hire Me</a>
    <a class="nav__link" href="/atom.xml">atom</a>
    <a class="nav__link" href="/rss.xml">rss</a>
  </div>
</nav>


<main id="content" tabindex="-1">
  <article class="article">
    <header class="article__bg" style="background-image: url('/images/kohi-point-lookout-ohope-nz.jpg')">
      <div class="article__bgHeader">
        <div class="layout--constrained">
          <div class="article__bgTitleWrap">
            <h1 class="article__bgTitle">
              <a href="/hakyll-pt-6-pure-builds-with-nix.html">Hakyll Pt. 6 – Pure Builds With Nix</a>
            </h1>
            <div class="article__bgSubHeader">
              <small class="italic">2020-04-30</small>
              
              
              <small class="article__bgPhotoCred italic">
                [ photo credit <a href="https://www.instagram.com/emilycouldmakethat">emilycouldmakethat</a> ]
              </small>
              
            </div>
          </div>
        </div>
      </div>
    </header>
    <section class="layout--constrained">
      <header class="article__header">
        <h1 class="article__title">
          <a href="/hakyll-pt-6-pure-builds-with-nix.html">Hakyll Pt. 6 – Pure Builds With Nix</a>
        </h1>
        <small class="italic">2020-04-30</small>
        
      </header>
      <p>This is part 6 of a multipart series where we will look at getting a website / blog set up with <a href="https://jaspervdj.be/hakyll">hakyll</a> and customized a fair bit.</p>
<ul>
<li><a href="/hakyll-pt-1-setup-and-initial-customization.html">Pt. 1 – Setup &amp; Initial Customization</a></li>
<li><a href="/hakyll-pt-2-generating-a-sitemap-xml-file.html">Pt. 2 – Generating a Sitemap XML File</a></li>
<li><a href="/hakyll-pt-3-generating-rss-and-atom-xml-feeds.html">Pt. 3 – Generating RSS and Atom XML Feeds</a></li>
<li><a href="/hakyll-pt-4-copying-static-files-for-your-build.html">Pt. 4 – Copying Static Files For Your Build</a></li>
<li><a href="/hakyll-pt-5-generating-custom-post-filenames-from-a-title-slug.html">Pt. 5 – Generating Custom Post Filenames From a Title Slug</a></li>
<li>Pt. 6 – Pure Builds With Nix</li>
<li><em>(wip) Pt. 7 – Customizing Markdown Compiler Options</em></li>
</ul>
<h2 id="overview">Overview</h2>
<p>In this post we’re going to create a new hakyll site from scratch with a caveat: we will do just about everything with <a href="https://nixos.org">nix</a> in order to guarantee reproducibility for anyone (or anything) using our project. There are also two bonuses that we will inherit simply because we are using nix:</p>
<ul>
<li>we will not need to rely on global package installs (apart from nix, of course)</li>
<li>we will be able to easily patch any package problems; for example, if some of hakyll’s dependencies are not available in nixpkgs, we can patch hakyll to get it to work.</li>
</ul>
<p>Here is the example repository with what we’re going to make: <a href="https://github.com/rpearce/hakyll-nix-example" class="uri">https://github.com/rpearce/hakyll-nix-example</a></p>
<p><em>Note: this post assumes that you have installed nix on your system.</em></p>
<h2 id="steps-to-build-our-hakyll-project-with-nix">Steps to Build Our Hakyll Project With Nix</h2>
<p>Make a new project with <code>release.nix</code>, <code>default.nix</code>, and <code>shell.nix</code>, and get into its pure nix shell environment:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1"></a>λ <span class="fu">mkdir</span> hakyll-nix-example <span class="kw">&amp;&amp;</span> <span class="bu">cd</span> <span class="va">$_</span></span>
<span id="cb1-2"><a href="#cb1-2"></a>λ <span class="bu">echo</span> <span class="st">&quot;{ }: let in { }&quot;</span> <span class="op">&gt;</span> release.nix</span>
<span id="cb1-3"><a href="#cb1-3"></a>λ <span class="bu">echo</span> <span class="st">&quot;(import ./release.nix { }).project&quot;</span> <span class="op">&gt;</span> default.nix</span>
<span id="cb1-4"><a href="#cb1-4"></a>λ <span class="bu">echo</span> <span class="st">&quot;(import ./release.nix { }).shell&quot;</span> <span class="op">&gt;</span> shell.nix</span>
<span id="cb1-5"><a href="#cb1-5"></a>λ <span class="ex">nix-shell</span> --pure -p niv nix cacert</span></code></pre></div>
<p>We won’t have to touch <code>default.nix</code> nor <code>shell.nix</code> again, for we are delegating their responsibilities to the <code>release.nix</code> file that we’ll add more to in a moment.</p>
<p>_Note: we require <code>nix</code> and <code>cacert</code> when running a pure <code>nix-shell</code> with <code>niv</code> because of this issue: <a href="https://github.com/nmattia/niv/issues/222._" class="uri">https://github.com/nmattia/niv/issues/222._</a></p>
<p>Now that we’re in the nix shell, initialize <a href="https://github.com/nmattia/niv"><code>niv</code></a> and specify your nixpkgs owner, repository, and branch to be whatever you want:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1"></a>[<span class="ex">nix-shell</span>:~/projects/hakyll-nix-example]$ niv init</span>
<span id="cb2-2"><a href="#cb2-2"></a>[<span class="ex">nix-shell</span>:~/projects/hakyll-nix-example]$ niv update nixpkgs -o NixOS -r nixpkgs-channels -b nixpkgs-unstable</span>
<span id="cb2-3"><a href="#cb2-3"></a>[<span class="ex">nix-shell</span>:~/projects/hakyll-nix-example]$ exit</span></code></pre></div>
<p>Update your <code>release.nix</code> file with the following:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode nix"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1"></a><span class="kw">{</span> <span class="ex">compiler</span> ? <span class="st">&quot;ghc883&quot;</span></span>
<span id="cb3-2"><a href="#cb3-2"></a>, <span class="ex">sources</span> ? import ./nix/sources.nix</span>
<span id="cb3-3"><a href="#cb3-3"></a><span class="kw">}</span>:</span>
<span id="cb3-4"><a href="#cb3-4"></a></span>
<span id="cb3-5"><a href="#cb3-5"></a><span class="bu">let</span></span>
<span id="cb3-6"><a href="#cb3-6"></a>  <span class="ex">overlay</span> = _: pkgz: {</span>
<span id="cb3-7"><a href="#cb3-7"></a>    <span class="ex">niv</span> = import sources.niv { };</span>
<span id="cb3-8"><a href="#cb3-8"></a>  };</span>
<span id="cb3-9"><a href="#cb3-9"></a></span>
<span id="cb3-10"><a href="#cb3-10"></a>  <span class="ex">pkgs</span> = import sources.nixpkgs {</span>
<span id="cb3-11"><a href="#cb3-11"></a>    <span class="ex">config</span> = {</span>
<span id="cb3-12"><a href="#cb3-12"></a>      <span class="ex">packageOverrides</span> = pkgz: rec {</span>
<span id="cb3-13"><a href="#cb3-13"></a>        <span class="ex">haskell</span> = pkgz.haskell // {</span>
<span id="cb3-14"><a href="#cb3-14"></a>          <span class="ex">packages</span> = pkgz.haskell.packages // {</span>
<span id="cb3-15"><a href="#cb3-15"></a>            <span class="va">${compiler}</span> = <span class="ex">pkgz.haskell.packages.</span><span class="va">${compiler}</span>.override {</span>
<span id="cb3-16"><a href="#cb3-16"></a>              <span class="ex">overrides</span> = hpNew: hpOld: rec {</span>
<span id="cb3-17"><a href="#cb3-17"></a>                <span class="ex">hakyll</span> = hpOld.hakyll.overrideAttrs(oldAttrs: {</span>
<span id="cb3-18"><a href="#cb3-18"></a>                  <span class="ex">configureFlags</span> = <span class="st">&quot;-f watchServer -f previewServer&quot;</span><span class="kw">;</span></span>
<span id="cb3-19"><a href="#cb3-19"></a>                  <span class="ex">patches</span> = [ ./hakyll.patch ]<span class="kw">;</span></span>
<span id="cb3-20"><a href="#cb3-20"></a>                });</span>
<span id="cb3-21"><a href="#cb3-21"></a></span>
<span id="cb3-22"><a href="#cb3-22"></a>                <span class="ex">project</span> = hpNew.callCabal2nix <span class="st">&quot;hakyll-nix-example&quot;</span> ./. { };</span>
<span id="cb3-23"><a href="#cb3-23"></a>              };</span>
<span id="cb3-24"><a href="#cb3-24"></a>            };</span>
<span id="cb3-25"><a href="#cb3-25"></a>          };</span>
<span id="cb3-26"><a href="#cb3-26"></a>        };</span>
<span id="cb3-27"><a href="#cb3-27"></a>      };</span>
<span id="cb3-28"><a href="#cb3-28"></a>    };</span>
<span id="cb3-29"><a href="#cb3-29"></a></span>
<span id="cb3-30"><a href="#cb3-30"></a>    <span class="ex">overlays</span> = [ overlay ]<span class="kw">;</span></span>
<span id="cb3-31"><a href="#cb3-31"></a>  };</span>
<span id="cb3-32"><a href="#cb3-32"></a></span>
<span id="cb3-33"><a href="#cb3-33"></a>  <span class="ex">haskellPackages</span> = pkgs.haskell.packages.<span class="va">${compiler}</span><span class="kw">;</span></span>
<span id="cb3-34"><a href="#cb3-34"></a></span>
<span id="cb3-35"><a href="#cb3-35"></a><span class="kw">in</span> <span class="kw">{</span></span>
<span id="cb3-36"><a href="#cb3-36"></a>  <span class="ex">project</span> = haskellPackages.project<span class="kw">;</span></span>
<span id="cb3-37"><a href="#cb3-37"></a></span>
<span id="cb3-38"><a href="#cb3-38"></a>  <span class="ex">shell</span> = haskellPackages.shellFor {</span>
<span id="cb3-39"><a href="#cb3-39"></a>    <span class="ex">packages</span> = p: with p<span class="kw">;</span><span class="bu"> [</span></span>
<span id="cb3-40"><a href="#cb3-40"></a>      haskellPackages.project</span>
<span id="cb3-41"><a href="#cb3-41"></a>    ];</span>
<span id="cb3-42"><a href="#cb3-42"></a>    buildInputs <span class="ot">=</span> with haskellPackages; [</span>
<span id="cb3-43"><a href="#cb3-43"></a>      ghcid</span>
<span id="cb3-44"><a href="#cb3-44"></a>      hlint       <span class="co"># or ormolu</span></span>
<span id="cb3-45"><a href="#cb3-45"></a>      niv</span>
<span id="cb3-46"><a href="#cb3-46"></a>      pkgs.cacert <span class="co"># needed for niv</span></span>
<span id="cb3-47"><a href="#cb3-47"></a>      pkgs.nix    <span class="co"># needed for niv</span></span>
<span id="cb3-48"><a href="#cb3-48"></a>    ];</span>
<span id="cb3-49"><a href="#cb3-49"></a>    withHoogle <span class="ot">=</span> true;</span>
<span id="cb3-50"><a href="#cb3-50"></a>  };</span>
<span id="cb3-51"><a href="#cb3-51"></a>}</span></code></pre></div>
<p>Don’t worry, we’ll circle back to what we just did.</p>
<p>Create a <code>hakyll.patch</code> diff file:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1"></a>λ <span class="fu">touch</span> hakyll.patch</span></code></pre></div>
<p>Bootstrap the hakyll project (we won’t ever need this again):</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1"></a>λ <span class="ex">nix-shell</span> --pure -p haskellPackages.hakyll --run <span class="st">&quot;hakyll-init .&quot;</span></span></code></pre></div>
<p>Build the project and <code>--show-trace</code> just in case something goes wrong:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1"></a>λ <span class="ex">nix-build</span> --show-trace</span></code></pre></div>
<p>Run the local dev server:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1"></a>λ <span class="ex">./result/bin/site</span> watch</span></code></pre></div>
<p>Navigate to <a href="http://localhost:8000" class="uri">http://localhost:8000</a> and see your local dev site up and running!</p>
<h2 id="understanding-the-releasenix-file">Understanding the <code>release.nix</code> File</h2>
<p>Let’s break down what we copied and pasted into <code>release.nix</code>.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode nix"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1"></a><span class="kw">{</span> <span class="ex">compiler</span> ? <span class="st">&quot;ghc883&quot;</span></span>
<span id="cb8-2"><a href="#cb8-2"></a>, <span class="ex">sources</span> ? import ./nix/sources.nix</span>
<span id="cb8-3"><a href="#cb8-3"></a><span class="kw">}</span>:</span></code></pre></div>
<p>This is a function parameter with two attributes, <code>compiler</code> and <code>sources</code>, that each have defaults. For the <code>compiler</code>, we will use this version to compile all of the Haskell packages that we interact with. For the <code>sources</code>, this file is generated by <code>niv</code> and contains our pinned <code>niv</code> and <code>nixpkgs</code> information.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode nix"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1"></a><span class="bu">let</span></span>
<span id="cb9-2"><a href="#cb9-2"></a>  <span class="ex">overlay</span> = _: pkgz: {</span>
<span id="cb9-3"><a href="#cb9-3"></a>    <span class="ex">niv</span> = import sources.niv { };</span>
<span id="cb9-4"><a href="#cb9-4"></a>  };</span>
<span id="cb9-5"><a href="#cb9-5"></a>  <span class="co"># ...</span></span></code></pre></div>
<p>This <a href="https://nixos.org/nixpkgs/manual/#chap-overlays">nix overlay</a> specifies that when using <code>niv</code> it should use our pinned <code>niv</code>.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode nix"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1"></a><span class="bu">let</span></span>
<span id="cb10-2"><a href="#cb10-2"></a>  <span class="co"># ...</span></span>
<span id="cb10-3"><a href="#cb10-3"></a>  <span class="ex">pkgs</span> = import sources.nixpkgs {</span>
<span id="cb10-4"><a href="#cb10-4"></a>    <span class="ex">config</span> = {</span>
<span id="cb10-5"><a href="#cb10-5"></a>      <span class="ex">packageOverrides</span> = pkgz: rec {</span>
<span id="cb10-6"><a href="#cb10-6"></a>        <span class="ex">haskell</span> = pkgz.haskell // {</span>
<span id="cb10-7"><a href="#cb10-7"></a>          <span class="ex">packages</span> = pkgz.haskell.packages // {</span>
<span id="cb10-8"><a href="#cb10-8"></a>            <span class="va">${compiler}</span> = <span class="ex">pkgz.haskell.packages.</span><span class="va">${compiler}</span>.override {</span>
<span id="cb10-9"><a href="#cb10-9"></a>              <span class="ex">overrides</span> = hpNew: hpOld: rec {</span>
<span id="cb10-10"><a href="#cb10-10"></a>                <span class="ex">hakyll</span> = hpOld.hakyll.overrideAttrs(oldAttrs: {</span>
<span id="cb10-11"><a href="#cb10-11"></a>                  <span class="ex">configureFlags</span> = <span class="st">&quot;-f watchServer -f previewServer&quot;</span><span class="kw">;</span></span>
<span id="cb10-12"><a href="#cb10-12"></a>                  <span class="ex">patches</span> = [ ./hakyll.patch ]<span class="kw">;</span></span>
<span id="cb10-13"><a href="#cb10-13"></a>                });</span>
<span id="cb10-14"><a href="#cb10-14"></a></span>
<span id="cb10-15"><a href="#cb10-15"></a>                <span class="ex">project</span> = hpNew.callCabal2nix <span class="st">&quot;hakyll-nix-example&quot;</span> ./. { };</span>
<span id="cb10-16"><a href="#cb10-16"></a>              };</span>
<span id="cb10-17"><a href="#cb10-17"></a>            };</span>
<span id="cb10-18"><a href="#cb10-18"></a>          };</span>
<span id="cb10-19"><a href="#cb10-19"></a>        };</span>
<span id="cb10-20"><a href="#cb10-20"></a>      };</span>
<span id="cb10-21"><a href="#cb10-21"></a>    };</span>
<span id="cb10-22"><a href="#cb10-22"></a></span>
<span id="cb10-23"><a href="#cb10-23"></a>    <span class="ex">overlays</span> = [ overlay ]<span class="kw">;</span></span>
<span id="cb10-24"><a href="#cb10-24"></a>  };</span>
<span id="cb10-25"><a href="#cb10-25"></a>  <span class="co"># ...</span></span></code></pre></div>
<p>This configures our pinned <code>nixpkgs</code> to have some <code>overrides</code> for a specific Haskell <code>compiler</code> version.</p>
<p>For <code>hakyll</code>, we need to make sure it gets compiled with the <code>watchServer</code> and <code>previewServer</code> flags, or we won’t be able to use its local dev server. We also provide an optional list of <code>patches</code> (<code>git diff</code> files) that we can build <code>hakyll</code> with if there are any changes to the project that we need to make. These patch files can be empty when no patches are required, but if you do need to patch something, here is an example <code>hakyll.patch</code> file:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb11-1"><a href="#cb11-1"></a><span class="kw">diff --git a/hakyll.cabal b/hakyll.cabal</span></span>
<span id="cb11-2"><a href="#cb11-2"></a>index fcded8d..9746f20 100644</span>
<span id="cb11-3"><a href="#cb11-3"></a><span class="dt">--- a/hakyll.cabal</span></span>
<span id="cb11-4"><a href="#cb11-4"></a><span class="dt">+++ b/hakyll.cabal</span></span>
<span id="cb11-5"><a href="#cb11-5"></a><span class="dt">@@ -199,7 +199,7 @@ Library</span></span>
<span id="cb11-6"><a href="#cb11-6"></a>   If flag(previewServer)</span>
<span id="cb11-7"><a href="#cb11-7"></a>     Build-depends:</span>
<span id="cb11-8"><a href="#cb11-8"></a>       wai             &gt;= 3.2   &amp;&amp; &lt; 3.3,</span>
<span id="cb11-9"><a href="#cb11-9"></a><span class="st">-      warp            &gt;= 3.2   &amp;&amp; &lt; 3.3,</span></span>
<span id="cb11-10"><a href="#cb11-10"></a><span class="va">+      warp,</span></span>
<span id="cb11-11"><a href="#cb11-11"></a>       wai-app-static  &gt;= 3.1   &amp;&amp; &lt; 3.2,</span>
<span id="cb11-12"><a href="#cb11-12"></a>       http-types      &gt;= 0.9   &amp;&amp; &lt; 0.13,</span>
<span id="cb11-13"><a href="#cb11-13"></a>       fsnotify        &gt;= 0.2   &amp;&amp; &lt; 0.4</span></code></pre></div>
<p>The <code>project</code> attribute is specifically for our Haskell project in order for us to be sure our project is compiled with our desired compiler version. We leverage the <code>callCabal2nix</code> tool to handle converting our <code>hakyll-nix-example.cabal</code> file into a <code>nix</code> derivation.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode nix"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1"></a><span class="bu">let</span></span>
<span id="cb12-2"><a href="#cb12-2"></a>  <span class="co"># ...</span></span>
<span id="cb12-3"><a href="#cb12-3"></a>  <span class="ex">haskellPackages</span> = pkgs.haskell.packages.<span class="va">${compiler}</span><span class="kw">;</span></span>
<span id="cb12-4"><a href="#cb12-4"></a>  <span class="co"># ...</span></span></code></pre></div>
<p>This gives us a variable to use instead of writing <code>pkgs.haskell.packages.${compiler}</code> over and over again.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode nix"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1"></a><span class="bu">let</span></span>
<span id="cb13-2"><a href="#cb13-2"></a>  <span class="co"># ...</span></span>
<span id="cb13-3"><a href="#cb13-3"></a><span class="kw">in</span> <span class="kw">{</span></span>
<span id="cb13-4"><a href="#cb13-4"></a>  <span class="ex">project</span> = haskellPackages.project<span class="kw">;</span></span>
<span id="cb13-5"><a href="#cb13-5"></a>  <span class="co"># ...</span></span></code></pre></div>
<p>The <code>project</code> attribute is what our <code>default.nix</code> will use when being called with tools like <code>nix-build</code>. All we do is pull our <code>project</code> attribute off of the overridden <code>nixpkgs</code> config.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode nix"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1"></a><span class="bu">let</span></span>
<span id="cb14-2"><a href="#cb14-2"></a>  <span class="co"># ...</span></span>
<span id="cb14-3"><a href="#cb14-3"></a><span class="kw">in</span> <span class="kw">{</span></span>
<span id="cb14-4"><a href="#cb14-4"></a>  <span class="co"># ...</span></span>
<span id="cb14-5"><a href="#cb14-5"></a>  <span class="ex">shell</span> = haskellPackages.shellFor {</span>
<span id="cb14-6"><a href="#cb14-6"></a>    <span class="ex">packages</span> = p: with p<span class="kw">;</span><span class="bu"> [</span></span>
<span id="cb14-7"><a href="#cb14-7"></a>      haskellPackages.project</span>
<span id="cb14-8"><a href="#cb14-8"></a>    ];</span>
<span id="cb14-9"><a href="#cb14-9"></a>    buildInputs <span class="ot">=</span> with haskellPackages; [</span>
<span id="cb14-10"><a href="#cb14-10"></a>      ghcid</span>
<span id="cb14-11"><a href="#cb14-11"></a>      hlint <span class="co"># or ormolu</span></span>
<span id="cb14-12"><a href="#cb14-12"></a>      pkgs.niv</span>
<span id="cb14-13"><a href="#cb14-13"></a>      pkgs.cacert</span>
<span id="cb14-14"><a href="#cb14-14"></a>      pkgs.nix</span>
<span id="cb14-15"><a href="#cb14-15"></a>    ];</span>
<span id="cb14-16"><a href="#cb14-16"></a>    withHoogle <span class="ot">=</span> true;</span>
<span id="cb14-17"><a href="#cb14-17"></a>  };</span>
<span id="cb14-18"><a href="#cb14-18"></a>}</span></code></pre></div>
<p>Exactly like <code>default.nix</code> uses the <code>project</code> attribute, <code>shell.nix</code> is looking for a <code>shell</code> attribute to define everything it needs when running <code>nix-shell --pure</code>. We use <code>shellFor</code>, which comes with the <code>nixpkgs</code> Haskell tools, and we provide it a few attributes:</p>
<ul>
<li>the <code>packages</code> attribute holds our <code>project</code> package and any other <code>nixpkgs</code> that you would like to have built when entering the shell</li>
<li>the <code>buildInputs</code> attribute holds all the tools that we’ll have available to us while we’re in the shell; for example, you can run <code>ghcid</code> and load your Haskell code to test it out or run <code>hlint</code> to lint your Haskell files</li>
<li><code>withHoogle</code> gives us the ability to query <a href="https://hoogle.haskell.org" class="uri">https://hoogle.haskell.org</a></li>
</ul>
<h2 id="wrapping-up">Wrapping Up</h2>
<p>Using nix to build our project helps make development consistent and predictable; however, learning nix is not necessarily a breeze. The following articles directly contributed to my understanding that led to this post:</p>
<ul>
<li><a href="https://github.com/Gabriel439/haskell-nix/tree/master/project4" class="uri">https://github.com/Gabriel439/haskell-nix/tree/master/project4</a></li>
<li><a href="https://turbomack.github.io/posts/2020-02-17-cabal-flags-and-nix.html" class="uri">https://turbomack.github.io/posts/2020-02-17-cabal-flags-and-nix.html</a> (this article is what led me to learn how to patch hakyll)</li>
<li><code>overrideAttrs</code>: <a href="https://nixos.org/nixpkgs/manual/#sec-pkg-overrideAttrs" class="uri">https://nixos.org/nixpkgs/manual/#sec-pkg-overrideAttrs</a></li>
<li><code>overlays</code>: <a href="https://nixos.org/nixpkgs/manual/#chap-overlays" class="uri">https://nixos.org/nixpkgs/manual/#chap-overlays</a></li>
<li><a href="https://maybevoid.com/posts/2019-01-27-getting-started-haskell-nix.html" class="uri">https://maybevoid.com/posts/2019-01-27-getting-started-haskell-nix.html</a></li>
<li><a href="https://kuznero.com/post/linux/haskell-project-structure-in-nixos/" class="uri">https://kuznero.com/post/linux/haskell-project-structure-in-nixos/</a></li>
<li><a href="https://github.com/NixOS/nixpkgs/blob/master/doc/languages-frameworks/haskell.section.md" class="uri">https://github.com/NixOS/nixpkgs/blob/master/doc/languages-frameworks/haskell.section.md</a></li>
<li><a href="https://nixos.org/nixpkgs/manual/#haskell" class="uri">https://nixos.org/nixpkgs/manual/#haskell</a></li>
</ul>
<p>Next up:</p>
<ul>
<li><em>(wip) Pt. 7 – Customizing Markdown Compiler Options</em></li>
</ul>
<hr />
<p>Thank you for reading! <br /> Robert</p>
    </section>
  </article>
</main>

<footer>
  <section class="subscribe section--padded">
  <div class="layout--constrained">
    <h2 class="subscribe__header">Get notified of new posts</h2>

    <form action="//robertwpearce.us13.list-manage.com/subscribe/post?u=2df44e8960266388bff165fa6&amp;id=ee2f2a3737" method="post" name="mc-embedded-subscribe-form" target="_blank" novalidate class="subscribe__form">
      <div style="position: absolute; left: -5000px;" aria-hidden="true">
        <input type="text" name="b_2df44e8960266388bff165fa6_ee2f2a3737" tabindex="-1" value="">
      </div>
      <div class="subscribe__section">
        <input type="email" value="" id="mce-EMAIL" class="subscribe__input" name="EMAIL" placeholder="you@greatemail.com" aria-label="Email Address">
        <input type="submit" value="Subscribe" name="subscribe" class="subscribe__submit">
      </div>
      <small>Note: I will <em>never</em> give out your email nor spam you. Unsubscribe at any time.</small>
    </form>
    <p>
      <small>(or subscribe to the <a href="/atom.xml" class="subscribe__link">atom</a> or <a class="subscribe__link" href="/rss.xml">rss</a> feeds)</small>
    </p>
  </div>
</section>

</footer>

    <script async src="/js/dist/index.js"></script>
  </body>
</html>
