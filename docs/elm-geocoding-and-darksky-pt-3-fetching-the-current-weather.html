<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Elm, Geocoding & DarkSky: Pt. 3 – Fetching the Current Weather</title>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1">
    <meta name="description" content="In Part 3 we query the DarkSky API with our geocoded address">
    <meta name="author" content="Robert Pearce">
    <meta name="keywords" content="elm, elm tutorial, elmlang, elm geocoding, elm darksky, elm weather, elm functional programming">
    <meta name="google-site-verification" content="QX4bn65yOXBfgnwxlO09yIBc1H8blur-Erx3lmsDVhU">

    <meta property="og:site_name" content="Robert Pearce | Freelance Software Developer">
    <meta property="og:title" content="Elm, Geocoding & DarkSky: Pt. 3 – Fetching the Current Weather">
    <meta property="og:url" content="https://robertwpearce.com/elm-geocoding-and-darksky-pt-3-fetching-the-current-weather.html">
    <meta property="og:description" content="In Part 3 we query the DarkSky API with our geocoded address">
    <meta property="og:image" content="https://robertwpearce.com/images/london-rain.jpg">
    
      <meta property="og:type" content="article">
    

    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:site" content="Robert Pearce | Freelance Software Developer">
    <meta property="twitter:title" content="Elm, Geocoding & DarkSky: Pt. 3 – Fetching the Current Weather">
    <meta property="twitter:description" content="In Part 3 we query the DarkSky API with our geocoded address">
    <meta property="twitter:image" content="https://robertwpearce.com/images/london-rain.jpg">
    <meta property="twitter:creator" content="@RobertWPearce">

    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="canonical" href="https://robertwpearce.com/elm-geocoding-and-darksky-pt-3-fetching-the-current-weather.html">
    <link href="//fonts.googleapis.com/css?family=Lato:400" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="/css/default.css" />
    
      <link rel="stylesheet" href="/css/article.css" />
    
  </head>
  <body>
    <main>
  <nav class="nav">
  <div class="layout--constrained">
    <a class="nav__link" href="/">Home</a>
    <a class="nav__link" href="mailto:me@robertwpearce.com?subject=Work Inquiry">Hire Me</a>
    <a class="nav__link" href="/atom.xml">atom</a>
    <a class="nav__link" href="/rss.xml">rss</a>
  </div>
</nav>

  <article class="article">
    <div class="article__bg" style="background-image: url('/images/london-rain.jpg')">
      <header class="article__bgHeader">
        <div class="layout--constrained">
          <div class="article__bgTitleWrap">
            <h1 class="article__bgTitle">
              <a href="/elm-geocoding-and-darksky-pt-3-fetching-the-current-weather.html">Elm, Geocoding & DarkSky: Pt. 3 – Fetching the Current Weather</a>
            </h1>
            <div class="article__bgSubHeader">
              <small class="italic">Aug 18, 2017</small>
              
                <small class="article__bgPhotoCred italic">
                  [ photo credit <a href="https://unsplash.com/@anjimenon">Anjana Menon</a> ]
                </small>
              
            </div>
          </div>
        </div>
      </header>
    </div>
    <section class="layout--constrained">
      <header class="article__header">
        <h1 class="article__title">
          <a href="/elm-geocoding-and-darksky-pt-3-fetching-the-current-weather.html">Elm, Geocoding & DarkSky: Pt. 3 – Fetching the Current Weather</a>
        </h1>
        <small class="italic">Aug 18, 2017</small>
      </header>
      <p>This is part 3 of a multipart series where we will be building a small weather forecast app using <a href="http://elm-lang.org/">Elm</a>, <a href="https://developers.google.com/maps/documentation/geocoding/start">Google’s Geocoding API</a> and the <a href="https://darksky.net/dev/">DarkSky API</a>. Instead of doing everything in one massive post, I’ve broken the steps down into parts of a series. Here is the series plan:</p>
<ul>
<li><a href="/blog/elm-geocoding-and-darksky-pt-1-setup-elm-and-proxy-servers.html">Pt. 1 – Setup Elm &amp; Proxy Servers</a></li>
<li><a href="/blog/elm-geocoding-and-darksky-pt-2-geocoding-an-address.html">Pt. 2 – Geocoding an Address</a></li>
<li>Pt. 3 – Fetching the Current Weather</li>
<li><a href="/blog/elm-geocoding-and-darksky-pt-4-extracting-our-elm-code.html">Pt. 4 – Extracting Our Elm Code</a></li>
</ul>
<p>If you’d like to code along with this tutorial, check out <a href="/blog/elm-geocoding-and-darksky-pt-1-setup-elm-and-proxy-servers.html">part 1</a> and <a href="/blog/elm-geocoding-and-darksky-pt-2-fetching-the-current-weather.html">part 2</a> first to get set up.</p>
<p><em>Note: to learn more about the Elm language and syntax, check out the <a href="https://www.elm-tutorial.org/en/">Elm Tutorial</a>, the <a href="https://egghead.io/courses/start-using-elm-to-build-web-applications">EggHead.io Elm course</a>, subscribe to <a href="https://www.dailydrip.com/topics/elm">DailyDrip’s Elm Topic</a>, <a href="http://courses.knowthen.com">James Moore’s Elm Courses</a> or check out <a href="http://exercism.io/languages/elm/about">Elm on exercism.io</a>.</em></p>
<h2 id="overview">Overview</h2>
<p>In this post we will use Elm to fetch and display the current weather based on the geocode data we receive from an input field.</p>
<h2 id="project-source-code">Project Source Code</h2>
<p>The project we’re making will be broken into parts here (branches will be named for each part): <a href="https://github.com/rpearce/elm-geocoding-darksky/" class="uri">https://github.com/rpearce/elm-geocoding-darksky/</a>. Be sure to check out the other branches to see the other parts as they become available.</p>
<p>The code for this part is located in the <code>pt-3</code> branch: <a href="https://github.com/rpearce/elm-geocoding-darksky/tree/pt-3" class="uri">https://github.com/rpearce/elm-geocoding-darksky/tree/pt-3</a>.</p>
<h2 id="steps-for-today">Steps for Today</h2>
<ol>
<li>Understanding DarkSky’s response data</li>
<li>Modeling the DarkSky response data</li>
<li>Creating DarkSky JSON decoders</li>
<li>Writing our fetchWeather HTTP function</li>
<li>Calling fetchWeather and handling the response</li>
<li>Displaying the current weather in our view</li>
</ol>
<h2 id="understanding-darkskys-response-data">1. Understanding DarkSky’s response data</h2>
<p>Let’s get the weather data for Auckland, NZ (-36.8484597,174.7633315). If we start up our <a href="https://github.com/rpearce/DarkSky-proxy">DarkSky proxy</a> and run</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb1-1" title="1">λ <span class="ex">curl</span> localhost:5051/forecast/-36.8484597,174.7633315</a></code></pre></div>
<p>then we will see response data like this:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode json"><code class="sourceCode json"><a class="sourceLine" id="cb2-1" title="1"><span class="fu">{</span></a>
<a class="sourceLine" id="cb2-2" title="2">  <span class="dt">&quot;timezone&quot;</span><span class="fu">:</span> <span class="st">&quot;Pacific</span><span class="ch">\/</span><span class="st">Auckland&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb2-3" title="3">  <span class="dt">&quot;currently&quot;</span><span class="fu">:</span> <span class="fu">{</span></a>
<a class="sourceLine" id="cb2-4" title="4">    <span class="dt">&quot;summary&quot;</span><span class="fu">:</span> <span class="st">&quot;Overcast&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb2-5" title="5">    <span class="dt">&quot;icon&quot;</span><span class="fu">:</span> <span class="st">&quot;cloudy&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb2-6" title="6">    <span class="dt">&quot;temperature&quot;</span><span class="fu">:</span> <span class="fl">61.42</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb2-7" title="7">    <span class="er">...</span></a>
<a class="sourceLine" id="cb2-8" title="8">  <span class="fu">},</span></a>
<a class="sourceLine" id="cb2-9" title="9">  <span class="dt">&quot;hourly&quot;</span><span class="fu">:</span> <span class="fu">{</span> <span class="er">...</span> <span class="fu">}</span></a>
<a class="sourceLine" id="cb2-10" title="10">  <span class="st">&quot;daily&quot;</span><span class="er">:</span> <span class="fu">{</span> <span class="er">...</span> <span class="fu">}</span></a>
<a class="sourceLine" id="cb2-11" title="11"><span class="fu">}</span></a></code></pre></div>
<p>While all we care about are the <code>summary</code>, <code>icon</code> and <code>temperature</code> properties within the top-level <code>currently</code> property, we will only use <code>temperature</code> in this part.</p>
<p>Disclaimer: DarkSky units are in <code>us</code> by default. You can specify other unit types by appending a <code>units</code> query parameter to the end like this:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb3-1" title="1">λ <span class="ex">curl</span> localhost:5051/forecast/-36.8484597,174.7633315?units=si</a></code></pre></div>
<p>Read more about <a href="https://darksky.net/dev/docs/forecast">DarkSky request parameters in the DarkSky docs</a> to customize your response data.</p>
<p>Now that we’ve got our data in the correct units, let’s model this data in Elm!</p>
<h2 id="modeling-the-darksky-response-data">2. Modeling the DarkSky response data</h2>
<p>Based on our DarkSky response, let’s list out what we’re looking at:</p>
<ul>
<li>an object, <code>currently</code>, which has 3 notable properties:
<ul>
<li>a string, <code>summary</code></li>
<li>a string, <code>icon</code></li>
<li>a float, <code>temperature</code></li>
</ul></li>
</ul>
<p>Since we have two levels of data, <code>currently</code> and its child properties, let’s create two type aliases to represent this data.</p>
<pre class="elm"><code>type alias Weather =
    { currently : WeatherCurrently
    }


type alias WeatherCurrently =
    { icon : String
    , summary : String
    , temperature : Float
    }</code></pre>
<p>And now we can add a property to our <code>Model</code> type alias that can be of our <code>Weather</code> type:</p>
<pre class="elm"><code>type alias Model =
    { address : String
    , coords : Coords
    , weather : Weather
    }</code></pre>
<p>Uh oh! Our <code>Model</code> has a defaults function called <code>initialModel</code>, and now that we’ve added <code>weather</code> into the mix, we’ll need to give that default values, as well:</p>
<pre class="elm"><code>initialModel : Model
initialModel =
    { address = &quot;&quot;
    , coords = ( 0, 0 )
    , weather = initialWeather
    }


initialWeather : Weather
initialWeather =
    { currently = initialWeatherCurrently
    }


initialWeatherCurrently : WeatherCurrently
initialWeatherCurrently =
    { icon = &quot;–&quot;
    , summary = &quot;–&quot;
    , temperature = 0
    }</code></pre>
<p>These are defaults that we provide in the event that we have no data to work with (initially or if something goes wrong).</p>
<h2 id="creating-darksky-json-decoders">3. Creating DarkSky JSON decoders</h2>
<p>Just as we did in the <a href="/blog/elm-geocoding-and-darksky-pt-2-geocoding-an-address.html#4-creating-json-decoders">geocoding post section on JSON decoding</a>, we want to leverage <a href="https://github.com/NoRedInk/elm-decode-pipeline">NoRedInk’s elm-decode-pipeline</a> to define how our JSON response should be structured and thus parsed.</p>
<pre class="elm"><code>decodeWeather : Decoder Weather
decodeWeather =
    decode Weather
        |&gt; required &quot;currently&quot; decodeWeatherCurrently


decodeWeatherCurrently : Decoder WeatherCurrently
decodeWeatherCurrently =
    decode WeatherCurrently
        |&gt; required &quot;icon&quot; string
        |&gt; required &quot;summary&quot; string
        |&gt; required &quot;temperature&quot; float</code></pre>
<p>While we could use <a href="http://package.elm-lang.org/packages/elm-lang/core/5.1.1/Json-Decode#at">Json.Decode.at</a> to potentially have less code, there is absolutely nothing wrong with being verbose if it leads to clarity.</p>
<h2 id="writing-our-fetchweather-http-function">4. Writing our fetchWeather HTTP function</h2>
<p>We know that we’re going to have to send latitude and longitude <code>Coords</code> to our <a href="https://github.com/rpearce/DarkSky-proxy">DarkSky proxy server</a>, as well as any additional options, so let’s define the URL for that and the fetching function <a href="/blog/elm-geocoding-and-darksky-pt-2-geocoding-an-address.html#8-making-our-request">just like we did for geocoding</a>.</p>
<pre class="elm"><code>weatherUrl : Coords -&gt; String
weatherUrl ( lat, lng ) =
    &quot;http://localhost:5051/forecast/&quot;
        ++ (toString lat)
        ++ &quot;,&quot;
        ++ (toString lng)
        -- this is where you can add your query params


fetchWeather : Coords -&gt; Cmd Msg
fetchWeather coords =
    Http.get (weatherUrl coords) decodeWeather
        |&gt; Http.send ReceiveWeather</code></pre>
<p>To define an HTTP request in Elm, we need</p>
<ul>
<li>✅ a URL to point to</li>
<li>✅ a package like Http to help us build the request</li>
<li>✅ a decoder to handle parsing the response data</li>
<li>🤷 a <code>Msg</code> type that our <code>update</code> function can pattern match on</li>
</ul>
<p>Right! We can’t forget to add <code>ReceiveWeather</code> as a <code>Msg</code> type. It should be almost the same as <code>ReceiveGeocoding</code>:</p>
<pre class="elm"><code>type Msg
    = UpdateAddress String
    | SendAddress
    | ReceiveGeocoding (Result Http.Error GeoModel)
    | ReceiveWeather (Result Http.Error Weather)
    | NoOp</code></pre>
<h2 id="calling-fetchweather-and-handling-the-response">5. Calling fetchWeather and handling the response</h2>
<p>When we <a href="https://robertwpearce.com/blog/elm-geocoding-and-darksky-pt-2-geocoding-an-address.html#9-handling-the-geocode-response">handled our geocode response in the prior post</a>, inside of <code>ReceiveGeocoding</code> we returned <code>( newModel, Cmd.none )</code>, for we had no further actions to take. Instead of our action in this tuple being <code>Cmd.none</code>, let’s instead call our <code>fetchWeather</code> function and pass it our geocoded coordinates:</p>
<pre class="elm"><code>update : Msg -&gt; Model -&gt; ( Model, Cmd Msg )
update msg model =
    case msg of
        -- ...removed for brevity

        ReceiveGeocoding (Ok { results, status }) -&gt;
            let
                -- ...
                newModel =
                    -- ...
            in
                ( newModel, fetchWeather newModel.coords )

        -- ...

        ReceiveWeather (Ok resp) -&gt;
            ( { model | weather = { currently = resp.currently } }
            , Cmd.none
            )

        ReceiveWeather (Err _) -&gt;
            ( model, Cmd.none )</code></pre>
<p>Again, at the end of <code>ReceiveGeocoding</code>, we return our <code>newModel</code> as well as the command to go and fetch the weather with the coordinates we’re storing on our <code>newModel</code>.</p>
<p>Whenever the HTTP request and decoding gives us back a result with the <code>Msg</code> type of <code>ReceiveWeather</code>, we then update the weather property on our model record to have the <code>currently</code> data parsed from the decoder.</p>
<h2 id="displaying-the-current-weather-in-our-view">6. Displaying the current weather in our view</h2>
<p>Finally, to make sure we’re doing each step correctly, let’s add the temperature to our view:</p>
<pre class="elm"><code>view : Model -&gt; Html Msg
view model =
    div []
        [ form [ onSubmit SendAddress ]
            [ input
                [ type_ &quot;text&quot;
                , placeholder &quot;City&quot;
                , value model.address
                , onInput UpdateAddress
                ]
                []
            ]
        , p [] [ text (&quot;Coords: &quot; ++ (toString model.coords)) ]
        , p [] [ text (&quot;Weather: &quot; ++ (toString (round model.weather.currently.temperature))) ]
        ]</code></pre>
<p>Here we use <a href="http://package.elm-lang.org/packages/elm-lang/core/latest/Basics#round">Basics.round</a> because an approximation is alright for weather.</p>
<p>Now, when you rebuild your code with <code>./build</code>, open <code>index.html</code> and submit a city/address name, you’ll first see the <code>Coords</code> update on the page and then see the <code>Weather</code> result once it’s done.</p>
<h2 id="wrapping-up">Wrapping Up</h2>
<p>Hooray! We can geocode an address and fetch the weather via two different proxy servers and display a result! That’s great, but our <code>Main.elm</code> file is getting quite large, so stay tuned for the next part where we pull our code into smaller chunks without losing clarity.</p>
<p>If you’d like to check out the code from this part, it is located here: <a href="https://github.com/rpearce/elm-geocoding-darksky/tree/pt-3" class="uri">https://github.com/rpearce/elm-geocoding-darksky/tree/pt-3</a>.</p>
<p>Until next time, <br> Robert</p>
    </section>
  </article>
</main>

<section class="subscribe section--padded bg--gray">
  <div class="layout--constrained">
    <h2 class="subscribe__header">Get notified of new posts</h2>

    <form action="//robertwpearce.us13.list-manage.com/subscribe/post?u=2df44e8960266388bff165fa6&amp;id=ee2f2a3737" method="post" name="mc-embedded-subscribe-form" target="_blank" novalidate class="subscribe__form">
      <div id="mce-responses">
        <div class="response" id="mce-error-response" style="display:none"></div>
        <div class="response" id="mce-success-response" style="display:none"></div>
      </div>
      <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_2df44e8960266388bff165fa6_ee2f2a3737" tabindex="-1" value=""></div>
      <div class="subscribe__section">
        <label for="mce-EMAIL" class="subscribe__label">Email Address</label>
        <input type="email" value="" id="mce-EMAIL" class="subscribe__input" name="EMAIL" placeholder="you@greatemail.com">
        <input type="submit" value="Subscribe" name="subscribe" class="subscribe__submit">
      </div>
      <small>Note: I will <em>never</em> give out your email nor spam you. Unsubscribe at any time.</small>
    </form>

    <p>
      <small>(or subscribe to the <a href="/atom.xml">atom</a> or <a href="/rss.xml">rss</a> feeds)</small>
    </p>
  </div>
</section>


  </body>
</html>
