<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Hakyll Pt. 3 – Generating RSS and Atom XML Feeds</title>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Generate rss.xml and atom.xml feeds for your hakyll site.">
    <meta name="author" content="Robert Pearce">
    <meta name="keywords" content="hakyll, rss, atom, rss.xml, atom.xml, hakyll tutorial, hakyll blog, hakyll blog tutorial, hakyll static site, static site generator">
    <meta name="google-site-verification" content="QX4bn65yOXBfgnwxlO09yIBc1H8blur-Erx3lmsDVhU">

    <meta property="og:site_name" content="Robert Pearce | Senior Software Developer">
    <meta property="og:title" content="Hakyll Pt. 3 – Generating RSS and Atom XML Feeds">
    <meta property="og:url" content="https://robertwpearce.com/hakyll-pt-3-generating-rss-and-atom-xml-feeds.html">
    <meta property="og:description" content="Generate rss.xml and atom.xml feeds for your hakyll site.">
    <meta property="og:image" content="https://robertwpearce.com/images/glenorchy-lagoon.jpg">
    
      <meta property="og:type" content="article">
    

    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:site" content="Robert Pearce | Senior Software Developer">
    <meta property="twitter:title" content="Hakyll Pt. 3 – Generating RSS and Atom XML Feeds">
    <meta property="twitter:description" content="Generate rss.xml and atom.xml feeds for your hakyll site.">
    <meta property="twitter:image" content="https://robertwpearce.com/images/glenorchy-lagoon.jpg">
    <meta property="twitter:creator" content="@RobertWPearce">

    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="canonical" href="https://robertwpearce.com/hakyll-pt-3-generating-rss-and-atom-xml-feeds.html">
    <link rel="stylesheet" href="/css/default.css" />
    
      <link rel="stylesheet" href="/css/article.css" />
    
  </head>
  <body class="light">
    <nav class="nav">
  <div class="layout--constrained" data-nav-wrap>
    <a class="nav__link nav__skip" href="#content">Skip to content</a>
    <a class="nav__link" href="/">Home</a>
    <a class="nav__link" href="mailto:me@robertwpearce.com?subject=Work Inquiry">Hire Me</a>
    <a class="nav__link" href="/atom.xml">atom</a>
    <a class="nav__link" href="/rss.xml">rss</a>
  </div>
</nav>


<main id="content" tabindex="-1">
  <article class="article">
    <header class="article__bg" style="background-image: url('/images/glenorchy-lagoon.jpg')">
      <div class="article__bgHeader">
        <div class="layout--constrained">
          <div class="article__bgTitleWrap">
            <h1 class="article__bgTitle">
              <a href="/hakyll-pt-3-generating-rss-and-atom-xml-feeds.html">Hakyll Pt. 3 – Generating RSS and Atom XML Feeds</a>
            </h1>
            <div class="article__bgSubHeader">
              <small class="italic">2019-01-23</small>
              
              <small class="italic">(updated: 2020-04-26T00:00:00Z)</small>
              
              
              <small class="article__bgPhotoCred italic">
                [ photo credit <a href="https://www.instagram.com/robertwpearce">robertwpearce</a> ]
              </small>
              
            </div>
          </div>
        </div>
      </div>
    </header>
    <section class="layout--constrained">
      <header class="article__header">
        <h1 class="article__title">
          <a href="/hakyll-pt-3-generating-rss-and-atom-xml-feeds.html">Hakyll Pt. 3 – Generating RSS and Atom XML Feeds</a>
        </h1>
        <small class="italic">2019-01-23</small>
        
        <small class="italic">(updated: 2020-04-26T00:00:00Z)</small>
        
      </header>
      <p>This is part 3 of a multipart series where we will look at getting a website / blog set up with <a href="https://jaspervdj.be/hakyll">hakyll</a> and customized a fair bit.</p>
<ul>
<li><a href="/hakyll-pt-1-setup-and-initial-customization.html">Pt. 1 – Setup &amp; Initial Customization</a></li>
<li><a href="/hakyll-pt-2-generating-a-sitemap-xml-file.html">Pt. 2 – Generating a Sitemap XML File</a></li>
<li>Pt. 3 – Generating RSS and Atom XML Feeds</li>
<li><a href="/hakyll-pt-4-copying-static-files-for-your-build.html">Pt. 4 – Copying Static Files For Your Build</a></li>
<li><a href="/hakyll-pt-5-generating-custom-post-filenames-from-a-title-slug.html">Pt. 5 – Generating Custom Post Filenames From a Title Slug</a></li>
<li><a href="/hakyll-pt-6-pure-builds-with-nix.html">Pt. 6 – Pure Builds With Nix</a></li>
<li><em>(wip) Pt. 7 – Customizing Markdown Compiler Options</em></li>
</ul>
<h2 id="overview">Overview</h2>
<ol>
<li><a href="#hakyll-feed-required-reading">Hakyll Feed Required Reading</a></li>
<li><a href="#hakylls-prebuilt-rss--atom-templates">Hakyll’s Prebuilt RSS &amp; Atom Templates</a></li>
<li><a href="#hakyll-feed-setup">Hakyll Feed Setup</a></li>
<li><a href="#creating-the-atom-rss-xml-files">Creating the Atom &amp; RSS XML Files</a></li>
<li><a href="#unexpected-issue-setting-an-updated-field">Unexpected Issue: Setting an <code>updated</code> Field</a></li>
<li><a href="#using-your-own-rss-atom-templates">Using Your Own RSS &amp; Atom Templates</a></li>
<li><a href="#validating-and-using-our-feeds">Validating and Using Our Feeds</a></li>
</ol>
<h2 id="hakyll-feed-required-reading">Hakyll Feed Required Reading</h2>
<p>There is already a great starter guide at <a href="https://jaspervdj.be/hakyll/tutorials/05-snapshots-feeds.html" class="uri">https://jaspervdj.be/hakyll/tutorials/05-snapshots-feeds.html</a>, so be sure to read this first – it might make it so you don’t have to read <em>this</em> blog post at all.</p>
<h2 id="hakylls-prebuilt-rss--atom-templates">Hakyll’s Prebuilt RSS &amp; Atom Templates</h2>
<p>Thankfully, hakyll aready comes with prebuilt RSS and Atom templates! You can find the source here: <a href="https://github.com/jaspervdj/hakyll/tree/master/data/templates" class="uri">https://github.com/jaspervdj/hakyll/tree/master/data/templates</a>. While you won’t need to copy and paste nor even directly use these files, you should look them over to see what fields they are expecting. There are two levels to be aware of: the feed itself and each individual feed item.</p>
<h3 id="feed-level">Feed-Level</h3>
<p>The feed itself is looking for the following, and you’ll provide these through a <code>FeedConfiguration</code> that we’ll discuss in a moment. Here are the fields the <code>atom.xml</code> and <code>rss.xml</code> templates are expecting:</p>
<ul>
<li><code>title</code> (title of feed)</li>
<li><code>description</code> (description of feed)</li>
<li><code>authorName</code> (feed author name)</li>
<li><code>authorEmail</code> (feed author email)</li>
<li><code>root</code> (your website)</li>
<li><code>updated</code> (feed last updated at; should be done for you)</li>
<li><code>body</code> (feed body; should be done for you)</li>
<li><code>url</code> (path to the XML file; based off of a <code>create ["rss.xml"]</code> function that we’ll discuss)</li>
</ul>
<h3 id="feed-item-level">Feed Item-Level</h3>
<p>Each feed item, or <em>entry</em>, expects the following:</p>
<ul>
<li><code>title</code> (title of the entry)</li>
<li><code>root</code> (your website)</li>
<li><code>url</code> (path to resource)</li>
<li><code>published</code> (published date; <code>"%Y-%m-%dT%H:%M:%SZ"</code> format; should be done for you via hakyll’s <code>dateField</code> context)</li>
<li><code>updated</code> (updated date; <code>"%Y-%m-%dT%H:%M:%SZ"</code> format; should be done for you, unless you provide you own)</li>
</ul>
<hr />
<p>Now that you know what sort of data are expected, let’s begin.</p>
<h2 id="hakyll-feed-setup">Hakyll Feed Setup</h2>
<p>As is introduced in <a href="https://jaspervdj.be/hakyll/tutorials/05-snapshots-feeds.html">the required hakyll feed reading</a>, we need to create a <code>FeedConfiguration</code>. If you’d like to see the <code>FeedConfiguration</code> data constructor, you can view it here: <a href="https://github.com/jaspervdj/hakyll/blob/f3a17454fae3b140ada30ebef13f508179f4cd0d/lib/Hakyll/Web/Feed.hs#L63-L75" class="uri">https://github.com/jaspervdj/hakyll/blob/f3a17454fae3b140ada30ebef13f508179f4cd0d/lib/Hakyll/Web/Feed.hs#L63-L75</a>.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1"></a><span class="ot">feedConfiguration ::</span> <span class="dt">FeedConfiguration</span></span>
<span id="cb1-2"><a href="#cb1-2"></a>feedConfiguration <span class="ot">=</span></span>
<span id="cb1-3"><a href="#cb1-3"></a>    <span class="dt">FeedConfiguration</span></span>
<span id="cb1-4"><a href="#cb1-4"></a>        { feedTitle       <span class="ot">=</span> <span class="st">&quot;My Blog&quot;</span></span>
<span id="cb1-5"><a href="#cb1-5"></a>        , feedDescription <span class="ot">=</span> <span class="st">&quot;Posts about x, y &amp; z&quot;</span></span>
<span id="cb1-6"><a href="#cb1-6"></a>        , feedAuthorName  <span class="ot">=</span> <span class="st">&quot;My Name&quot;</span></span>
<span id="cb1-7"><a href="#cb1-7"></a>        , feedAuthorEmail <span class="ot">=</span> <span class="st">&quot;me@myemail.com&quot;</span></span>
<span id="cb1-8"><a href="#cb1-8"></a>        , feedRoot        <span class="ot">=</span> <span class="st">&quot;https://example.com&quot;</span></span>
<span id="cb1-9"><a href="#cb1-9"></a>        }</span></code></pre></div>
<p>We should next figure out what we want our “feed context” to consist of. The official hakyll feed guide (linked above) is:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1"></a><span class="kw">let</span> feedCtx <span class="ot">=</span> postCtx <span class="ot">`mappend`</span> bodyField <span class="st">&quot;description&quot;</span></span>
<span id="cb2-2"><a href="#cb2-2"></a></span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="co">-- which can be abbreviated to</span></span>
<span id="cb2-4"><a href="#cb2-4"></a></span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="kw">let</span> feedCtx <span class="ot">=</span> postCtx <span class="op">&lt;&gt;</span> bodyField <span class="st">&quot;description&quot;</span></span></code></pre></div>
<p>This will enable you to include the body of your post as the <code>description</code>, but if you provide your own <code>description</code> field in your posts, then this step isn’t necessary. For the mean time, let’s make our own <code>feedCtx</code> function that sticks to the original post.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1"></a><span class="ot">feedCtx ::</span> <span class="dt">Context</span> <span class="dt">String</span></span>
<span id="cb3-2"><a href="#cb3-2"></a>feedCtx <span class="ot">=</span> postCtx <span class="op">&lt;&gt;</span> bodyField <span class="st">&quot;description&quot;</span></span></code></pre></div>
<p>If you’re unsure of what <code>postCtx</code> is, I recommend checking out the <a href="/hakyll-pt-2-generating-a-sitemap-xml-file.html">previous article</a> or viewing the source of this site: <a href="https://github.com/rpearce/robertwpearce.com/blob/858163216f445eb8b6ab3b4304b022b64814b6f8/site.hs#L131-L136" class="uri">https://github.com/rpearce/robertwpearce.com/blob/858163216f445eb8b6ab3b4304b022b64814b6f8/site.hs#L131-L136</a>.</p>
<h2 id="creating-the-atom--rss-xml-files">Creating the Atom &amp; RSS XML Files</h2>
<p>Here is what <a href="https://jaspervdj.be/hakyll/tutorials/05-snapshots-feeds.html">the official hakyll feed guide</a> recommends:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb4-1"><a href="#cb4-1"></a>create [<span class="st">&quot;atom.xml&quot;</span>] <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb4-2"><a href="#cb4-2"></a>    route idRoute</span>
<span id="cb4-3"><a href="#cb4-3"></a>    compile <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb4-4"><a href="#cb4-4"></a>        <span class="kw">let</span> feedCtx <span class="ot">=</span> postCtx <span class="ot">`mappend`</span> bodyField <span class="st">&quot;description&quot;</span></span>
<span id="cb4-5"><a href="#cb4-5"></a>        posts <span class="ot">&lt;-</span> <span class="fu">fmap</span> (<span class="fu">take</span> <span class="dv">10</span>) <span class="op">.</span> recentFirst <span class="op">=&lt;&lt;</span></span>
<span id="cb4-6"><a href="#cb4-6"></a>            loadAllSnapshots <span class="st">&quot;posts/*&quot;</span> <span class="st">&quot;content&quot;</span></span>
<span id="cb4-7"><a href="#cb4-7"></a>        renderAtom myFeedConfiguration feedCtx posts</span></code></pre></div>
<p>This is great! However, if we want to generate both an <code>atom.xml</code> feed and an <code>rss.xml</code> feed, we’ll end up with almost duplicated code:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb5-1"><a href="#cb5-1"></a>create [<span class="st">&quot;rss.xml&quot;</span>] <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb5-2"><a href="#cb5-2"></a>    route idRoute</span>
<span id="cb5-3"><a href="#cb5-3"></a>    compile <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb5-4"><a href="#cb5-4"></a>        <span class="kw">let</span> feedCtx <span class="ot">=</span> postCtx <span class="ot">`mappend`</span> bodyField <span class="st">&quot;description&quot;</span></span>
<span id="cb5-5"><a href="#cb5-5"></a>        posts <span class="ot">&lt;-</span> <span class="fu">fmap</span> (<span class="fu">take</span> <span class="dv">10</span>) <span class="op">.</span> recentFirst <span class="op">=&lt;&lt;</span></span>
<span id="cb5-6"><a href="#cb5-6"></a>            loadAllSnapshots <span class="st">&quot;posts/*&quot;</span> <span class="st">&quot;content&quot;</span></span>
<span id="cb5-7"><a href="#cb5-7"></a>        renderRss myFeedConfiguration feedCtx posts</span></code></pre></div>
<p>It looks like all the feed compilation is exactly the same except for the <code>renderAtom</code> and <code>renderRss</code> functions that come bundled with hakyll. With this in mind, let’s write our own feed compiler and reduce as much boilerplate as we reasonably can.</p>
<p>To start out, let’s see what we want our top-level end result to be:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb6-1"><a href="#cb6-1"></a>create [<span class="st">&quot;atom.xml&quot;</span>] <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb6-2"><a href="#cb6-2"></a>    route idRoute</span>
<span id="cb6-3"><a href="#cb6-3"></a>    compile (feedCompiler renderAtom)</span>
<span id="cb6-4"><a href="#cb6-4"></a></span>
<span id="cb6-5"><a href="#cb6-5"></a></span>
<span id="cb6-6"><a href="#cb6-6"></a>create [<span class="st">&quot;rss.xml&quot;</span>] <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb6-7"><a href="#cb6-7"></a>    route idRoute</span>
<span id="cb6-8"><a href="#cb6-8"></a>    compile (feedCompiler renderRss)</span></code></pre></div>
<p>While we could potentially abstract this further, this leaves wiggle room for customizing the <code>route</code> for whatever reason you may want to.</p>
<p>This <code>feedCompiler</code> is a function that we need to write that will house the missing logic. Let’s look at its type:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb7-1"><a href="#cb7-1"></a><span class="ot">feedCompiler ::</span> <span class="dt">FeedConfiguration</span></span>
<span id="cb7-2"><a href="#cb7-2"></a>                <span class="ot">-&gt;</span> <span class="dt">Context</span> <span class="dt">String</span></span>
<span id="cb7-3"><a href="#cb7-3"></a>                <span class="ot">-&gt;</span> [<span class="dt">Item</span> <span class="dt">String</span>]</span>
<span id="cb7-4"><a href="#cb7-4"></a>                <span class="ot">-&gt;</span> <span class="dt">Compiler</span> (<span class="dt">Item</span> <span class="dt">String</span>)</span>
<span id="cb7-5"><a href="#cb7-5"></a>                <span class="ot">-&gt;</span> <span class="dt">Compiler</span> (<span class="dt">Item</span> <span class="dt">String</span>)</span></code></pre></div>
<p>The first 4 parameters describe the types of both <code>renderAtom</code> and <code>renderRss</code> (they’re the same). For reading’s sake, let’s set those to a type alias called <code>FeedRenderer</code>:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb8-1"><a href="#cb8-1"></a><span class="kw">type</span> <span class="dt">FeedRenderer</span> <span class="ot">=</span></span>
<span id="cb8-2"><a href="#cb8-2"></a>    <span class="dt">FeedConfiguration</span></span>
<span id="cb8-3"><a href="#cb8-3"></a>    <span class="ot">-&gt;</span> <span class="dt">Context</span> <span class="dt">String</span></span>
<span id="cb8-4"><a href="#cb8-4"></a>    <span class="ot">-&gt;</span> [<span class="dt">Item</span> <span class="dt">String</span>]</span>
<span id="cb8-5"><a href="#cb8-5"></a>    <span class="ot">-&gt;</span> <span class="dt">Compiler</span> (<span class="dt">Item</span> <span class="dt">String</span>)</span></code></pre></div>
<p>And now we can define our feed but do it in a slightly cleaner way:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb9-1"><a href="#cb9-1"></a><span class="ot">feedCompiler ::</span> <span class="dt">FeedRenderer</span> <span class="ot">-&gt;</span> <span class="dt">Compiler</span> (<span class="dt">Item</span> <span class="dt">String</span>)</span>
<span id="cb9-2"><a href="#cb9-2"></a>feedCompiler renderer <span class="ot">=</span></span>
<span id="cb9-3"><a href="#cb9-3"></a>    renderer feedConfiguration feedCtx</span>
<span id="cb9-4"><a href="#cb9-4"></a>        <span class="op">=&lt;&lt;</span> <span class="fu">fmap</span> (<span class="fu">take</span> <span class="dv">10</span>) <span class="op">.</span> recentFirst</span>
<span id="cb9-5"><a href="#cb9-5"></a>        <span class="op">=&lt;&lt;</span> loadAllSnapshots <span class="st">&quot;posts/*&quot;</span> <span class="st">&quot;content&quot;</span></span></code></pre></div>
<h2 id="using-your-own-rss--atom-templates">Using Your Own RSS &amp; Atom Templates</h2>
<p>Thanks to <a href="https://abhinavsarkar.net/">Abhinav Sarkar</a> on <a href="https://lobste.rs/s/6pdk3c/hakyll_pt_3_generating_rss_atom_xml_feeds">lobste.rs</a>, I was pointed to a pull request, <a href="https://github.com/jaspervdj/hakyll/pull/652" class="uri">https://github.com/jaspervdj/hakyll/pull/652</a>, that allows hakyll users to use their own feed templates. Here is some example usage from the PR:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb10-1"><a href="#cb10-1"></a><span class="ot">customRenderAtom ::</span> <span class="dt">FeedConfiguration</span> <span class="ot">-&gt;</span> <span class="dt">Context</span> <span class="dt">String</span> <span class="ot">-&gt;</span> [<span class="dt">Item</span> <span class="dt">String</span>] <span class="ot">-&gt;</span> <span class="dt">Compiler</span> (<span class="dt">Item</span> <span class="dt">String</span>)</span>
<span id="cb10-2"><a href="#cb10-2"></a>customRenderAtom config context items <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb10-3"><a href="#cb10-3"></a>  atomTemplate     <span class="ot">&lt;-</span> unsafeCompiler <span class="op">$</span> <span class="fu">readFile</span> <span class="st">&quot;templates/atom.xml&quot;</span></span>
<span id="cb10-4"><a href="#cb10-4"></a>  atomItemTemplate <span class="ot">&lt;-</span> unsafeCompiler <span class="op">$</span> <span class="fu">readFile</span> <span class="st">&quot;templates/atom-item.xml&quot;</span></span>
<span id="cb10-5"><a href="#cb10-5"></a>  renderAtomWithTemplates atomTemplate atomItemTemplate config context items</span></code></pre></div>
<h2 id="validating-and-using-our-feeds">Validating and Using Our Feeds</h2>
<p>If you’ve made it this far and have successfully generated and published your <code>atom.xml</code> and/or <code>rss.xml</code> files, see if they’re valid! Head to <a href="https://validator.w3.org/feed/" class="uri">https://validator.w3.org/feed/</a> and see if yours validate.</p>
<p>You can check out your new feed in an RSS/Atom feed reader such as the browser plugin <a href="https://nodetics.com/feedbro/">FeedBro</a> or any others.</p>
<h2 id="unexpected-issue-setting-an-updated-field">Unexpected Issue: Setting an <code>updated</code> Field</h2>
<p>I ran into a feed validation problem where, in a few posts, I manually set the <code>updated</code> field to a <em>date</em> – not <em>datetime</em> – and thus invalidated my feed. The value <code>2017-06-30</code> needed to be in the <code>"%Y-%m-%dT%H:%M:%SZ"</code> format, or <code>2017-06-30T00:00:00Z</code>. This led me down a rabbit hole that ended in me essentially repurposing the <code>dateField</code> code from hakyll (<a href="https://github.com/jaspervdj/hakyll/blob/c85198d8cb6ce055c788e287c7f2470eac0aad36/lib/Hakyll/Web/Template/Context.hs#L273-L321" class="uri">https://github.com/jaspervdj/hakyll/blob/c85198d8cb6ce055c788e287c7f2470eac0aad36/lib/Hakyll/Web/Template/Context.hs#L273-L321</a>). While I tried to use <code>parseTimeM</code> and <code>formatTime</code> from <a href="https://hackage.haskell.org/package/time-1.9.2/docs/Data-Time-Format.html"><code>Data.Time.Format</code></a> in my own way, I couldn’t make it as simple as I wanted, thus leading to me giving up and using what was already there. Here’s what I did:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb11-1"><a href="#cb11-1"></a><span class="ot">feedCtx ::</span> <span class="dt">Context</span> <span class="dt">String</span></span>
<span id="cb11-2"><a href="#cb11-2"></a>feedCtx <span class="ot">=</span></span>
<span id="cb11-3"><a href="#cb11-3"></a>    updatedField <span class="op">&lt;&gt;</span> <span class="co">-- THIS IS NEW</span></span>
<span id="cb11-4"><a href="#cb11-4"></a>    postCtx      <span class="op">&lt;&gt;</span></span>
<span id="cb11-5"><a href="#cb11-5"></a>    bodyField <span class="st">&quot;description&quot;</span></span>
<span id="cb11-6"><a href="#cb11-6"></a></span>
<span id="cb11-7"><a href="#cb11-7"></a></span>
<span id="cb11-8"><a href="#cb11-8"></a><span class="ot">updatedField ::</span> <span class="dt">Context</span> <span class="dt">String</span></span>
<span id="cb11-9"><a href="#cb11-9"></a>updatedField <span class="ot">=</span> field <span class="st">&quot;updated&quot;</span> <span class="op">$</span> \i <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb11-10"><a href="#cb11-10"></a>    <span class="kw">let</span> locale <span class="ot">=</span> defaultTimeLocale</span>
<span id="cb11-11"><a href="#cb11-11"></a>    time <span class="ot">&lt;-</span> getUpdatedUTC locale <span class="op">$</span> itemIdentifier i</span>
<span id="cb11-12"><a href="#cb11-12"></a>    <span class="fu">return</span> <span class="op">$</span> formatTime locale <span class="st">&quot;%Y-%m-%dT%H:%M:%SZ&quot;</span> time</span>
<span id="cb11-13"><a href="#cb11-13"></a></span>
<span id="cb11-14"><a href="#cb11-14"></a></span>
<span id="cb11-15"><a href="#cb11-15"></a><span class="ot">getUpdatedUTC ::</span> <span class="dt">MonadMetadata</span> m <span class="ot">=&gt;</span> <span class="dt">TimeLocale</span> <span class="ot">-&gt;</span> <span class="dt">Identifier</span> <span class="ot">-&gt;</span> m <span class="dt">Clock.UTCTime</span></span>
<span id="cb11-16"><a href="#cb11-16"></a>getUpdatedUTC locale id&#39; <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb11-17"><a href="#cb11-17"></a>    metadata <span class="ot">&lt;-</span> getMetadata id&#39;</span>
<span id="cb11-18"><a href="#cb11-18"></a>    <span class="kw">let</span> tryField k fmt <span class="ot">=</span> lookupString k metadata <span class="op">&gt;&gt;=</span> parseTime&#39; fmt</span>
<span id="cb11-19"><a href="#cb11-19"></a>    <span class="fu">maybe</span> empty&#39; <span class="fu">return</span> <span class="op">$</span> msum [tryField <span class="st">&quot;updated&quot;</span> fmt <span class="op">|</span> fmt <span class="ot">&lt;-</span> formats]</span>
<span id="cb11-20"><a href="#cb11-20"></a>  <span class="kw">where</span></span>
<span id="cb11-21"><a href="#cb11-21"></a>    empty&#39;     <span class="ot">=</span> <span class="fu">fail</span> <span class="op">$</span> <span class="st">&quot;Hakyll.Web.Template.Context.getUpdatedUTC: &quot;</span> <span class="op">++</span> <span class="st">&quot;could not parse time for &quot;</span> <span class="op">++</span> <span class="fu">show</span> id&#39;</span>
<span id="cb11-22"><a href="#cb11-22"></a>    parseTime&#39; <span class="ot">=</span> parseTimeM <span class="dt">True</span> locale</span>
<span id="cb11-23"><a href="#cb11-23"></a>    formats    <span class="ot">=</span></span>
<span id="cb11-24"><a href="#cb11-24"></a>        [ <span class="st">&quot;%a, %d %b %Y %H:%M:%S %Z&quot;</span></span>
<span id="cb11-25"><a href="#cb11-25"></a>        , <span class="st">&quot;%Y-%m-%dT%H:%M:%S%Z&quot;</span></span>
<span id="cb11-26"><a href="#cb11-26"></a>        , <span class="st">&quot;%Y-%m-%d %H:%M:%S%Z&quot;</span></span>
<span id="cb11-27"><a href="#cb11-27"></a>        , <span class="st">&quot;%Y-%m-%d&quot;</span></span>
<span id="cb11-28"><a href="#cb11-28"></a>        , <span class="st">&quot;%B %e, %Y %l:%M %p&quot;</span></span>
<span id="cb11-29"><a href="#cb11-29"></a>        , <span class="st">&quot;%B %e, %Y&quot;</span></span>
<span id="cb11-30"><a href="#cb11-30"></a>        , <span class="st">&quot;%b %d, %Y&quot;</span></span>
<span id="cb11-31"><a href="#cb11-31"></a>        ]</span></code></pre></div>
<p>Woah! We need to break down what’s happening here.</p>
<h3 id="feedctx"><code>feedCtx</code></h3>
<p>The addition to <code>feedCtx</code> is before our <code>postCtx</code> because of the <code>mappend</code> precedence of what comes out of the pipeline with the value <code>updated</code>. We want first rights to transforming the <code>updated</code> field, so it needs to come first.</p>
<h3 id="updatedfield"><code>updatedField</code></h3>
<p>This function is a <code>Context</code> that leans on hakyll’s <code>field</code> function to say that we want to work with the <code>updated</code> field and then do some Monad stuff with time. The tl;dr is that we send the field’s current value off in order to get a <code>UTCTime</code> value back, and then we format it to be the way we need it.</p>
<h3 id="getupdatedutc"><code>getUpdatedUTC</code></h3>
<p>It’s really not as bad as it looks! The root of this function does two things:</p>
<ol>
<li>looks up the the <code>updated</code> value in the metadata</li>
<li>tries to parse it using a bunch of different formats</li>
</ol>
<p>If it can’t do these things, it simply <code>fail</code>s.</p>
<hr />
<p>Yes, I could have simply written my <code>updated</code> field in the correct format. But where’s the fun in that? I would hate for my feed to silently invalidate itself over something so simple!</p>
<h2 id="wrapping-up">Wrapping Up</h2>
<p>Whew! We dove in to generating Atom &amp; RSS XML feeds with hakyll, uncovered a nice refactor opportunity via <code>feedCompiler</code>, learned how to validate our feeds and ultimately learned about how a seemingly harmless <code>updated</code> date could prevent us from having a totally valid feed!</p>
<p>Next up:</p>
<ul>
<li><a href="/hakyll-pt-4-copying-static-files-for-your-build.html">Pt. 4 – Copying Static Files For Your Build</a></li>
<li><a href="/hakyll-pt-5-generating-custom-post-filenames-from-a-title-slug.html">Pt. 5 – Generating Custom Post Filenames From a Title Slug</a></li>
<li><em>(wip) Pt. 6 – Customizing Markdown Compiler Options</em></li>
</ul>
<hr />
<p>Thank you for reading! <br /> Robert</p>
    </section>
  </article>
</main>

<footer>
  <section class="subscribe section--padded">
  <div class="layout--constrained">
    <h2 class="subscribe__header">Get notified of new posts</h2>

    <form action="//robertwpearce.us13.list-manage.com/subscribe/post?u=2df44e8960266388bff165fa6&amp;id=ee2f2a3737" method="post" name="mc-embedded-subscribe-form" target="_blank" novalidate class="subscribe__form">
      <div style="position: absolute; left: -5000px;" aria-hidden="true">
        <input type="text" name="b_2df44e8960266388bff165fa6_ee2f2a3737" tabindex="-1" value="">
      </div>
      <div class="subscribe__section">
        <input type="email" value="" id="mce-EMAIL" class="subscribe__input" name="EMAIL" placeholder="you@greatemail.com" aria-label="Email Address">
        <input type="submit" value="Subscribe" name="subscribe" class="subscribe__submit">
      </div>
      <small>Note: I will <em>never</em> give out your email nor spam you. Unsubscribe at any time.</small>
    </form>
    <p>
      <small>(or subscribe to the <a href="/atom.xml" class="subscribe__link">atom</a> or <a class="subscribe__link" href="/rss.xml">rss</a> feeds)</small>
    </p>
  </div>
</section>

</footer>

    <script async src="/js/dist/index.js"></script>
  </body>
</html>
