<!DOCTYPE html><html lang="en"><head><title>Elm, Geocoding & DarkSky: Pt. 3 – Fetching the Current Weather</title><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1"><meta name="description" content="In Part 3 we query the DarkSky API with our geocoded address"><meta property="og:site_name" content="Robert Pearce | Freelance Software Developer"><meta property="og:title" content="Elm, Geocoding & DarkSky: Pt. 3 – Fetching the Current Weather"><meta property="og:url" content="https://robertwpearce.com/blog/elm-geocoding-and-darksky-pt-3-fetching-the-current-weather.html"><meta property="og:description" content="In Part 3 we query the DarkSky API with our geocoded address"><meta property="og:image" content="/images/london-rain.jpg"><meta property="og:type" content="article"><meta property="twitter:card" content="summary_large_image"><meta property="twitter:site" content="Robert Pearce | Freelance Software Developer"><meta property="twitter:title" content="Elm, Geocoding & DarkSky: Pt. 3 – Fetching the Current Weather"><meta property="twitter:description" content="In Part 3 we query the DarkSky API with our geocoded address"><meta property="twitter:image" content="/images/london-rain.jpg"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="https://robertwpearce.com/blog/elm-geocoding-and-darksky-pt-3-fetching-the-current-weather.html"><link rel="stylesheet" href="/styles.css"><meta name="google-site-verification" content="QX4bn65yOXBfgnwxlO09yIBc1H8blur-Erx3lmsDVhU"><link href="//fonts.googleapis.com/css?family=Lato:400" rel="stylesheet" type="text/css"></head><body><main><nav><div class="layout--constrained"><ul class="nav--main list--bare list--horz"><li><a href="/">Home</a></li><li><a href="mailto:me@robertwpearce.com?subject=Work Inquiry">Hire Me</a></li></ul></div></nav><article class="article"><div class="article__background" style="background-image: url('/images/london-rain.jpg')"><header class="article__bgHeader"><div class="layout--constrained"><div class="article__bgTitleContainer"><h1 class="heading--trim"><a href="/blog/elm-geocoding-and-darksky-pt-3-fetching-the-current-weather.html">Elm, Geocoding & DarkSky: Pt. 3 – Fetching the Current Weather</a></h1><div class="article__subHeader"><small>Aug 18, 2017</small> <small class="photoCred">[photo credit <a href="https://unsplash.com/@anjimenon">Anjana Menon</a>]</small></div></div></div></header></div><div class="layout--constrained"><header class="article__header heading--fatBottomBorder"><h1 class="heading--trim"><a href="/blog/elm-geocoding-and-darksky-pt-3-fetching-the-current-weather.html">Elm, Geocoding & DarkSky: Pt. 3 – Fetching the Current Weather</a></h1><small>Aug 18, 2017</small></header><p>This is part 3 of a multipart series where we will be building a small weather forecast app using <a href="http://elm-lang.org/">Elm</a>, <a href="https://developers.google.com/maps/documentation/geocoding/start">Google&#39;s Geocoding API</a> and the <a href="https://darksky.net/dev/">DarkSky API</a>. Instead of doing everything in one massive post, I&#39;ve broken the steps down into parts of a series. Here is the series plan:</p><ul><li><a href="/blog/elm-geocoding-and-darksky-pt-1-setup-elm-and-proxy-servers.html">Pt. 1 – Setup Elm &amp; Proxy Servers</a></li><li><a href="/blog/elm-geocoding-and-darksky-pt-2-geocoding-an-address.html">Pt. 2 – Geocoding an Address</a></li><li>Pt. 3 – Fetching the Current Weather</li><li><span class="faded">(wip) Pt. 4 – Fetching the Weather Forecast</span></li><li><span class="faded">(wip) Pt. 5 – Extracting our Elm Code</span></li><li><span class="faded">(wip) Pt. 6 – Styling in Elm</span></li></ul><p>If you&#39;d like to code along with this tutorial, check out <a href="/blog/elm-geocoding-and-darksky-pt-1-setup-elm-and-proxy-servers.html">part 1</a> and <a href="/blog/elm-geocoding-and-darksky-pt-2-fetching-the-current-weather.html">part 2</a> first to get set up.</p><p><em>Note: to learn more about the Elm language and syntax, check out the <a href="https://www.elm-tutorial.org/en/">Elm Tutorial</a>, the <a href="https://egghead.io/courses/start-using-elm-to-build-web-applications">EggHead.io Elm course</a>, subscribe to <a href="https://www.dailydrip.com/topics/elm">DailyDrip&#39;s Elm Topic</a>, <a href="http://courses.knowthen.com">James Moore&#39;s Elm Courses</a> or check out <a href="http://exercism.io/languages/elm/about">Elm on exercism.io</a>.</em></p><h2><a class="heading--link" name="overview" href="#overview"><span>Overview</span></a></h2><p>In this post we will use Elm to fetch and display the current weather based on the geocode data we receive from an input field.</p><h2><a class="heading--link" name="project-source-code" href="#project-source-code"><span>Project Source Code</span></a></h2><p>The project we&#39;re making will be broken into parts here (branches will be named for each part): <a href="https://github.com/rpearce/elm-geocoding-darksky/">https://github.com/rpearce/elm-geocoding-darksky/</a>. Be sure to check out the other branches to see the other parts as they become available.</p><p>The code for this part is located in the <code>pt-3</code> branch: <a href="https://github.com/rpearce/elm-geocoding-darksky/tree/pt-3">https://github.com/rpearce/elm-geocoding-darksky/tree/pt-3</a>.</p><h2><a class="heading--link" name="steps-for-today" href="#steps-for-today"><span>Steps for Today</span></a></h2><ol><li>Understanding DarkSky&#39;s response data</li><li>Modeling the DarkSky response data</li><li>Creating DarkSky JSON decoders</li><li>Writing our fetchWeather HTTP function</li><li>Calling fetchWeather and handling the response</li><li>Displaying the current weather in our view</li></ol><h2><a class="heading--link" name="1-understanding-darksky-39-s-response-data" href="#1-understanding-darksky-39-s-response-data"><span>1. Understanding DarkSky&#39;s response data</span></a></h2><p>Let&#39;s get the weather data for Auckland, NZ (-36.8484597,174.7633315). If we start up our <a href="https://github.com/rpearce/DarkSky-proxy">DarkSky proxy</a> and run</p><pre><code class="hljs bash">λ curl localhost:5051/forecast/-36.8484597,174.7633315
</code></pre><p>then we will see response data like this:</p><pre><code class="hljs json">{
  <span class="hljs-attr">"timezone"</span>: <span class="hljs-string">"Pacific\/Auckland"</span>,
  <span class="hljs-attr">"currently"</span>: {
    <span class="hljs-attr">"summary"</span>: <span class="hljs-string">"Overcast"</span>,
    <span class="hljs-attr">"icon"</span>: <span class="hljs-string">"cloudy"</span>,
    <span class="hljs-attr">"temperature"</span>: <span class="hljs-number">61.42</span>,
    ...
  },
  <span class="hljs-attr">"hourly"</span>: { ... }
  <span class="hljs-string">"daily"</span>: { ... }
}
</code></pre><p>While all we care about are the <code>summary</code>, <code>icon</code> and <code>temperature</code> properties within the top-level <code>currently</code> property, we will only use <code>temperature</code> in this part.</p><p>Disclaimer: DarkSky units are in <code>us</code> by default. You can specify other unit types by appending a <code>units</code> query parameter to the end like this:</p><pre><code class="hljs bash">λ curl localhost:5051/forecast/-36.8484597,174.7633315?units=si
</code></pre><p>Read more about <a href="https://darksky.net/dev/docs/forecast">DarkSky request parameters in the DarkSky docs</a> to customize your response data.</p><p>Now that we&#39;ve got our data in the correct units, let&#39;s model this data in Elm!</p><h2><a class="heading--link" name="2-modeling-the-darksky-response-data" href="#2-modeling-the-darksky-response-data"><span>2. Modeling the DarkSky response data</span></a></h2><p>Based on our DarkSky response, let&#39;s list out what we&#39;re looking at:</p><ul><li>an object, <code>currently</code>, which has 3 notable properties:<ul><li>a string, <code>summary</code></li><li>a string, <code>icon</code></li><li>a float, <code>temperature</code></li></ul></li></ul><p>Since we have two levels of data, <code>currently</code> and its child properties, let&#39;s create two type aliases to represent this data.</p><pre><code class="hljs elm"><span class="hljs-keyword">type</span> <span class="hljs-keyword">alias</span> <span class="hljs-type">Weather</span> =
    { currently : <span class="hljs-type">WeatherCurrently</span>
    }


<span class="hljs-keyword">type</span> <span class="hljs-keyword">alias</span> <span class="hljs-type">WeatherCurrently</span> =
    { icon : <span class="hljs-type">String</span>
    , summary : <span class="hljs-type">String</span>
    , temperature : <span class="hljs-type">Float</span>
    }
</code></pre><p>And now we can add a property to our <code>Model</code> type alias that can be of our <code>Weather</code> type:</p><pre><code class="hljs elm"><span class="hljs-keyword">type</span> <span class="hljs-keyword">alias</span> <span class="hljs-type">Model</span> =
    { address : <span class="hljs-type">String</span>
    , coords : <span class="hljs-type">Coords</span>
    , weather : <span class="hljs-type">Weather</span>
    }
</code></pre><p>Uh oh! Our <code>Model</code> has a defaults function called <code>initialModel</code>, and now that we&#39;ve added <code>weather</code> into the mix, we&#39;ll need to give that default values, as well:</p><pre><code class="hljs elm"><span class="hljs-title">initialModel</span> : <span class="hljs-type">Model</span>
<span class="hljs-title">initialModel</span> =
    { address = <span class="hljs-string">""</span>
    , coords = ( <span class="hljs-number">0</span>, <span class="hljs-number">0</span> )
    , weather = initialWeather
    }


<span class="hljs-title">initialWeather</span> : <span class="hljs-type">Weather</span>
<span class="hljs-title">initialWeather</span> =
    { currently = initialWeatherCurrently
    }


<span class="hljs-title">initialWeatherCurrently</span> : <span class="hljs-type">WeatherCurrently</span>
<span class="hljs-title">initialWeatherCurrently</span> =
    { icon = <span class="hljs-string">"–"</span>
    , summary = <span class="hljs-string">"–"</span>
    , temperature = <span class="hljs-number">0</span>
    }
</code></pre><p>These are defaults that we provide in the event that we have no data to work with (initially or if something goes wrong).</p><h2><a class="heading--link" name="3-creating-darksky-json-decoders" href="#3-creating-darksky-json-decoders"><span>3. Creating DarkSky JSON decoders</span></a></h2><p>Just as we did in the <a href="/blog/elm-geocoding-and-darksky-pt-2-geocoding-an-address.html#4-creating-json-decoders">geocoding post section on JSON decoding</a>, we want to leverage <a href="https://github.com/NoRedInk/elm-decode-pipeline">NoRedInk&#39;s elm-decode-pipeline</a> to define how our JSON response should be structured and thus parsed.</p><pre><code class="hljs elm"><span class="hljs-title">decodeWeather</span> : <span class="hljs-type">Decoder</span> <span class="hljs-type">Weather</span>
<span class="hljs-title">decodeWeather</span> =
    decode <span class="hljs-type">Weather</span>
        |&gt; required <span class="hljs-string">"currently"</span> decodeWeatherCurrently


<span class="hljs-title">decodeWeatherCurrently</span> : <span class="hljs-type">Decoder</span> <span class="hljs-type">WeatherCurrently</span>
<span class="hljs-title">decodeWeatherCurrently</span> =
    decode <span class="hljs-type">WeatherCurrently</span>
        |&gt; required <span class="hljs-string">"icon"</span> string
        |&gt; required <span class="hljs-string">"summary"</span> string
        |&gt; required <span class="hljs-string">"temperature"</span> float
</code></pre><p>While we could use <a href="http://package.elm-lang.org/packages/elm-lang/core/5.1.1/Json-Decode#at">Json.Decode.at</a> to potentially have less code, there is absolutely nothing wrong with being verbose if it leads to clarity.</p><h2><a class="heading--link" name="4-writing-our-fetchweather-http-function" href="#4-writing-our-fetchweather-http-function"><span>4. Writing our fetchWeather HTTP function</span></a></h2><p>We know that we&#39;re going to have to send latitude and longitude <code>Coords</code> to our <a href="https://github.com/rpearce/DarkSky-proxy">DarkSky proxy server</a>, as well as any additional options, so let&#39;s define the URL for that and the fetching function <a href="/blog/elm-geocoding-and-darksky-pt-2-geocoding-an-address.html#8-making-our-request">just like we did for geocoding</a>.</p><pre><code class="hljs elm"><span class="hljs-title">weatherUrl</span> : <span class="hljs-type">Coords</span> -&gt; <span class="hljs-type">String</span>
<span class="hljs-title">weatherUrl</span> ( lat, lng ) =
    <span class="hljs-string">"http://localhost:5051/forecast/"</span>
        ++ (toString lat)
        ++ <span class="hljs-string">","</span>
        ++ (toString lng)
        <span class="hljs-comment">-- this is where you can add your query params</span>


<span class="hljs-title">fetchWeather</span> : <span class="hljs-type">Coords</span> -&gt; <span class="hljs-type">Cmd</span> <span class="hljs-type">Msg</span>
<span class="hljs-title">fetchWeather</span> coords =
    <span class="hljs-type">Http</span>.get (weatherUrl coords) decodeWeather
        |&gt; <span class="hljs-type">Http</span>.send <span class="hljs-type">ReceiveWeather</span>
</code></pre><p>To define an HTTP request in Elm, we need</p><ul><li>✅ a URL to point to</li><li>✅ a package like Http to help us build the request</li><li>✅ a decoder to handle parsing the response data</li><li>🤷 a <code>Msg</code> type that our <code>update</code> function can pattern match on</li></ul><p>Right! We can&#39;t forget to add <code>ReceiveWeather</code> as a <code>Msg</code> type. It should be almost the same as <code>ReceiveGeocoding</code>:</p><pre><code class="hljs elm"><span class="hljs-keyword">type</span> <span class="hljs-type">Msg</span>
    = <span class="hljs-type">UpdateAddress</span> <span class="hljs-type">String</span>
    | <span class="hljs-type">SendAddress</span>
    | <span class="hljs-type">ReceiveGeocoding</span> (<span class="hljs-type">Result</span> <span class="hljs-type">Http</span>.<span class="hljs-type">Error</span> <span class="hljs-type">GeoModel</span>)
    | <span class="hljs-type">ReceiveWeather</span> (<span class="hljs-type">Result</span> <span class="hljs-type">Http</span>.<span class="hljs-type">Error</span> <span class="hljs-type">Weather</span>)
    | <span class="hljs-type">NoOp</span>
</code></pre><h2><a class="heading--link" name="5-calling-fetchweather-and-handling-the-response" href="#5-calling-fetchweather-and-handling-the-response"><span>5. Calling fetchWeather and handling the response</span></a></h2><p>When we <a href="https://robertwpearce.com/blog/elm-geocoding-and-darksky-pt-2-geocoding-an-address.html#9-handling-the-geocode-response">handled our geocode response in the prior post</a>, inside of <code>ReceiveGeocoding</code> we returned <code>( newModel, Cmd.none )</code>, for we had no further actions to take. Instead of our action in this tuple being <code>Cmd.none</code>, let&#39;s instead call our <code>fetchWeather</code> function and pass it our geocoded coordinates:</p><pre><code class="hljs elm"><span class="hljs-title">update</span> : <span class="hljs-type">Msg</span> -&gt; <span class="hljs-type">Model</span> -&gt; ( <span class="hljs-type">Model</span>, <span class="hljs-type">Cmd</span> <span class="hljs-type">Msg</span> )
<span class="hljs-title">update</span> msg model =
    <span class="hljs-keyword">case</span> msg <span class="hljs-keyword">of</span>
        <span class="hljs-comment">-- ...removed for brevity</span>

        <span class="hljs-type">ReceiveGeocoding</span> (<span class="hljs-type">Ok</span> { results, status }) -&gt;
            <span class="hljs-keyword">let</span>
                <span class="hljs-comment">-- ...</span>
                newModel =
                    <span class="hljs-comment">-- ...</span>
            <span class="hljs-keyword">in</span>
                ( newModel, fetchWeather newModel.coords )

        <span class="hljs-comment">-- ...</span>

        <span class="hljs-type">ReceiveWeather</span> (<span class="hljs-type">Ok</span> resp) -&gt;
            ( { model | weather = { currently = resp.currently } }
            , <span class="hljs-type">Cmd</span>.none
            )

        <span class="hljs-type">ReceiveWeather</span> (<span class="hljs-type">Err</span> _) -&gt;
            ( model, <span class="hljs-type">Cmd</span>.none )
</code></pre><p>Again, at the end of <code>ReceiveGeocoding</code>, we return our <code>newModel</code> as well as the command to go and fetch the weather with the coordinates we&#39;re storing on our <code>newModel</code>.</p><p>Whenever the HTTP request and decoding gives us back a result with the <code>Msg</code> type of <code>ReceiveWeather</code>, we then update the weather property on our model record to have the <code>currently</code> data parsed from the decoder.</p><h2><a class="heading--link" name="6-displaying-the-current-weather-in-our-view" href="#6-displaying-the-current-weather-in-our-view"><span>6. Displaying the current weather in our view</span></a></h2><p>Finally, to make sure we&#39;re doing each step correctly, let&#39;s add the temperature to our view:</p><pre><code class="hljs elm"><span class="hljs-title">view</span> : <span class="hljs-type">Model</span> -&gt; <span class="hljs-type">Html</span> <span class="hljs-type">Msg</span>
<span class="hljs-title">view</span> model =
    div []
        [ form [ onSubmit <span class="hljs-type">SendAddress</span> ]
            [ input
                [ type_ "text"
                , placeholder <span class="hljs-string">"City"</span>
                , value model.address
                , onInput <span class="hljs-type">UpdateAddress</span>
                ]
                []
            ]
        , p [] [ text (<span class="hljs-string">"Coords: "</span> ++ (toString model.coords)) ]
        , p [] [ text (<span class="hljs-string">"Weather: "</span> ++ (toString (round model.weather.currently.temperature))) ]
        ]
</code></pre><p>Here we use <a href="http://package.elm-lang.org/packages/elm-lang/core/latest/Basics#round">Basics.round</a> because an approximation is alright for weather.</p><p>Now, when you rebuild your code with <code>./build</code>, open <code>index.html</code> and submit a city/address name, you&#39;ll first see the <code>Coords</code> update on the page and then see the <code>Weather</code> result once it&#39;s done.</p><h2><a class="heading--link" name="wrapping-up" href="#wrapping-up"><span>Wrapping Up</span></a></h2><p>Hooray! We can geocode an address and fetch the weather via two different proxy servers and display a result! That&#39;s great, but our <code>Main.elm</code> file is getting quite large, so stay tuned for the next part where we pull our code into smaller chunks without losing clarity.</p><p>If you&#39;d like to check out the code from this part, it is located here: <a href="https://github.com/rpearce/elm-geocoding-darksky/tree/pt-3">https://github.com/rpearce/elm-geocoding-darksky/tree/pt-3</a>.</p><p>Until next time,<br>Robert</p></div></article><section class="section--padded bg--gray"><div class="layout--constrained"><h2>Get notified of new posts</h2><!-- Begin MailChimp Signup Form --><form action="//robertwpearce.us13.list-manage.com/subscribe/post?u=2df44e8960266388bff165fa6&amp;id=ee2f2a3737" method="post" name="mc-embedded-subscribe-form" target="_blank" novalidate class="form"><div id="mce-responses"><div class="response" id="mce-error-response" style="display:none"></div><div class="response" id="mce-success-response" style="display:none"></div></div><div style="position: absolute; left: -5000px" aria-hidden="true"><input type="text" name="b_2df44e8960266388bff165fa6_ee2f2a3737" tabindex="-1" value=""></div><div class="form__container"><label for="mce-EMAIL" class="form__label">Email Address</label><input type="email" value="" id="mce-EMAIL" class="form__input" name="EMAIL" placeholder="you@greatemail.com"> <input type="submit" value="Subscribe" name="subscribe" class="form__submit"></div><small>Note: I will <em>never</em> give out your email nor spam you. Unsubscribe at any time.</small></form><!--End mc_embed_signup--></div></section></main></body></html>