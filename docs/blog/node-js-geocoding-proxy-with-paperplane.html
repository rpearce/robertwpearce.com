<!DOCTYPE html><html lang="en"><head><title>Node.js Geocoding Proxy with Paperplane</title><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1"><meta name="description" content="Tutorial on creating a location geocoding proxy server in Node.js with Paperplane"><meta property="og:site_name" content="Robert Pearce | Freelance Software Developer"><meta property="og:title" content="Node.js Geocoding Proxy with Paperplane"><meta property="og:url" content="https://robertwpearce.com/blog/node-js-geocoding-proxy-with-paperplane.html"><meta property="og:description" content="Tutorial on creating a location geocoding proxy server in Node.js with Paperplane"><meta property="og:image" content="/images/paper-plane.jpg"><meta property="og:type" content="article"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="https://robertwpearce.com/blog/node-js-geocoding-proxy-with-paperplane.html"><link rel="stylesheet" href="/styles.css"><meta name="google-site-verification" content="QX4bn65yOXBfgnwxlO09yIBc1H8blur-Erx3lmsDVhU"><link href="//fonts.googleapis.com/css?family=Lato:400" rel="stylesheet" type="text/css"></head><body><main><nav><div class="layout--constrained"><ul class="nav--main list--bare list--horz"><li><a href="/">Home</a></li><li><a href="mailto:me@robertwpearce.com?subject=Work Inquiry">Hire Me</a></li></ul></div></nav><article class="article"><div class="article__background" style="background-image: url('/images/paper-plane.jpg')"><div class="overlay"></div><header class="article__backgroundHeader"><div class="layout--constrained"><h1 class="heading--trim"><a href="/blog/node-js-geocoding-proxy-with-paperplane.html">Node.js Geocoding Proxy with Paperplane</a></h1><small><em>June 22, 2017</em></small></div></header></div><div class="layout--constrained"><header class="article__header heading--fatBottomBorder"><h1 class="heading--trim"><a href="/blog/node-js-geocoding-proxy-with-paperplane.html">Node.js Geocoding Proxy with Paperplane</a></h1><small><em>June 22, 2017</em></small></header><div><small class="photoCred">[photo credit <a href="https://www.flickr.com/photos/91559340@N05/8478694579">Ares Nguyen</a>]</small></div><p><em>tl;dr =&gt; use a proxy server when private API keys are involved; <a href="https://github.com/articulate/paperplane">paperplane</a> is a great functional server framework.</em></p><p>Converting addresses, cities and other locations to latitude and logitude and back again is something that is expected in the software application world today. Whether someone is asking for directions, <a href="http://www.brewpublik.com">plotting optimal beer delivery routes</a> or tagging a photo of their cronut in a local cafe, managing location data is an important skillset for developers to have. Numerous services, typically in the form of <a href="https://en.wikipedia.org/wiki/Application_programming_interface">application programming interfaces</a> (APIs), exist to provide folks with ways of accessing this data. Today we&#39;ll be using the <a href="https://developers.google.com/maps/documentation/geocoding/start">Google Maps Geocoding API</a> to complete the task of acquiring the geo-data for any place name; however, we will be creating a <a href="https://nodejs.org">Node.js</a> server as a proxy (a go-between) for our request instead of embedding this request in a browser.</p><h2 id="why-a-proxy-server-">Why A Proxy Server?</h2><p>If you are granted an API key for a service that is private and mapped to you, it is a good idea to keep it that way. If you commit this API key to source control or expose it via your frontend code, then someone could take your key and pretend to be you. In order to avoid this, it is recommended that you keep such keys hidden, for example, as environment variables set on a server. Thus, we are going to create a small server to act as a proxy between the client (a web browser, app or cURL) and the API in question: the Google Maps Geocoding API.</p><h2 id="why-paperplane-as-a-node-js-server-framework-">Why Paperplane as a Node.js Server Framework?</h2><p>It is possible to do everything you need with Node&#39;s <code>http</code> package, but I like the approach <a href="https://github.com/articulate/paperplane">paperplane</a> takes with viewing the request and response aspects of handling an HTTP request as a pure function where the request is the input and the response is what is returned from it:</p><pre><code class="lang-haskell"><span class="token constant">Request</span> <span class="token operator">-></span> <span class="token constant">Response</span>
</code></pre><p>whereas many Node frameworks&#39; handlers accept a function with the request and response as two arguments and not utilizing a return value, yielding the signature:</p><pre><code class="lang-haskell"><span class="token punctuation">(</span><span class="token constant">IncomingMessage</span><span class="token punctuation">,</span> <span class="token constant">ServerResponse</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><p>The paperplane approach makes a good deal more sense to me. You can read more about the &quot;why&quot; on <a href="https://github.com/articulate/paperplane/blob/master/docs/getting-started.md">paperplane&#39;s getting started guide</a>.</p><h2 id="project-source-code">Project Source Code</h2><p>The project we&#39;ll be making can be seen in its entirety here: <a href="https://github.com/rpearce/geocoding-proxy/">https://github.com/rpearce/geocoding-proxy/</a>.</p><h2 id="pre-requisites">Pre-requisites</h2><p><em>Note: what we&#39;ll be making is by no means a production-level application, as that would be outside the scope of this post. However, there are some slightly advanced tangential topics that I will be glossing over (sometimes providing links to) in order to not write a book. Send me an email if I can be clearer in certain areas.</em></p><p>This tutorial assumes that you already have installed Node.js (I use <a href="https://github.com/creationix/nvm">NVM</a> for managing Node versions and am using <code>v8.1</code>) and optionally the <a href="https://yarnpkg.com/lang/en/docs/install/">yarn package manager</a>.</p><p>Once you&#39;ve got Node and yarn installed, we can begin.</p><h2 id="project-setup">Project Setup</h2><p>From your favorite project folder, let&#39;s create a new project folder named <code>geocoding-proxy</code> and change the current working directory to be the new folder:</p><pre><code>λ mkdir geocoding-proxy
λ cd geocoding-proxy
</code></pre><h3 id="installing-dependencies">Installing Dependencies</h3><p>Once we&#39;re in the project folder, let&#39;s initialize a <code>package.json</code> file to make it easy to manage and hang on to our project&#39;s dependencies:</p><pre><code>λ npm init -Y
</code></pre><p>or if you have yarn installed:</p><pre><code>λ yarn init
</code></pre><p>You should now have a <code>package.json</code> file with some JSON values in it.</p><p>Next, let&#39;s install the tools that we&#39;re going to use:</p><pre><code>λ npm install --save axios dotenv paperplane ramda
</code></pre><p>or</p><pre><code>λ yarn add axios dotenv paperplane ramda
</code></pre><h3 id="get-a-google-maps-geocoding-api-key">Get A Google Maps Geocoding API Key</h3><p>You can get yourself an API key from <a href="https://developers.google.com/maps/documentation/geocoding/get-api-key">this page</a>. Once you&#39;ve done this, you&#39;ll need to copy the <code>.env.example</code> file at your project&#39;s root (<code>λ cp .env.example .env</code>) and replace the value of the <code>GEO_KEY</code> with your API key. Your <code>.env</code> file should look like</p><pre><code>GEO_KEY=abcdefg-hijklmn-op
PORT=5050
</code></pre><h2 id="hello-world-with-paperplane">Hello, World! With Paperplane</h2><p>Once your dependencies are installed, let&#39;s create a server to see if we can get things working. First, create <code>index.js</code> at your project&#39;s root and open it in your favorite text editor.</p><pre><code>λ touch index.js
</code></pre><p>Next, let&#39;s import the packages we&#39;ll be using and create a basic &quot;Hello, World!&quot; server:</p><pre><code class="lang-js"><span class="token comment" spellcheck="true">// Make our .env configuration file available</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'dotenv'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token comment" spellcheck="true">// Import libraries</span>
<span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> compose <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'ramda'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> json<span class="token punctuation">,</span> logger<span class="token punctuation">,</span> methods<span class="token punctuation">,</span> mount<span class="token punctuation">,</span> parseJson<span class="token punctuation">,</span> routes <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'paperplane'</span><span class="token punctuation">)</span>


<span class="token comment" spellcheck="true">// Application-specific code</span>
<span class="token keyword">const</span> endpoints <span class="token operator">=</span> <span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token string">'/'</span><span class="token punctuation">:</span> <span class="token function">methods</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    GET<span class="token punctuation">:</span> req <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">(</span>
      Promise
        <span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'hello world'</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span>endpoints<span class="token punctuation">,</span> parseJson<span class="token punctuation">)</span>


<span class="token comment" spellcheck="true">// Server options</span>
<span class="token keyword">const</span> opts <span class="token operator">=</span> <span class="token punctuation">{</span> errLogger<span class="token punctuation">:</span> logger<span class="token punctuation">,</span> logger <span class="token punctuation">}</span>
<span class="token keyword">const</span> port <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>PORT <span class="token operator">||</span> <span class="token number">3000</span>
<span class="token keyword">const</span> listening <span class="token operator">=</span> err <span class="token operator">=</span><span class="token operator">></span> err <span class="token operator">?</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">:</span> console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Listening on port: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span>


<span class="token comment" spellcheck="true">// Start the server</span>
http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token function">mount</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> opts<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> listening<span class="token punctuation">)</span>
</code></pre><p><em>(Read up more on how paperplane works on its <a href="https://github.com/articulate/paperplane/blob/master/docs/getting-started.md">getting started page</a> or by taking a look at <a href="https://github.com/articulate/paperplane/blob/master/demo/index.js">the demo application</a>. Also check out <a href="http://ramdajs.com/docs/#compose">Ramda&#39;s compose function</a> to learn about effective function composition.)</em></p><p>We can start the server in a terminal window by running</p><pre><code>λ node index.js
Listening on port: 5050
</code></pre><p>From another terminal window, let&#39;s use cURL to see if this works:</p><pre><code>λ curl localhost:5050
&quot;hello world&quot;
</code></pre><p>It works!</p><h2 id="hello-location">Hello, Location</h2><p>Now that we know our server works, let&#39;s see if we can get it to echo back a location/address parameter we send it at a route we&#39;ll create called <code>/geocode</code>. Let&#39;s remove our <code>&#39;/&#39;</code> endpoint and &quot;hello, world!&quot; code and add some for geocoding:</p><pre><code class="lang-js"><span class="token keyword">const</span> endpoints <span class="token operator">=</span> <span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token string">'/geocode/:address'</span><span class="token punctuation">:</span> <span class="token function">methods</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    GET<span class="token punctuation">:</span> req <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">(</span>
      Promise
        <span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>address<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><p>The <code>req</code> object gives us a <code>params</code> object with the key <code>address</code>, since that was what we specified we&#39;d like our parameter to be named by setting the <code>/geocode/:address</code> key in the <code>routes</code> function argument.</p><p>With the new endpoint added, save the file, restart your server (stop it with <code>Ctrl + C</code>), and run cURL with a city name this time:</p><pre><code>λ curl localhost:5050/geocode/Auckland
&quot;Auckland&quot;
</code></pre><h2 id="sending-to-the-geocoding-api">Sending to the Geocoding API</h2><p>We&#39;re almost there! Instead of echoing back whatever address the server receives, let&#39;s instead make an HTTP GET request to the geocode API using the <code>axios</code> package:</p><pre><code class="lang-js"><span class="token keyword">const</span> endpoints <span class="token operator">=</span> <span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token string">'/geocode/:address'</span><span class="token punctuation">:</span> <span class="token function">methods</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    GET<span class="token punctuation">:</span> req <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">(</span>
      <span class="token function">axios</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        method<span class="token punctuation">:</span> <span class="token string">'GET'</span><span class="token punctuation">,</span>
        url<span class="token punctuation">:</span> <span class="token string">'https://maps.googleapis.com/maps/api/geocode/json'</span><span class="token punctuation">,</span>
        params<span class="token punctuation">:</span> <span class="token punctuation">{</span>
          key<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>GEO_KEY<span class="token punctuation">,</span>
          address<span class="token punctuation">:</span> req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>address
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><p>In this code, we are using the JavaScript Promise-based axios tool to create a GET request to the geocode API. Take note of our <code>params</code> object here; since we&#39;re using the <code>dotenv</code> package and configuring that above, we get access to the <code>GEO_KEY</code> value in our <code>.env</code> file, and we separately get to pass on the <code>address</code> param, as well. When this request is sent, the <code>url</code> will look like:</p><pre><code>https://maps.googleapis.com/maps/api/geocode/json?key=abcdefg&amp;address=Auckland
</code></pre><p>After restarting your server, run <code>λ curl localhost:5050/geocode/Auckland</code> again.</p><pre><code>λ curl localhost:5050/geocode/Auckland
{&quot;message&quot;:&quot;Converting circular structure to JSON&quot;,&quot;name&quot;:&quot;TypeError&quot;}
</code></pre><p>Uh oh! If we log the axios result, we&#39;ll see a big response object that we don&#39;t care too much about right now. The only key we want right now from this big response is the <code>data</code> key, so we can use <a href="http://ramdajs.com/docs/#prop">Ramda&#39;s prop method</a> to simply access this object key and pass its return value down the chain:</p><pre><code class="lang-js"><span class="token comment" spellcheck="true">// add `prop` to the require statement</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> compose<span class="token punctuation">,</span> prop <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'ramda'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// ...</span>

<span class="token keyword">const</span> endpoints <span class="token operator">=</span> <span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token string">'/geocode/:address'</span><span class="token punctuation">:</span> <span class="token function">methods</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    GET<span class="token punctuation">:</span> req <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">(</span>
      <span class="token function">axios</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        method<span class="token punctuation">:</span> <span class="token string">'GET'</span><span class="token punctuation">,</span>
        url<span class="token punctuation">:</span> <span class="token string">'https://maps.googleapis.com/maps/api/geocode/json'</span><span class="token punctuation">,</span>
        params<span class="token punctuation">:</span> <span class="token punctuation">{</span>
          key<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>GEO_KEY<span class="token punctuation">,</span>
          address<span class="token punctuation">:</span> req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>address
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token function">prop</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><p>If all the stars have aligned and you restart and rerun the command again, you should see</p><pre><code class="lang-js">λ curl localhost<span class="token punctuation">:</span><span class="token number">5050</span><span class="token operator">/</span>geocode<span class="token operator">/</span>Auckland
<span class="token punctuation">{</span><span class="token string">"results"</span><span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">"address_components"</span><span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">"long_name"</span><span class="token punctuation">:</span><span class="token string">"Auckland"</span><span class="token punctuation">,</span><span class="token string">"short_name"</span><span class="token punctuation">:</span><span class="token string">"Auckland"</span><span class="token punctuation">,</span><span class="token string">"types"</span><span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">"locality"</span><span class="token punctuation">,</span><span class="token string">"political"</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token string">"long_name"</span><span class="token punctuation">:</span><span class="token string">"Auckland"</span><span class="token punctuation">,</span><span class="token string">"short_name"</span><span class="token punctuation">:</span><span class="token string">"Auckland"</span><span class="token punctuation">,</span><span class="token string">"types"</span><span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">"administrative_area_level_1"</span><span class="token punctuation">,</span><span class="token string">"political"</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span><span class="token string">"long_name"</span><span class="token punctuation">:</span><span class="token string">"New Zealand"</span><span class="token punctuation">,</span><span class="token string">"short_name"</span><span class="token punctuation">:</span><span class="token string">"NZ"</span><span class="token punctuation">,</span><span class="token string">"types"</span><span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">"country"</span><span class="token punctuation">,</span><span class="token string">"political"</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">"formatted_address"</span><span class="token punctuation">:</span><span class="token string">"Auckland, New Zealand"</span><span class="token punctuation">,</span><span class="token string">"geometry"</span><span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token string">"bounds"</span><span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token string">"northeast"</span><span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token string">"lat"</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">36.660571</span><span class="token punctuation">,</span><span class="token string">"lng"</span><span class="token punctuation">:</span><span class="token number">175.2871371</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">"southwest"</span><span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token string">"lat"</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">37.0654751</span><span class="token punctuation">,</span><span class="token string">"lng"</span><span class="token punctuation">:</span><span class="token number">174.4438016</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">"location"</span><span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token string">"lat"</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">36.8484597</span><span class="token punctuation">,</span><span class="token string">"lng"</span><span class="token punctuation">:</span><span class="token number">174.7633315</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">"location_type"</span><span class="token punctuation">:</span><span class="token string">"APPROXIMATE"</span><span class="token punctuation">,</span><span class="token string">"viewport"</span><span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token string">"northeast"</span><span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token string">"lat"</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">36.660571</span><span class="token punctuation">,</span><span class="token string">"lng"</span><span class="token punctuation">:</span><span class="token number">175.2871371</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">"southwest"</span><span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token string">"lat"</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">37.0654751</span><span class="token punctuation">,</span><span class="token string">"lng"</span><span class="token punctuation">:</span><span class="token number">174.4438016</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">"place_id"</span><span class="token punctuation">:</span><span class="token string">"ChIJ--acWvtHDW0RF5miQ2HvAAU"</span><span class="token punctuation">,</span><span class="token string">"types"</span><span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token string">"locality"</span><span class="token punctuation">,</span><span class="token string">"political"</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">"status"</span><span class="token punctuation">:</span><span class="token string">"OK"</span><span class="token punctuation">}</span>
</code></pre><p>Hooray! We now have geocode response data for Auckland like:</p><ul><li><code>&quot;status&quot;:&quot;OK&quot;</code></li><li><code>&quot;formatted_address&quot;:&quot;Auckland, New Zealand&quot;</code></li><li><code>&quot;location&quot;:{&quot;lat&quot;:-36.8484597,&quot;lng&quot;:174.7633315}</code></li></ul><h2 id="refactoring-the-routes">Refactoring the Routes</h2><p>As you might imagine, having all of the request handling functions inside of paperplane&#39;s <code>routes</code> function might get difficult to follow and modularize. With that in mind, let&#39;s first pull the handler function out and into its own function:</p><pre><code class="lang-js"><span class="token keyword">const</span> geocode <span class="token operator">=</span> req <span class="token operator">=</span><span class="token operator">></span>
  <span class="token function">axios</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    method<span class="token punctuation">:</span> <span class="token string">'GET'</span><span class="token punctuation">,</span>
    url<span class="token punctuation">:</span> <span class="token string">'https://maps.googleapis.com/maps/api/geocode/json'</span><span class="token punctuation">,</span>
    params<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      key<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>GEO_KEY<span class="token punctuation">,</span>
      address<span class="token punctuation">:</span> req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>address
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token function">prop</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span>

<span class="token keyword">const</span> endpoints <span class="token operator">=</span> <span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token string">'/geocode/:address'</span><span class="token punctuation">:</span> <span class="token function">methods</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    GET<span class="token punctuation">:</span> geocode
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><p>You could now abstract the <code>geocode</code> function to another file if you wanted to, as well as the object that is passed to routes (think of a routes file that requires in the different handlers it needs).</p><h3 id="leveraging-ramda">Leveraging Ramda</h3><p>We can refactor the code above even further and make it a bit more functional and closer to being <a href="https://lucasmreis.github.io/blog/pointfree-javascript">&quot;point-free&quot;</a> by including a few Ramda helpers:</p><pre><code class="lang-js"><span class="token keyword">const</span> <span class="token punctuation">{</span> compose<span class="token punctuation">,</span> composeP<span class="token punctuation">,</span> curryN<span class="token punctuation">,</span> path<span class="token punctuation">,</span> prop <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'ramda'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// ...</span>

<span class="token comment" spellcheck="true">// Application-specific code</span>
<span class="token keyword">const</span> getGeocode <span class="token operator">=</span> <span class="token function">curryN</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>key<span class="token punctuation">,</span> address<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span>
  <span class="token function">axios</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    method<span class="token punctuation">:</span> <span class="token string">'GET'</span><span class="token punctuation">,</span>
    url<span class="token punctuation">:</span> <span class="token string">'https://maps.googleapis.com/maps/api/geocode/json'</span><span class="token punctuation">,</span>
    params<span class="token punctuation">:</span> <span class="token punctuation">{</span> key<span class="token punctuation">,</span> address <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token function">prop</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> geocode <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span>
  <span class="token function">composeP</span><span class="token punctuation">(</span>
    json<span class="token punctuation">,</span>
    <span class="token function">getGeocode</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>GEO_KEY<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">path</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'params'</span><span class="token punctuation">,</span> <span class="token string">'address'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token keyword">const</span> endpoints <span class="token operator">=</span> <span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token string">'/geocode/:address'</span><span class="token punctuation">:</span> <span class="token function">methods</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    GET<span class="token punctuation">:</span> geocode
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span>endpoints<span class="token punctuation">,</span> parseJson<span class="token punctuation">)</span>
</code></pre><p>This code accomplishes the same goal as before, but now we have accomplished a few things:</p><ol><li>We no longer access <code>req.params.address</code> – what happens if any of those returned <code>null</code> or <code>undefined</code>? Instead, we use Ramda&#39;s <a href="http://ramdajs.com/docs/#path">path helper</a>.</li><li>Ramda&#39;s <a href="http://ramdajs.com/docs/#compose">compose</a> rears its head again, allowing us to make a chain of functions. However, note the use of <a href="http://ramdajs.com/docs/#composeP">composeP</a>. The <code>getGeocode</code> function returns a <code>Promise</code> thanks to <code>axios</code>, so we need to use <code>composeP</code> to compose our Promise-returning function.</li><li>We can use <a href="http://ramdajs.com/docs/#curryN">currying</a> to accept both <code>key</code> and <code>address</code> parameters at separate times. This is handy, for we could partially apply our <code>key</code> once, store that in a variable and reuse it over and over with different <code>address</code>es.</li><li>We have decoupled the use of paperplane&#39;s <code>json</code> helper from <code>getGeocode</code> and <code>axios</code>, meaning that function can now be leveraged in other ways instead of being hard-set to JSON.</li></ol><p>If this scares the hell out of you, fear not! Check out <a href="https://egghead.io/instructors/andrew-van-slaars">Andrew van Slaar&#39;s Ramda lessons on egghead.io</a> and if you&#39;re liking what you&#39;re seeing, <a href="https://github.com/MostlyAdequate/mostly-adequate-guide">Dr. Boolean&#39;s &quot;Mostly Adequate Guide to Functional Programming&quot;</a>.</p><h2 id="all-of-the-code">All of the Code</h2><p>The project itself can be found at <a href="https://github.com/rpearce/geocoding-proxy">https://github.com/rpearce/geocoding-proxy</a>, but here is our <code>index.js</code> file in its entirety:</p><pre><code class="lang-js"><span class="token comment" spellcheck="true">// Make our .env configuration file available</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'dotenv'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token comment" spellcheck="true">// Import libraries</span>
<span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> axios <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'axios'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> compose<span class="token punctuation">,</span> composeP<span class="token punctuation">,</span> curryN<span class="token punctuation">,</span> path<span class="token punctuation">,</span> prop <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'ramda'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> json<span class="token punctuation">,</span> logger<span class="token punctuation">,</span> methods<span class="token punctuation">,</span> mount<span class="token punctuation">,</span> parseJson<span class="token punctuation">,</span> routes <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'paperplane'</span><span class="token punctuation">)</span>


<span class="token comment" spellcheck="true">// Application-specific code</span>
<span class="token keyword">const</span> getGeocode <span class="token operator">=</span> <span class="token function">curryN</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>key<span class="token punctuation">,</span> address<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span>
  <span class="token function">axios</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    method<span class="token punctuation">:</span> <span class="token string">'GET'</span><span class="token punctuation">,</span>
    url<span class="token punctuation">:</span> <span class="token string">'https://maps.googleapis.com/maps/api/geocode/json'</span><span class="token punctuation">,</span>
    params<span class="token punctuation">:</span> <span class="token punctuation">{</span> key<span class="token punctuation">,</span> address <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token function">prop</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token keyword">const</span> geocode <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span>
  <span class="token function">composeP</span><span class="token punctuation">(</span>
    json<span class="token punctuation">,</span>
    <span class="token function">getGeocode</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>GEO_KEY<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token function">path</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'params'</span><span class="token punctuation">,</span> <span class="token string">'address'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token keyword">const</span> endpoints <span class="token operator">=</span> <span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token string">'/geocode/:address'</span><span class="token punctuation">:</span> <span class="token function">methods</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    GET<span class="token punctuation">:</span> geocode
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span>endpoints<span class="token punctuation">,</span> parseJson<span class="token punctuation">)</span>


<span class="token comment" spellcheck="true">// Server options</span>
<span class="token keyword">const</span> opts <span class="token operator">=</span> <span class="token punctuation">{</span> errLogger<span class="token punctuation">:</span> logger<span class="token punctuation">,</span> logger <span class="token punctuation">}</span>
<span class="token keyword">const</span> port <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>PORT <span class="token operator">||</span> <span class="token number">3000</span>
<span class="token keyword">const</span> listening <span class="token operator">=</span> err <span class="token operator">=</span><span class="token operator">></span> err <span class="token operator">?</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">:</span> console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Listening on port: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span>


<span class="token comment" spellcheck="true">// Start the server</span>
http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token function">mount</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> opts<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> listening<span class="token punctuation">)</span>
</code></pre><h2 id="conclusion">Conclusion</h2><p>Tools like Node.js with paperplane make it very easy to create proxy servers to handle your requests in a safe fashion, so use them and always keep your API keys secret!</p></div></article><section class="section--padded bg--gray"><div class="layout--constrained"><h2>Get Updates</h2><!-- Begin MailChimp Signup Form --><form action="//robertwpearce.us13.list-manage.com/subscribe/post?u=2df44e8960266388bff165fa6&amp;id=ee2f2a3737" method="post" name="mc-embedded-subscribe-form" target="_blank" novalidate class="form"><div id="mce-responses"><div class="response" id="mce-error-response" style="display:none"></div><div class="response" id="mce-success-response" style="display:none"></div></div><div style="position: absolute; left: -5000px" aria-hidden="true"><input type="text" name="b_2df44e8960266388bff165fa6_ee2f2a3737" tabindex="-1" value=""></div><div class="form__container"><label for="mce-EMAIL" class="form__label">Email Address</label><input type="email" value="" id="mce-EMAIL" class="form__input" name="EMAIL" placeholder="you@greatemail.com"> <input type="submit" value="Subscribe" name="subscribe" class="form__submit"></div><small>Note: I will <em>never</em> give out your email nor spam you. Unsubscribe at any time.</small></form><!--End mc_embed_signup--></div></section></main></body></html>